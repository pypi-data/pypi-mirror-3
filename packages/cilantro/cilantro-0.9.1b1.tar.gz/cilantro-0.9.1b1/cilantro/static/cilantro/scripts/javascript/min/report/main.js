var Base=function(){};Base.extend=function(a,b){var c=Base.prototype.extend;Base._prototyping=!0;var d=new this;c.call(d,a),d.base=function(){},delete Base._prototyping;var e=d.constructor,f=d.constructor=function(){if(!Base._prototyping)if(this._constructing||this.constructor==f)this._constructing=!0,e.apply(this,arguments),delete this._constructing;else if(arguments[0]!=null)return(arguments[0].extend||c).call(arguments[0],d)};return f.ancestor=this,f.extend=this.extend,f.forEach=this.forEach,f.implement=this.implement,f.prototype=d,f.toString=this.toString,f.valueOf=function(a){return a=="object"?f:e.valueOf()},c.call(f,b),typeof f.init=="function"&&f.init(),f},Base.prototype={extend:function(a,b){if(arguments.length>1){var c=this[a];if(c&&typeof b=="function"&&(!c.valueOf||c.valueOf()!=b.valueOf())&&/\bbase\b/.test(b)){var d=b.valueOf();b=function(){var a=this.base||Base.prototype.base;this.base=c;var b=d.apply(this,arguments);return this.base=a,b},b.valueOf=function(a){return a=="object"?b:d},b.toString=Base.toString}this[a]=b}else if(a){var e=Base.prototype.extend;!Base._prototyping&&typeof this!="function"&&(e=this.extend||e);var f={toSource:null},g=["constructor","toString","valueOf"],h=Base._prototyping?0:1;while(i=g[h++])a[i]!=f[i]&&e.call(this,i,a[i]);for(var i in a)f[i]||e.call(this,i,a[i])}return this}},Base=Base.extend({constructor:function(){this.extend(arguments[0])}},{ancestor:Object,version:"1.1",forEach:function(a,b,c){for(var d in a)this.prototype[d]===undefined&&b.call(c,a[d],d,a)},implement:function(){for(var a=0;a<arguments.length;a++)typeof arguments[a]=="function"?arguments[a](this.prototype):this.prototype.extend(arguments[a]);return this},toString:function(){return String(this.valueOf())}}),define("cilantro/vendor/base",function(){}),define("cilantro/rest/basext",["cilantro/vendor/base"],function(){var a=Base.extend({__defargslist:function(a,b){return a=a||this.constructor,b=b||[],a.ancestor&&(b=this.__defargslist(a.ancestor,b)),a.defargs&&typeof a.defargs=="object"&&b.push(a.defargs),b},_defargs:function(){var a=this.__defargslist();return $.extend.apply(this,[{}].concat(a))},constructor:function(a){var b=this._defargs(),c=$.extend({},b,a);for(var d in c)b.hasOwnProperty(d)&&(this[d]=c[d])}},{defargs:{}});return a}),define("cilantro/rest/datasource",["cilantro/rest/basext"],function(a){var b=a.extend({}),c=b.extend({_cache:undefined,get:function(a,b){b=b||!1,a=a||{};if(!b&&this._cache)return this._cache;var c=this,d=$.extend({},this.ajax,a),e=d.success;return d.success=function(a){var b=c.decode(a);c._cache=b,e(a,b)},this.xhr=$.ajax(d),this._cache}},{defargs:{ajax:{url:window.location,data:{},success:function(){},error:function(){},cache:!1},decode:function(a){return a}}});return{ajax:c}}),define("cilantro/rest/renderer",["cilantro/rest/basext"],function(a){var b=a.extend({},{defargs:{target:null}}),c=b.extend({render:function(a,b){b=b?b:this.replace,b===!0&&this.target.html("");if(this.bindData===!0){l=[];for(var c,d,e=0;e<a.length;e++)c=a[e],d=$.jqoteobj(this.template,c),d.data(c),l.push(d)}else l=[$.jqoteobj(this.template,a)];var f=this.target;return b==="prepend"?$.each(l.reverse(),function(){f.prepend(this)}):$.each(l,function(){f.append(this)}),this.target}},{defargs:{template:null,replace:!0,bindData:!1}});return{base:b,template:c}}),define("cilantro/report/templates",["jquery"],function(a){return{columns:a.jqotec(['<div data-model="category" data-id="<%= this.id %>">','<h4><%= this.name %> <a class="ht add-all" href="#<%= this.id %>">Add All</a></h4>',"<ul>","<% for (var e,k=0; k<this.columns.length; k++) { %>","<% e = this.columns[k]; %>",'<li class="active" data-model="column" data-id="<%= e.id %>">','<a class="fr ht add-column" href="#<%= e.id %>">Add</a>',"<%= e.name %>",'<% if (e.description) { %><p class="ht mg"><%= e.description %></p><% } %>',"</li>","<% } %>","</ul>","</div>"].join("")),active_columns:a.jqotec(['<li data-model="column" data-id="<%= this.id %>">','<a class="fr ht remove-column" href="#<%= this.id %>">Remove</a>',"<%= this.name %>",'<% if (this.description) { %><p class="ht mg"><%= this.description %></p><% } %>',"</li>"].join("")),header:a.jqotec('<th data-model="column" data-id="<%= this.id %>" class="header <%= this.direction %>"><span><%= this.name %></span></th>'),row:a.jqotec(["<tr>","<% for(var k=1; k<this.length; k++) { %>","<td><%= this[k] %></td>","<% } %>","</tr>"].join("")),pages:a.jqotec(["<% if (this.page > 1) { %>",'<span>&laquo; <a href="#1">First</a></span>',"<% if (this.page > 2) { %>",'<span>&lsaquo; <a href="#<%= this.page-1 %>">Previous</a></span>',"<% } %>","<% } %>","<% for (var e,k=0; k<this.pages.length;k++) { %>","<% e = this.pages[k]; %>","<% if (this.page == e) { %>","<strong><%= e %></strong>","<% } else { %>","<% if (e) { %>",'<a href="#<%= e %>"><%= e %></a>',"<% } else { %>","<span>...</span>","<% } %>","<% } %>","<% } %>","<% if (this.page < this.num_pages) { %>","<% if (this.page < this.num_pages - 1) { %>",'<span><a href="#<%= this.page+1 %>">Next</a> &rsaquo;</span>',"<% } %>",'<span><a href="#<%= this.num_pages %>">Last</a> &raquo;</span>',"<% } %>"].join(""))}}),define("cilantro/report/table",["jquery","cilantro/rest/datasource","cilantro/rest/renderer","cilantro/report/templates"],function(a,b,c,d){function e(){var e=!0,f=a("body"),g=a("#content"),h=a("#report"),i=a("#report-info"),j=a("#actions"),k=a("#details"),l=h.find(".toolbar"),m=a("#table"),n=m.find("thead tr"),o=m.find("tbody"),p=a(".per-page"),q=a(".page-links"),r=a("#report-unique"),s=a("#report-count"),t=a("#no-results"),u={table_header:new c.template({target:n,template:d.header}),table_rows:new c.template({target:o,template:d.row}),pages:new c.template({target:q,template:d.pages})},v={scope_info:new b.ajax({ajax:{url:App.endpoints.session.scope,success:function(a){if(a.conditions){var b="";if(typeof a.conditions=="string")b="<li>"+a.text+"</li>";else{var c=a.conditions;for(var d=0;d<c.length;d++)b+="<li>"+c[d].condition+"</li>"}k.html(b)}}}}),table_header:new b.ajax({ajax:{url:App.endpoints.session.perspective,success:function(a){u.table_header.render(a.header)}}}),table_rows:new b.ajax({ajax:{url:App.endpoints.session.report,data:{data:1},beforeSend:function(){h.block()},complete:function(){h.unblock()},success:function(a){a.unique!==null&&(a.unique.toString()!==r.text()&&r.parent().effect("highlight",1e3),r.text(a.unique)),a.count!==null&&(a.count.toString()!==s.text()&&s.parent().effect("highlight",1e3),s.text(a.count));if(a.count===0){m.hide(),l.hide(),t.show(),j.hide();return}t.hide(),m.show(),j.show(),l.show(),u.table_rows.render(a.rows),a.pages?(u.pages.render(a.pages),u.pages.target.show()):u.pages.target.hide(),a.per_page&&p.val(a.per_page),h.trigger("resize-report")}}})};v.scope_info.get(),v.table_header.get(),v.table_rows.get(),h.bind("resize-report",function(b){var c=900,d=h.innerWidth(),e=m.outerWidth(!0)+4,f=Math.min(e,a(window).width()-30);f=Math.max(c,f);if(f==d)return;g.animate({width:f}),h.animate({width:f})});var w;a(window).resize(function(){clearTimeout(w),w=setTimeout(function(){h.trigger("resize-report")},200)}),f.bind("update.report",function(a,b){b&&(b.data=1);var c={data:b};return v.table_rows.get(c,!0),!1}),f.bind("update.perspective",function(b,c){return c?(c={replace:c},a.patchJSON(App.endpoints.session.perspective,JSON.stringify(c),function(){f.trigger("update.report"),"columns"in c.replace&&v.table_header.get(null,!0)})):a.getJSON(App.endpoints.session.perspective,function(){f.trigger("update.report"),v.scope_info.get(null,!0),v.table_header.get(null,!0)}),!1}),h.delegate(".per-page","change",function(a){return this.value&&f.trigger("update.report",{size:this.value}),!1}),n.delegate(".header","click",function(b){var c,d=a(this),e=d.attr("data-id"),g=d.siblings();return g.removeClass("asc").removeClass("desc"),d.hasClass("asc")?(d.removeClass("asc").addClass("desc"),c="desc"):d.hasClass("desc")?(d.removeClass("desc"),c=""):(d.addClass("asc"),c="asc"),f.trigger("update.perspective",[{ordering:[[e,c]]}]),!1}),q.delegate("a","click",function(a){return f.trigger("update.report",{page:this.hash.substr(1)}),!1})}return{init:e}}),define("cilantro/report/columns",["jquery","cilantro/rest/datasource","cilantro/rest/renderer","cilantro/report/templates"],function(a,b,c,d){function e(){var c=a("body"),d=a("#columns"),e=a("#active-columns"),f=a("#columns-dialog"),g=a("#search"),h=a("form",f),i=a("#data-columns");f.cache={},f.get=function(a){if(!f.cache[a]){var b="[data-model=column][data-id="+a+"]";f.cache[a]={src:d.find(b),tgt:e.find(b)}}return f.cache[a]},f.bind("addall.column",function(b,c){var d=a("[data-model=category][data-id="+c+"]"),e=d.find(".active:not(.filtered)");d.hide();for(var g=0;g<e.length;g++)f.trigger("add.column",[a(e[g]).attr("data-id")]);return!1}),f.bind("add.column",function(a,b){map=f.get(b),map.src.removeClass("active");var c=map.src.siblings(".active:not(.filtered)");return c.length==0&&map.src.parents("[data-model=category]").hide(),e.append(map.tgt.detach().addClass("active")),!1}),f.bind("remove.column",function(a,b){return map=f.get(b),map.tgt.removeClass("active"),map.src.addClass("active").parents("[data-model=category]").show(),!1}),f.bind("removeall.column",function(a){for(var b in f.cache)f.trigger("remove.column",[b]);return!1}),f.bind("search.column",function(a,b){return g.trigger("search",b),!1}),f.bind("save.column",function(b){var d=e.children(".active"),f=a.map(d,function(b,c){return parseInt(a(b).attr("data-id"))});return c.trigger("update.perspective",[{columns:f}]),!1}),f.bind("filter.column",function(a,b){map=f.get(b),map.src.addClass("filtered");var c=map.src.siblings(".active:not(.filtered)");c.length==0&&map.src.parents("[data-model=category]").hide()}),f.bind("filterall.column",function(b){var c=d.find("[data-model=column]");for(var e=c.length;e--;)f.trigger("filter.column",[a(c[e]).attr("data-id")]);return!1}),f.bind("unfilter.column",function(a,b){return map=f.get(b),map.src.removeClass("filtered"),map.src.parents("[data-model=category]").show(),!1});var j={perspective:new b.ajax({ajax:{url:App.endpoints.session.perspective,success:function(a){if(a.store){f.trigger("removeall.column");var b=a.store.columns;for(var c=0;c<b.length;c++)f.trigger("add.column",[b[c]])}}}})};j.perspective.get(),App.hub.subscribe("report/revert",function(){j.perspective.get(null,!0),c.trigger("update.perspective")});var k=a('<div id="description"></div>').appendTo("body"),l=null;a("#columns").delegate("li","mouseenter",function(){clearTimeout(l);var b=this;l=setTimeout(function(){var c=a(b),d=c.offset(),e=c.outerWidth(),f=c.children(".description").html();k.html(f),k.css({left:d.left+e+20,top:d.top}).show()},700)}).delegate("li","mouseleave",function(){clearTimeout(l),k.hide()}),g.autocomplete2({success:function(a,b){g.trigger("filterall.column");for(var c=0;c<b.length;c++)g.trigger("unfilter.column",[b[c]])}},null,50),d.delegate(".add-column","click",function(a){clearTimeout(l),k.hide();var b=this.hash.substr(1);return f.trigger("add.column",[b]),!1}),d.delegate(".add-all","click",function(a){var b=this.hash.substr(1);return f.trigger("addall.column",[b]),!1}),e.delegate(".remove-column","click",function(a){var b=this.hash.substr(1);return f.trigger("remove.column",[b]),!1}),f.delegate(".remove-all","click",function(a){return f.trigger("removeall.column"),!1}),f.dialog({autoOpen:!1,draggable:!0,resizable:!1,title:"Add or Remove Columns from this Report",height:600,width:900,buttons:{Cancel:function(){f.dialog("close")},"Update Columns":function(){f.trigger("save.column"),f.dialog("close")}}}),e.sortable({placeholder:"placeholder",forcePlaceholderSize:!0,forceHelperSize:!0,opacity:.5,cursor:"move",tolerance:"intersect"}).disableSelection(),i.bind("click",function(a){f.dialog("open")})}return{init:e}}),define("cilantro/report/main",["jquery","cilantro/report/table","cilantro/report/columns"],function(a,b,c){a(function(){c.init(),b.init();var d=a("#export-data");d.bind("click",function(){return d.attr("disabled",!0),window.location=App.endpoints.session.report+"?f=csv",setTimeout(function(){d.attr("disabled",!1)},5e3),!1})})})