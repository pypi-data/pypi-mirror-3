

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>m4us.core.utils &mdash; Message For You Sir! 0.3.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Message For You Sir! 0.3.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Message For You Sir! 0.3.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for m4us.core.utils</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="c">#---Header---------------------------------------------------------------------</span>

<span class="c"># This file is part of Message For You Sir (m4us).</span>
<span class="c"># Copyright Â© 2009-2012 Krys Lawrence</span>
<span class="c">#</span>
<span class="c"># Message For You Sir is free software: you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c"># the Free Software Foundation, either version 3 of the License, or (at your</span>
<span class="c"># option) any later version.</span>
<span class="c">#</span>
<span class="c"># Message For You Sir is distributed in the hope that it will be useful, but</span>
<span class="c"># WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="c"># FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License</span>
<span class="c"># for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c"># along with Message For You Sir.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>


<span class="sd">&quot;&quot;&quot;Provides common utilities for the rest of the project.&quot;&quot;&quot;</span>


<span class="c">#---Imports--------------------------------------------------------------------</span>

<span class="c">#---  Standard library imports</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="c">## pylint: disable=W0622, W0611</span>
<span class="kn">from</span> <span class="nn">future_builtins</span> <span class="kn">import</span> <span class="n">ascii</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="nb">hex</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">oct</span><span class="p">,</span> <span class="nb">zip</span>  <span class="c">## NOQA</span>
<span class="c">## pylint: enable=W0622, W0611</span>

<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="c">#---  Third-party imports</span>
<span class="kn">import</span> <span class="nn">decorator</span>

<span class="c">#---  Project imports</span>
<span class="kn">from</span> <span class="nn">m4us.core</span> <span class="kn">import</span> <span class="n">interfaces</span>


<span class="c">#---Globals--------------------------------------------------------------------</span>

<span class="c">## pylint: disable=W0105</span>
<span class="n">_DEFAULT_NAME_EXCLUDES</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;filter&#39;</span><span class="p">,</span> <span class="s">&#39;map&#39;</span><span class="p">,</span> <span class="s">&#39;zip&#39;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;The default object names to always exclude from :func:`_is_private_object`.</span>

<span class="sd">This global is here so that other modules can use it as a base when needing to</span>
<span class="sd">include additional names.</span>

<span class="sd">It currently only includes the names of objects in the *future_builtins* module</span>
<span class="sd">that do not originate in that module (and so their *__module__* module</span>
<span class="sd">attribute is not set to ``future_builtins``.  E.g. ``&#39;filter&#39;``, ``&#39;map&#39;``,</span>
<span class="sd">etc.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c">## pylint: enable=W0105</span>


<span class="c">#---Functions------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">_is_private_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">object_</span><span class="p">,</span> <span class="n">excludes</span><span class="o">=</span><span class="n">_DEFAULT_NAME_EXCLUDES</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return :obj:`True` if the object is private.</span>

<span class="sd">    Private object means any object that would not be considered part of a</span>
<span class="sd">    public API.  Specifically, an object is considered private if:</span>

<span class="sd">      * Its name is in the excludes list, or</span>
<span class="sd">      * Its name starts with an underscore (&quot;_&quot;), or</span>
<span class="sd">      * It is a module, or</span>
<span class="sd">      * It is from the *__future__* or *future_builtins* modules.</span>

<span class="sd">    :param basestring object_name: The name of the object to check.</span>
<span class="sd">    :param object_: The object to check.</span>
<span class="sd">    :param collections.Sequence excludes: A sequence of object names to always</span>
<span class="sd">      consider as private. The default just includes the names from</span>
<span class="sd">      *future_builtins* that original elsewhere.</span>

<span class="sd">    :returns: :obj:`True` if the object is considered non-public, :obj:`False`</span>
<span class="sd">      otherwise.</span>
<span class="sd">    :rtype: :obj:`bool`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="n">object_name</span> <span class="ow">in</span> <span class="n">excludes</span> <span class="ow">or</span>
      <span class="n">object_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span>
      <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">)</span> <span class="ow">or</span>
      <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">object_</span><span class="p">,</span> <span class="s">&#39;__module__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">object_</span><span class="o">.</span><span class="n">__module__</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;__future__&#39;</span><span class="p">,</span>
        <span class="s">&#39;future_builtins&#39;</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">_public_object_names</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">excludes</span><span class="o">=</span><span class="n">_DEFAULT_NAME_EXCLUDES</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;`Generator` of public names in a namespace.</span>

<span class="sd">    Given a namespace (like the *__dict__* of a module, for example), this</span>
<span class="sd">    `generator` will yield the names of all public objects in the namespace.</span>

<span class="sd">    Public object is defined as whenever :func:`_is_private_object` returns</span>
<span class="sd">    :obj:`False`.</span>

<span class="sd">    Example usage:</span>

<span class="sd">    &gt;&gt;&gt; import somemodule</span>
<span class="sd">    &gt;&gt;&gt; for name in _public_object_names(vars(somemodule)):</span>
<span class="sd">    &gt;&gt;&gt;     print(name)</span>

<span class="sd">    :param collections.Mapping namespace: The namesapce in which to search for</span>
<span class="sd">      objects.</span>
<span class="sd">    :param collections.Sequence excludes: A sequence of object names to always</span>
<span class="sd">      exclude.</span>

<span class="sd">    :returns: An iterator of public object names from the given namespace.</span>
<span class="sd">    :rtype: :data:`types.GeneratorType`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">excludes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">excludes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">object_</span> <span class="ow">in</span> <span class="n">namespace</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">_is_private_object</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">object_</span><span class="p">,</span> <span class="n">excludes</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">yield</span> <span class="n">name</span>


<div class="viewcode-block" id="easy_link"><a class="viewcode-back" href="../../../api/core/m4us.core.utils.html#m4us.core.utils.easy_link">[docs]</a><span class="k">def</span> <span class="nf">easy_link</span><span class="p">(</span><span class="n">first_coroutine</span><span class="p">,</span> <span class="n">second_coroutine</span><span class="p">,</span> <span class="o">*</span><span class="n">other_coroutines</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return `links` connecting the `coroutines` in the standard way.</span>

<span class="sd">    The given `coroutines` are linked in a `pipeline` (not to be confused with</span>
<span class="sd">    a :class:`~m4us.core.containers.Pipeline`) of ``outbox`` to ``inbox`` and</span>
<span class="sd">    ``signal`` to ``control`` `mailboxes`.  The first `coroutine` will only</span>
<span class="sd">    have it&#39;s ``outbox`` and ``signal`` `mailboxes` linked and the last</span>
<span class="sd">    `coroutine` will only have it&#39;s ``inbox`` and ``control`` `mailboxes`</span>
<span class="sd">    linked.  `Coroutines` in the middle will be linked to the previous and next</span>
<span class="sd">    `coroutines` in order.</span>

<span class="sd">    The resulting `links` can then be passed to a `post office`.</span>

<span class="sd">    :param m4us.core.interfaces.ICoroutine first_coroutine: A minimum of two</span>
<span class="sd">      `coroutines` are required. This is the first one.</span>
<span class="sd">    :param m4us.core.interfaces.ICoroutine second_coroutine: The second</span>
<span class="sd">      `coroutine`.</span>
<span class="sd">    :param collections.Sequence other_coroutines: Any other `coroutines` to</span>
<span class="sd">      `link` after the second one.</span>

<span class="sd">    :returns: A set of `mailbox` `links` to be given to a `post office`.</span>
<span class="sd">    :rtype: :class:`set`</span>

<span class="sd">    .. note::</span>

<span class="sd">      Normally one would just use the :class:`~m4us.core.containers.Pipeline`</span>
<span class="sd">      class, but this provides just the `links`, which could be useful to other</span>
<span class="sd">      `container` classes.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">      The :class:`~m4us.core.interfaces.IPostOffice` `interface` for more</span>
<span class="sd">      information on `links`, `mailboxes` and `post offices`.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">      The :class:`~m4us.core.containers.Pipeline` class for the normal way to</span>
<span class="sd">      construct `coroutine` `pipelines`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_coroutine</span><span class="p">,</span> <span class="n">second_coroutine</span><span class="p">)</span> <span class="o">+</span> <span class="n">other_coroutines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sinks</span> <span class="o">=</span> <span class="p">(</span><span class="n">second_coroutine</span><span class="p">,)</span> <span class="o">+</span> <span class="n">other_coroutines</span>
    <span class="n">links</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">sinks</span><span class="p">):</span>
        <span class="n">links</span><span class="o">.</span><span class="n">update</span><span class="p">((</span>
          <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">&#39;outbox&#39;</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="s">&#39;inbox&#39;</span><span class="p">),</span>
          <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">&#39;signal&#39;</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="s">&#39;control&#39;</span><span class="p">),</span>
        <span class="p">))</span>
    <span class="k">return</span> <span class="n">links</span>

</div>
<div class="viewcode-block" id="is_shutdown"><a class="viewcode-back" href="../../../api/core/m4us.core.utils.html#m4us.core.utils.is_shutdown">[docs]</a><span class="k">def</span> <span class="nf">is_shutdown</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">expected_inbox</span><span class="o">=</span><span class="s">&#39;control&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return :obj:`True` if the given `message` signals a shutdown.</span>

<span class="sd">    `Coroutines` are expected to shutdown when they receive a shutdown</span>
<span class="sd">    `message`.  This is a convenience function that returns :obj:`True` if</span>
<span class="sd">    `inbox` is ``control`` (by default) and the `message` object provides or is</span>
<span class="sd">    adaptable to :class:`~m4us.core.interfaces.IShutdown`.</span>

<span class="sd">    :param unicode inbox: The `inbox` in which with `message` was received.</span>
<span class="sd">    :param message: The `message` object that was received.</span>
<span class="sd">    :param unicode expected_inbox: The `inbox` in which</span>
<span class="sd">      :class:`~m4us.core.interfaces.IShutdown` `messages` are expected.  This</span>
<span class="sd">      parameter lets the default be overridden.</span>

<span class="sd">    :returns: :obj:`True` if the `message` signals that the `coroutine` should</span>
<span class="sd">      shutdown, :obj:`False` otherwise.</span>
<span class="sd">    :rtype: :obj:`bool`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">inbox</span> <span class="o">==</span> <span class="n">expected_inbox</span> <span class="ow">and</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">IShutdown</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">_strip_first_parameter</span><span class="p">(</span><span class="n">function_maker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Strip the first parameter from a function signature.</span>

<span class="sd">    This function ajusts a :class:`!decorator.FunctionMaker` instance, removing</span>
<span class="sd">    the first parameter, along with it&#39;s default value if it has one.  It</span>
<span class="sd">    does not remove any :samp:`*{args}` or :samp:`**{kwargs}` parameters,</span>
<span class="sd">    however, even if they are the first parameter.  If there are no positional</span>
<span class="sd">    parameters, no adjustments are made.</span>

<span class="sd">    This function is meant to make constructing certain signature-altering</span>
<span class="sd">    decorators easier to build.</span>

<span class="sd">    :parameter function_maker: The :class:`!decorator.FunctionMaker` instance</span>
<span class="sd">      to alter.</span>
<span class="sd">    :type function_maker: :class:`!decorator.FunctionMaker`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">function_maker</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">function_maker</span><span class="o">.</span><span class="n">varargs</span><span class="p">:</span>
        <span class="c"># E.g. def func():</span>
        <span class="c"># E.g. def func(**kwargs):</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">function_maker</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">function_maker</span><span class="o">.</span><span class="n">varargs</span> <span class="ow">and</span> <span class="ow">not</span> \
      <span class="n">function_maker</span><span class="o">.</span><span class="n">varkw</span><span class="p">:</span>
        <span class="c"># E.g. def func(first):</span>
        <span class="n">function_maker</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">function_maker</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">function_maker</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="n">function_maker</span><span class="o">.</span><span class="n">varargs</span><span class="p">:</span>
        <span class="c"># E.g. def func(*args):</span>
        <span class="c"># Leave signature untouched.</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># E.g. def func(first, second):</span>
        <span class="c"># E.g. def func(first, *args):</span>
        <span class="c"># E.g. def func(first, **kwargs):</span>
        <span class="c"># Remove first argument.</span>
        <span class="n">function_maker</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">function_maker</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">function_maker</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">function_maker</span><span class="o">.</span><span class="n">defaults</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">function_maker</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span>
      <span class="n">function_maker</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
        <span class="c"># E.g. def func(first=&#39;default&#39;):</span>
        <span class="c"># E.g. def func(first=&#39;default&#39;, other=&#39;other default&#39;):</span>
        <span class="n">function_maker</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="n">function_maker</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">function_maker</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span>
            <span class="n">function_maker</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">_function_wrapper_from_template</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span>
  <span class="n">strip_first_parameter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct and return a wrapper function from a template string.</span>

<span class="sd">    This function can create a function wrapper from a template, preserving the</span>
<span class="sd">    signature of the original function, if desired.  It&#39;s main purpose is to</span>
<span class="sd">    be used in decorators to create function wrappers with preserved or</span>
<span class="sd">    modified signatures, names and doctstrings.</span>

<span class="sd">    The template is typically in the form of::</span>

<span class="sd">      def %(name)s(%(signature)s):</span>
<span class="sd">          # Do something</span>
<span class="sd">          return _func_(%(signature)s)</span>
<span class="sd">          # Do something else</span>

<span class="sd">    where ``%(name)s`` is replaced the with name of the given function,</span>
<span class="sd">    ``%(signature)s`` is replaced with the function&#39;s signature and ``_func_``</span>
<span class="sd">    is a reference to the given function.  These variables are not required,</span>
<span class="sd">    however.</span>

<span class="sd">    If *strip_first_parameter* is :obj:`True`, then ``%(signature)s`` is</span>
<span class="sd">    modified to remove the first parameter (excluding :samp:`*{args}` and</span>
<span class="sd">    :samp:`**{kwargs}`).  This is useful if the wrapper will pass in the first</span>
<span class="sd">    argument, but the rest of the given function&#39;s signature should be passed</span>
<span class="sd">    in through the wrapper.</span>

<span class="sd">    Also, any additional keyword arguments that are passed to this function</span>
<span class="sd">    will become global variables in the wrapper&#39;s namespace.  This is useful</span>
<span class="sd">    for passing in additional dependencies to the wrapper function.</span>

<span class="sd">    :parameter types.FunctionType function: The function to wrap and on which</span>
<span class="sd">      to base the wrapper&#39;s signature, name and docstring.</span>
<span class="sd">    :parameter basestring template: The template for the wrapper function.</span>
<span class="sd">    :parameter bool strip_first_parameter: If :obj:`True`, the first parameter</span>
<span class="sd">      of the given function&#39;s signature will be stripped off of the</span>
<span class="sd">      ``%(signature)s`` variable used in the template.  Default is</span>
<span class="sd">      :obj:`False`.</span>

<span class="sd">    :returns: A wrapper function created from the given template.</span>
<span class="sd">    :rtype: :data:`types.FunctionType`</span>

<span class="sd">    :raises exceptions.TypeError: If the first argument is not a function.</span>
<span class="sd">    :raises exceptions.ValueError: If *strip_first_parameter* is :obj:`True`</span>
<span class="sd">      and the given function does not accept at least one parameter.</span>
<span class="sd">    :raises SyntaxError: If the template is not valid.</span>

<span class="sd">    :see also: :class:`!decorator.FunctionMaker` for additional details on</span>
<span class="sd">      templates and available variables.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Note: All this messing around with FunctionMaker is in order to preserve</span>
    <span class="c"># the function signature in the filter coroutine factory function, possibly</span>
    <span class="c"># minus the first positional argument, which is the inbox message delivered</span>
    <span class="c"># to the coroutine.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
        <span class="c"># No support for being a class decorator yet.</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;First argument must be a function.&#39;</span><span class="p">)</span>
    <span class="n">wrapper_maker</span> <span class="o">=</span> <span class="n">decorator</span><span class="o">.</span><span class="n">FunctionMaker</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">strip_first_parameter</span><span class="p">:</span>
        <span class="c">## pylint: disable=E1101</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wrapper_maker</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">wrapper_maker</span><span class="o">.</span><span class="n">varargs</span><span class="p">:</span>
            <span class="c">## pylint: enable=E1101</span>
            <span class="c"># E.g. def func():</span>
            <span class="c"># E.g. def func(**kwargs):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Function must accept at least one positional &#39;</span>
              <span class="s">&#39;argument if strip_first_parameter=True.&#39;</span><span class="p">)</span>
        <span class="n">_strip_first_parameter</span><span class="p">(</span><span class="n">wrapper_maker</span><span class="p">)</span>
    <span class="n">eval_dictionary</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">__globals__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">eval_dictionary</span><span class="p">[</span><span class="s">&#39;_func_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span>
    <span class="n">eval_dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">wrapper</span> <span class="o">=</span> <span class="n">wrapper_maker</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">eval_dictionary</span><span class="p">,</span>
      <span class="n">undecorated</span><span class="o">=</span><span class="n">function</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="c">#---Classes--------------------------------------------------------------------</span>

<span class="c">## pylint: disable=R0903</span>
<span class="k">class</span> <span class="nc">_ObjectStandIn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Instances of this class are stand-ins for other objects.</span>

<span class="sd">    This class is used by the :class:`_ObjectStandInRegistry`. Stand-ins can be</span>
<span class="sd">    used, for example, to hold attributes when for other objects that cannot</span>
<span class="sd">    (i.e. :data:`types.GeneratorType`) or in any other situation where using</span>
<span class="sd">    the original object is not suitable.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">      :class:`_ObjectStandInRegistry` for details on how to work with</span>
<span class="sd">      stand-ins.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<span class="c">## pylint: enable=R0903</span>


<span class="k">class</span> <span class="nc">_ObjectStandInRegistry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Provides a registry for object stand-ins.</span>

<span class="sd">    Objects can be registered and given stand-in objects to use in their place.</span>
<span class="sd">    Those same stand-ins can then be retrieved at a later time and used again.</span>

<span class="sd">    Stand-ins can be used in any situation where the original object cannot or</span>
<span class="sd">    should not be used directly.  The prime use case is when adding additional</span>
<span class="sd">    attributes to an object that cannot accept additional objects.</span>

<span class="sd">    Original objects are only stored as weak references so there should not be</span>
<span class="sd">    any memory leaks from registering.</span>

<span class="sd">    When an object is registered, an instance of :class:`_ObjectStandIn` is</span>
<span class="sd">    returned.  That stand-in instance can then subsequently be retrieved using</span>
<span class="sd">    either the :meth:`get_stand_in` method or by mapping lookup.  For example::</span>

<span class="sd">      stand_in = registry[original_object]</span>

<span class="sd">    An object can be unregistered either by using the :meth:`unregister` method</span>
<span class="sd">    or by using the :keyword:`del` keyword in the mapping lookup.  For</span>
<span class="sd">    example::</span>

<span class="sd">      del registry[original_object]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See class docstring for this method&#39;s documentation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stand_ins</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See class docstring for this method&#39;s documentation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stand_ins</span><span class="p">[</span><span class="n">object_</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See class docstring for this method&#39;s documentation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">object_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stand_ins</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stand_ins</span><span class="p">[</span><span class="n">object_</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register an object as having a stand-in and return the stand-in.</span>

<span class="sd">        This method registers and created the stand-in object.  Registering the</span>
<span class="sd">        same object again will return the same stand-in.</span>

<span class="sd">        :param object_: The object to register.</span>

<span class="sd">        :returns: A stand-in object.</span>
<span class="sd">        :rtype: :class:`_ObjectStandIn`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stand_ins</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">object_</span><span class="p">,</span> <span class="n">_ObjectStandIn</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">is_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return :obj:`True` if the object is registered in the registry.</span>

<span class="sd">        :param object_: The object to check.</span>

<span class="sd">        :returns: :obj:`True` if the object is registered, :obj:`False`</span>
<span class="sd">          otherwise.</span>
<span class="sd">        :rtype: :obj:`bool`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">object_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stand_ins</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear the registry of all registrations.</span>

<span class="sd">        This will cause the stand-ins to be garbage collected if no other</span>
<span class="sd">        references to them are held.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stand_ins</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">unregister</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove an object from the registry</span>

<span class="sd">        This method unregisters an object.  This will cause the stand-in to be</span>
<span class="sd">        garbage collected if no other references to it are held.  Unregistering</span>
<span class="sd">        an object  that is already not registered will do nothing.</span>

<span class="sd">        :param object_: The registered object to remove.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">object_</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_stand_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Teturn the stand-in for the given object.</span>

<span class="sd">        :param object_: The registered object to get.</span>

<span class="sd">        :returns: The object&#39;s stand-in.</span>
<span class="sd">        :rtype: :class:`_ObjectStandIn`</span>

<span class="sd">        :raises exceptions.ValueError: If the object is not registered.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">object_</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;{0} not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">object_</span><span class="p">)))</span>


<span class="c">#---Module initialization------------------------------------------------------</span>


<span class="c">#---Late Imports---------------------------------------------------------------</span>


<span class="c">#---Late Globals---------------------------------------------------------------</span>


<span class="c">#---Late Functions-------------------------------------------------------------</span>


<span class="c">#---Late Classes---------------------------------------------------------------</span>


<span class="c">#---Late Module initialization-------------------------------------------------</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Message For You Sir! 0.3.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009-2012, Krys Lawrence.
      Last updated on 2012-02-22.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>