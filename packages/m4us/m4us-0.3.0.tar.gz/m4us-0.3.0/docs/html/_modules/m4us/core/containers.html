

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>m4us.core.containers &mdash; Message For You Sir! 0.3.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Message For You Sir! 0.3.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Message For You Sir! 0.3.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for m4us.core.containers</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="c">#---Header---------------------------------------------------------------------</span>

<span class="c"># This file is part of Message For You Sir (m4us).</span>
<span class="c"># Copyright Â© 2009-2012 Krys Lawrence</span>
<span class="c">#</span>
<span class="c"># Message For You Sir is free software: you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c"># the Free Software Foundation, either version 3 of the License, or (at your</span>
<span class="c"># option) any later version.</span>
<span class="c">#</span>
<span class="c"># Message For You Sir is distributed in the hope that it will be useful, but</span>
<span class="c"># WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="c"># FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License</span>
<span class="c"># for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c"># along with Message For You Sir.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>


<span class="sd">&quot;&quot;&quot;Provides `components` that can contain and link other `components`.</span>

<span class="sd">Containers are `components` that contain other `components` and `coroutines`,</span>
<span class="sd">linking them in various ways.  These objects make it convenient to group</span>
<span class="sd">`coroutines` together to make larger reusable `components`.  The `coroutines`</span>
<span class="sd">contained within containers can be linked not only to each other, but to the</span>
<span class="sd">containers as well, allowing the containers externally to act like any other</span>
<span class="sd">`components`.</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="c">#---Imports--------------------------------------------------------------------</span>

<span class="c">#---  Standard library imports</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="c">## pylint: disable=W0622, W0611</span>
<span class="kn">from</span> <span class="nn">future_builtins</span> <span class="kn">import</span> <span class="n">ascii</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="nb">hex</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">oct</span><span class="p">,</span> <span class="nb">zip</span>  <span class="c">## NOQA</span>
<span class="c">## pylint: enable=W0622, W0611</span>

<span class="c">#---  Third-party imports</span>
<span class="c">## pylint: disable=F0401</span>
<span class="kn">from</span> <span class="nn">zope</span> <span class="kn">import</span> <span class="n">interface</span>
<span class="c">## pylint: enable=F0401</span>

<span class="c">#---  Project imports</span>
<span class="kn">from</span> <span class="nn">m4us.core</span> <span class="kn">import</span> <span class="n">components</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">,</span> <span class="n">interfaces</span>


<span class="c">#---Globals--------------------------------------------------------------------</span>


<span class="c">#---Functions------------------------------------------------------------------</span>


<span class="c">#---Classes--------------------------------------------------------------------</span>

<span class="nd">@interface.implementer</span><span class="p">(</span><span class="n">interfaces</span><span class="o">.</span><span class="n">IContainer</span><span class="p">)</span>
<span class="nd">@interface.provider</span><span class="p">(</span><span class="n">interfaces</span><span class="o">.</span><span class="n">IContainerFactory</span><span class="p">,</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">ICoroutineFactory</span><span class="p">)</span>
<div class="viewcode-block" id="Graphline"><a class="viewcode-back" href="../../../api/core/m4us.core.containers.html#m4us.core.containers.Graphline">[docs]</a><span class="k">class</span> <span class="nc">Graphline</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">Component</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Container `component` of `coroutines` with fully configurable `links`.</span>

<span class="sd">    This corresponds to Kamaelia_&#39;s :class:`!Graphline` class.</span>

<span class="sd">    This class is useful for grouping several `coroutines` together, while</span>
<span class="sd">    still being able to specify special (i.e. non-standard) `links` among them.</span>
<span class="sd">    Where the :class:`Pipeline` class provides a strait linear linkage between</span>
<span class="sd">    it&#39;s `coroutines`, this class allows you to specify your own `links` as</span>
<span class="sd">    required.</span>

<span class="sd">    Only the `links` need to be specified.  The unique collection of</span>
<span class="sd">    `coroutines` will be automatically extracted from them.</span>

<span class="sd">    Additionally, if a `source` or `sink` is specified as ``&#39;self&#39;``, then a</span>
<span class="sd">    `link` will be created with the :class:`Graphline` instance.  This allows</span>
<span class="sd">    `messages` sent to the :class:`Graphline` instance to be forwarded on to</span>
<span class="sd">    the appropriate child `coroutine` and `messages` from a child to be sent</span>
<span class="sd">    out as the output from the :class:`Graphline`.  Note, however, that unlike</span>
<span class="sd">    regular `links`, when using ``&#39;self&#39;``, `links` should be `outbox` to</span>
<span class="sd">    `outbox` or `inbox` to `inbox`.  Kamaelia_ calls these types of `links`</span>
<span class="sd">    *pass-through linkages*.</span>

<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; graphline = Graphline(</span>
<span class="sd">    ...   (&#39;self&#39;, &#39;inbox&#39;, coroutine1, &#39;inbox&#39;),</span>
<span class="sd">    ...   (&#39;self&#39;, &#39;control&#39;, coroutine1, &#39;control&#39;),</span>
<span class="sd">    ...   (coroutine1, &#39;outbox&#39;, coroutine2, &#39;inbox&#39;),</span>
<span class="sd">    ...   (coroutine1, &#39;signal&#39;, coroutine2, &#39;control&#39;),</span>
<span class="sd">    ...   (coroutine1, &#39;outbox&#39;, coroutine3, &#39;inbox&#39;),</span>
<span class="sd">    ...   (coroutine1, &#39;signal&#39;, coroutine3, &#39;control&#39;),</span>
<span class="sd">    ...   (coroutine2, &#39;outbox&#39;, &#39;self&#39;, &#39;outbox&#39;),</span>
<span class="sd">    ...   (coroutine2, &#39;signal&#39;, &#39;self&#39;, &#39;signal&#39;),</span>
<span class="sd">    ...   (coroutine3, &#39;outbox&#39;, &#39;self&#39;, &#39;outbox&#39;),</span>
<span class="sd">    ...   (coroutine3, &#39;signal&#39;, &#39;self&#39;, &#39;signal&#39;),</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; scheduler.register(*graphline.coroutines)</span>
<span class="sd">    &gt;&gt;&gt; post_office.register(*graphline.links)</span>

<span class="sd">    In this example, `messages` sent to *graphline* will be forwarded on to</span>
<span class="sd">    *coroutine1*.  `Messages` from *coroutine1* will be sent to both</span>
<span class="sd">    *coroutine2* and *coroutine3*.  And `messages` from both *coroutine2* and</span>
<span class="sd">    *coroutine3* will be forwarded out from *graphline*. This is a good example</span>
<span class="sd">    of non-standard `links`.</span>

<span class="sd">    Assuming there is a `producer` and a `consumer` connected to either side of</span>
<span class="sd">    the graphline, then visually, the above example looks like this:</span>

<span class="sd">    .. digraph:: graphline</span>

<span class="sd">        rankdir=LR</span>
<span class="sd">        producer -&gt; graphline [ label = &quot;1&quot; ]</span>
<span class="sd">        graphline -&gt; consumer [ label = &quot;5&quot; ]</span>
<span class="sd">        graphline -&gt; coroutine1 [ label = &quot;2&quot; ]</span>
<span class="sd">        coroutine1 -&gt; coroutine2 [ label = &quot;3&quot; ]</span>
<span class="sd">        coroutine1 -&gt; coroutine3 [ label = &quot;3&quot; ]</span>
<span class="sd">        coroutine2 -&gt; graphline [ label = &quot;4&quot; ]</span>
<span class="sd">        coroutine3 -&gt; graphline [ label = &quot;4&quot; ]</span>

<span class="sd">    :param collections.Sequence links: The `links` and `coroutines` to</span>
<span class="sd">      contain.  Each `link` should be in the form of :samp:`({source},</span>
<span class="sd">      {outbox}, {sink}, {inbox})`.</span>
<span class="sd">    :param collections.Mapping kwargs: Any keyword arguments will be set as</span>
<span class="sd">      attributes on the instance.</span>

<span class="sd">    :raises m4us.core.exceptions.InvalidLinkError: If an invalid `link`</span>
<span class="sd">      involving the :class:`Graphline`&#39;s `mailboxes` is attempted.</span>

<span class="sd">    :implements: :class:`m4us.core.interfaces.ICoroutine` and</span>
<span class="sd">      :class:`m4us.core.interfaces.IContainer`</span>
<span class="sd">    :provides: :class:`m4us.core.interfaces.ICoroutineFactory` and</span>
<span class="sd">      :class:`m4us.core.interfaces.IContainerFactory`</span>

<span class="sd">    .. seealso::</span>

<span class="sd">      The :class:`~m4us.core.interfaces.ICoroutine` and</span>
<span class="sd">      :class:`~m4us.core.interfaces.IContainer` `interfaces` for details on the</span>
<span class="sd">      methods and attributes provided by instances of this class.</span>

<span class="sd">    .. _Kamaelia: http://kamaelia.org</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">links</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See class docstring for this method&#39;s documentation.&quot;&quot;&quot;</span>
        <span class="n">components</span><span class="o">.</span><span class="n">Component</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coroutines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coroutines_attribute</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_links</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>

    <span class="c">## pylint: disable=R0201</span>
    <span class="k">def</span> <span class="nf">_add_sub_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coroutine</span><span class="p">,</span> <span class="n">coroutines</span><span class="p">,</span> <span class="n">coroutines_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the `coroutine` is a `container`, add include it&#39;s children.</span>

<span class="sd">        If the `coroutine` is an</span>
<span class="sd">        :class:`~m4us.core.interfaces.IContainer`, then it&#39;s `coroutines` are</span>
<span class="sd">        added to the :class:`list` and :class:`set` of `coroutines.</span>

<span class="sd">        :param ICoroutine coroutine: The `coroutine` to check.</span>
<span class="sd">        :param list coroutines: Pre-existing list of `coroutines` to extend.</span>
<span class="sd">        :param set coroutines_set: Pre-existing set of `coroutines` to extend.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">container</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">IContainer</span><span class="p">(</span><span class="n">coroutine</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">container</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sub_coroutine</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">coroutines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sub_coroutine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">coroutines_set</span><span class="p">:</span>
                    <span class="n">coroutines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_coroutine</span><span class="p">)</span>
                    <span class="n">coroutines_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sub_coroutine</span><span class="p">)</span>
    <span class="c">## pylint: enable=R0201</span>

    <span class="k">def</span> <span class="nf">_get_coroutines_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract and return the `coroutines` from the `links`.</span>

<span class="sd">        The `coroutines` are all unique `coroutines` from the given `links`,</span>
<span class="sd">        including the :class:`Graphline` instance.</span>

<span class="sd">        If any `coroutine` is also an</span>
<span class="sd">        :class:`~m4us.core.interfaces.IContainer`, then it&#39;s `coroutines` are</span>
<span class="sd">        included automatically.</span>

<span class="sd">        :param collections.Iterable links: The `post office` `links` given at</span>
<span class="sd">          instantiation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coroutines</span><span class="p">,</span> <span class="n">coroutines_set</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">coroutine</span> <span class="ow">in</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">coroutine</span> <span class="o">!=</span> <span class="s">&#39;self&#39;</span> <span class="ow">and</span> <span class="n">coroutine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">coroutines_set</span><span class="p">:</span>
                    <span class="n">coroutines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coroutine</span><span class="p">)</span>
                    <span class="n">coroutines_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">coroutine</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_sub_container</span><span class="p">(</span><span class="n">coroutine</span><span class="p">,</span> <span class="n">coroutines</span><span class="p">,</span> <span class="n">coroutines_set</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">coroutines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare and return the modified `links`.</span>

<span class="sd">        Any `links` that use ``&#39;self&#39;`` as the `source` or `sink` are converted</span>
<span class="sd">        to `links` to or from the :class:`Graphline` instance.</span>

<span class="sd">        :param collections.Iterable links: The `post office` `links` given at</span>
<span class="sd">          instantiation.</span>

<span class="sd">        If any `coroutine` is also an</span>
<span class="sd">        :class:`~m4us.core.interfaces.IContainer`, then it&#39;s `links` are</span>
<span class="sd">        included automatically.</span>

<span class="sd">        :raises m4us.core.exceptions.InvalidLinkError: If an invalid `link`</span>
<span class="sd">          involving the :class:`Graphline`&#39;s `mailboxes` is attempted.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">          The class&#39;s docstring for more details on how ``&#39;self&#39;`` `links` are</span>
<span class="sd">          handled.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prepared_links</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">inbox</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s">&#39;self&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">outbox</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;outbox&#39;</span><span class="p">,</span> <span class="s">&#39;signal&#39;</span><span class="p">):</span>
                    <span class="c">## pylint: disable=E1101</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidLinkError</span><span class="p">(</span><span class="n">source_outbox</span><span class="o">=</span><span class="p">(</span><span class="n">source</span><span class="p">,</span>
                      <span class="n">outbox</span><span class="p">),</span> <span class="n">sink_inbox</span><span class="o">=</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">inbox</span><span class="p">))</span>
                    <span class="c">## pylint: enable=E1101</span>
                <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="k">if</span> <span class="n">outbox</span> <span class="o">==</span> <span class="s">&#39;inbox&#39;</span><span class="p">:</span>
                    <span class="n">outbox</span> <span class="o">=</span> <span class="s">&#39;_outbox_to_child&#39;</span>
                <span class="k">elif</span> <span class="n">outbox</span> <span class="o">==</span> <span class="s">&#39;control&#39;</span><span class="p">:</span>
                    <span class="n">outbox</span> <span class="o">=</span> <span class="s">&#39;_signal_to_child&#39;</span>
            <span class="k">if</span> <span class="n">sink</span> <span class="o">==</span> <span class="s">&#39;self&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inbox</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;inbox&#39;</span><span class="p">,</span> <span class="s">&#39;control&#39;</span><span class="p">):</span>
                    <span class="c">## pylint: disable=E1101</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidLinkError</span><span class="p">(</span><span class="n">source_outbox</span><span class="o">=</span><span class="p">(</span><span class="n">source</span><span class="p">,</span>
                      <span class="n">outbox</span><span class="p">),</span> <span class="n">sink_inbox</span><span class="o">=</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">inbox</span><span class="p">))</span>
                    <span class="c">## pylint: enable=E1101</span>
                <span class="n">sink</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="k">if</span> <span class="n">inbox</span> <span class="o">==</span> <span class="s">&#39;outbox&#39;</span><span class="p">:</span>
                    <span class="n">inbox</span> <span class="o">=</span> <span class="s">&#39;_inbox_from_child&#39;</span>
                <span class="k">elif</span> <span class="n">inbox</span> <span class="o">==</span> <span class="s">&#39;signal&#39;</span><span class="p">:</span>
                    <span class="n">inbox</span> <span class="o">=</span> <span class="s">&#39;_control_from_child&#39;</span>
            <span class="n">prepared_links</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">source</span><span class="p">,</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">inbox</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">coroutine</span> <span class="ow">in</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">coroutine</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">container</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">IContainer</span><span class="p">(</span><span class="n">coroutine</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">container</span><span class="p">:</span>
                    <span class="n">prepared_links</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">links</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">prepared_links</span><span class="p">)</span>

    <span class="c">## pylint: disable=R0201</span>
    <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Forward incoming and outgoing `messages` to and from the children.</span>

<span class="sd">        `Messages` sent in to this class are passed on to the appropriate child</span>
<span class="sd">        `coroutines` and `messages` from configured child `coroutines` are sent</span>
<span class="sd">        out from this class.</span>

<span class="sd">        :returns: The container&#39;s `coroutine`.</span>
<span class="sd">        :rtype: :class:`m4us.core.interfaces.ICoroutine`</span>

<span class="sd">        .. seealso::</span>

<span class="sd">          The :meth:`~m4us.core.interfaces.IComponent._main` method for more</span>
<span class="sd">          details on this method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mailbox_map</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s">&#39;control&#39;</span><span class="p">:</span> <span class="s">&#39;_signal_to_child&#39;</span><span class="p">,</span>
          <span class="s">&#39;_inbox_from_child&#39;</span><span class="p">:</span> <span class="s">&#39;outbox&#39;</span><span class="p">,</span>
          <span class="s">&#39;_control_from_child&#39;</span><span class="p">:</span> <span class="s">&#39;signal&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">inbox</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="k">yield</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">outbox</span> <span class="o">=</span> <span class="n">mailbox_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="s">&#39;_outbox_to_child&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">(</span><span class="n">outbox</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="s">&#39;signal&#39;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">message</span>
                <span class="k">break</span>
            <span class="n">inbox</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="k">yield</span> <span class="n">outbox</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="c">## pylint: enable=R0201</span>

</div>
<span class="nd">@interface.provider</span><span class="p">(</span><span class="n">interfaces</span><span class="o">.</span><span class="n">IContainerFactory</span><span class="p">,</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">ICoroutineFactory</span><span class="p">)</span>
<div class="viewcode-block" id="Pipeline"><a class="viewcode-back" href="../../../api/core/m4us.core.containers.html#m4us.core.containers.Pipeline">[docs]</a><span class="k">class</span> <span class="nc">Pipeline</span><span class="p">(</span><span class="n">Graphline</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Container `component` of `coroutines` that `links` them in a pipeline.</span>

<span class="sd">    This corresponds to Kamaelia_&#39;s :class:`!Pipeline` class.</span>

<span class="sd">    A pipeline consists of chaining each of the given `coroutines` together in</span>
<span class="sd">    order such that the ``outbox`` and ``signal`` `outboxes` of each</span>
<span class="sd">    `coroutine` are linked to the ``inbox`` and ``control`` `inboxes` of the</span>
<span class="sd">    next one.</span>

<span class="sd">    Additionally, the :class:`Pipeline`&#39;s ``inbox`` and ``control`` `inboxes`</span>
<span class="sd">    are linked to the first `coroutine`&#39;s ``inbox`` and ``control`` `inboxes`.</span>
<span class="sd">    Similarily, the :class:`Pipeline`&#39;s ``outbox`` and ``signal`` `outboxes`</span>
<span class="sd">    are linked to the last `coroutine`&#39;s ``outbox`` and ``signal`` `outboxes`.</span>
<span class="sd">    This means that the pipeline can be treated like any other `coroutine`,</span>
<span class="sd">    responding to incomming `messages` and emitting outgoing `messages`.</span>

<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; pipeline = Pipeline(coroutine1, coroutine2, coroutine3)</span>
<span class="sd">    &gt;&gt;&gt; scheduler.register(*pipeline.coroutines)</span>
<span class="sd">    &gt;&gt;&gt; post_office.register(*pipeline.links)</span>

<span class="sd">    In this example, `messages` sent to *pipeline* will be forwarded on to</span>
<span class="sd">    *coroutine1*, who&#39;s `messages` will be sent to *coroutine2*, who&#39;s</span>
<span class="sd">    `messages` will be sent to *coroutine3*, who&#39;s `messages` will be forwarded</span>
<span class="sd">    out of *pipeline*.</span>

<span class="sd">    Assuming there is a `producer` and a `consumer` connected to either side of</span>
<span class="sd">    the pipeline, then visually, the above example looks like this:</span>

<span class="sd">    .. digraph:: pipeline</span>

<span class="sd">        rankdir=LR</span>
<span class="sd">        producer -&gt; pipeline [ label = &quot;1&quot; ]</span>
<span class="sd">        pipeline -&gt; consumer [ label = &quot;6&quot; ]</span>
<span class="sd">        pipeline -&gt; coroutine1 [ label = &quot;2&quot; ]</span>
<span class="sd">        coroutine1 -&gt; coroutine2 [ label = &quot;3&quot; ]</span>
<span class="sd">        coroutine2 -&gt; coroutine3 [ label = &quot;4&quot; ]</span>
<span class="sd">        coroutine3 -&gt; pipeline [ label = &quot;5&quot; ]</span>

<span class="sd">    :param m4us.core.interfaces.ICoroutine first_coroutine: The first</span>
<span class="sd">      `coroutine` in the pipeline.  It will receive incomming `messages` to the</span>
<span class="sd">      pipeline.</span>
<span class="sd">    :param m4us.core.interfaces.ICoroutine second_coroutine: The second</span>
<span class="sd">      `coroutine` in the pipeline.  It will receive incomming `messages` to the</span>
<span class="sd">      pipeline.</span>
<span class="sd">    :param collections.Sequence other_coroutines: Any other `coroutines` in the</span>
<span class="sd">      pipeline, in order. `Messages` emmitted by the last one will be emitted</span>
<span class="sd">      by the pipeline.</span>
<span class="sd">    :param collections.Mapping kwargs: Like other `components`, any given</span>
<span class="sd">      keyword arguments will be set as instance attributes.</span>

<span class="sd">    :implements: :class:`m4us.core.interfaces.ICoroutine` and</span>
<span class="sd">      :class:`m4us.core.interfaces.IContainer`</span>
<span class="sd">    :provides: :class:`m4us.core.interfaces.ICoroutineFactory` and</span>
<span class="sd">      :class:`m4us.core.interfaces.IContainerFactory`</span>

<span class="sd">    .. seealso::</span>

<span class="sd">      The :class:`~m4us.core.interfaces.ICoroutine` and</span>
<span class="sd">      :class:`~m4us.core.interfaces.IContainer` `interfaces` for details on the</span>
<span class="sd">      methods and attributes provided by instances of this class.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_coroutine</span><span class="p">,</span> <span class="n">second_coroutine</span><span class="p">,</span> <span class="o">*</span><span class="n">other_coroutines</span><span class="p">,</span>
      <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See class docstring for this method&#39;s documentation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_coroutines</span> <span class="o">=</span> <span class="p">((</span><span class="n">first_coroutine</span><span class="p">,</span> <span class="n">second_coroutine</span><span class="p">)</span> <span class="o">+</span>
          <span class="n">other_coroutines</span><span class="p">)</span>
        <span class="n">links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_links</span><span class="p">(</span><span class="n">first_coroutine</span><span class="p">,</span> <span class="n">second_coroutine</span><span class="p">,</span>
          <span class="o">*</span><span class="n">other_coroutines</span><span class="p">)</span>
        <span class="c">## pylint: disable=W0142</span>
        <span class="n">Graphline</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">links</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c">## pylint: enable=W0142</span>

    <span class="c">## pylint: disable=R0201</span>
    <span class="k">def</span> <span class="nf">_build_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">coroutines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct and return the set of pipeline `links`.</span>

<span class="sd">        This method generates a set of `links` chaining all the given</span>
<span class="sd">        `coroutines` together in a pipeline.  The set of links is in the format</span>
<span class="sd">        that the :class:`Graphline` parent class accepts.</span>

<span class="sd">        Additionally, the class&#39;s ``inbox``, ``control``, ``outbox`` and</span>
<span class="sd">        ``signal`` `mailboxes` are linked to the first and last `coroutines`</span>
<span class="sd">        appropriately so that `messages` to and from the class itself are</span>
<span class="sd">        delivered as expected.</span>

<span class="sd">        :param collections.Sequence coroutines: The `coroutines` to link</span>
<span class="sd">          together.</span>

<span class="sd">        :returns: The collection of `links` to pass to the parent</span>
<span class="sd">          :class:`Graphline` class.</span>
<span class="sd">        :rtype: :obj:`set`</span>

<span class="sd">        .. seealso::</span>

<span class="sd">          The :class:`Graphline` class for details on the `link` format and the</span>
<span class="sd">          use of ``&#39;self&#39;`` in them.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">links</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">easy_link</span><span class="p">(</span><span class="o">*</span><span class="n">coroutines</span><span class="p">)</span>
        <span class="n">links</span><span class="o">.</span><span class="n">update</span><span class="p">((</span>
          <span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">,</span> <span class="s">&#39;inbox&#39;</span><span class="p">,</span> <span class="n">coroutines</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;inbox&#39;</span><span class="p">),</span>
          <span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">,</span> <span class="s">&#39;control&#39;</span><span class="p">,</span> <span class="n">coroutines</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;control&#39;</span><span class="p">),</span>
          <span class="p">(</span><span class="n">coroutines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;outbox&#39;</span><span class="p">,</span> <span class="s">&#39;self&#39;</span><span class="p">,</span> <span class="s">&#39;outbox&#39;</span><span class="p">),</span>
          <span class="p">(</span><span class="n">coroutines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;signal&#39;</span><span class="p">,</span> <span class="s">&#39;self&#39;</span><span class="p">,</span> <span class="s">&#39;signal&#39;</span><span class="p">),</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="n">links</span>
    <span class="c">## pylint: enable=R0201</span>

    <span class="k">def</span> <span class="nf">_get_coroutines_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract and return the `coroutines` in the `links`.</span>

<span class="sd">        This method has been overridden to handle sub-containers while still</span>
<span class="sd">        preserving the coroutine order as best as it can.</span>

<span class="sd">        :param collections.Iterable links: The `post office` `links` given at</span>
<span class="sd">          instantiation.  *(Not used)*.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coroutines</span><span class="p">,</span> <span class="n">coroutines_set</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">coroutine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_coroutines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coroutine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">coroutines_set</span><span class="p">:</span>
                <span class="n">coroutines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coroutine</span><span class="p">)</span>
                <span class="n">coroutines_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">coroutine</span><span class="p">)</span>
            <span class="c"># This order is important.  sub_container coroutine should be</span>
            <span class="c"># ordered immediately after the parent container to keep actual</span>
            <span class="c"># execution order fair.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_sub_container</span><span class="p">(</span><span class="n">coroutine</span><span class="p">,</span> <span class="n">coroutines</span><span class="p">,</span> <span class="n">coroutines_set</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">coroutines</span><span class="p">)</span>


<span class="c">#---Module initialization------------------------------------------------------</span>


<span class="c">#---Late Imports---------------------------------------------------------------</span>


<span class="c">#---Late Globals---------------------------------------------------------------</span>


<span class="c">#---Late Functions-------------------------------------------------------------</span>


<span class="c">#---Late Classes---------------------------------------------------------------</span>


<span class="c">#---Late Module initialization-------------------------------------------------</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Message For You Sir! 0.3.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009-2012, Krys Lawrence.
      Last updated on 2012-02-22.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>