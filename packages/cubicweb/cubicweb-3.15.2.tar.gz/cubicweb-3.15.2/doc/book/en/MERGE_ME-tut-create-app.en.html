<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<div class="component-title-block"><div class="component-title">Tutoriel : créer votre première application web pour Google AppEngine</div></div>


<div class="para">[TRANSLATE ME TO FRENCH]</div>
<div class="para">This tutorial will guide you step by step to build a blog application
and discover the unique features of <span class="emphasis">LAX</span>. It assumes that you followed
the :ref:`installation` guidelines and that both the <span class="emphasis">AppEngine SDK</span> and the
<span class="emphasis">LAX</span> framework are setup on your computer.</div>
<div class="para">Unknown interpreted text role "ref".</div>
<div class="sect1-title">
<a name="creating-a-new-application"></a>1. Creating a new application</div>

<div class="para">We choosed in this tutorial to develop a blog as an example of web application
and will go through each required steps/actions to have it running with <span class="emphasis">LAX</span>.
When you installed <span class="emphasis">LAX</span>, you saw a directory named <span class="literal">skel</span>. Make a copy of
this directory and call it <span class="literal">BlogDemo</span>.</div>
<div class="para">The location of this directory does not matter. But once decided, make sure your <span class="literal">PYTHONPATH</span> is properly set (:ref:`installation`).</div>
<div class="para">Unknown interpreted text role "ref".</div>

<div class="sect1-title">
<a name="defining-a-schema"></a>2. Defining a schema</div>

<div class="para">With <span class="emphasis">LAX</span>, the schema/datamodel is the core of the application. This is where
you will define the type of content you have to hanlde in your application.</div>
<div class="para">Let us start with something simple and improve on it iteratively.</div>
<div class="para">In schema.py, we define two entities: <span class="literal">Blog</span> and <span class="literal">BlogEntry</span>.</div>
<div class="programlisting">
class Blog(EntityType):
    title = String(maxsize=50, required=True)
    description = String()

class BlogEntry(EntityType):
    title = String(maxsize=100, required=True)
    publish_date = Date(default='TODAY')
    text = String(fulltextindexed=True)
    category = String(vocabulary=('important','business'))
    entry_of = SubjectRelation('Blog', cardinality='?*')
</div>
<div class="para">A Blog has a title and a description. The title is a string that is
required by the class EntityType and must be less than 50 characters.
The description is a string that is not constrained.</div>
<div class="para">A BlogEntry has a title, a publish_date and a text. The title is a
string that is required and must be less than 100 characters. The
publish_date is a Date with a default value of TODAY, meaning that
when a BlogEntry is created, its publish_date will be the current day
unless it is modified. The text is a string that will be indexed in
the full-text index and has no constraint.</div>
<div class="para">A BlogEntry also has a relationship <span class="literal">entry_of</span> that link it to a
Blog. The cardinality <span class="literal">?*</span> means that a BlogEntry can be part of
zero or one Blog (<span class="literal">?</span> means <span class="emphasis">zero or one</span>) and that a Blog can
have any number of BlogEntry (<span class="literal">*</span> means <span class="emphasis">any number including
zero</span>). For completeness, remember that <span class="literal">+</span> means <span class="emphasis">one or more</span>.</div>

<div class="sect1-title">
<a name="running-the-application"></a>3. Running the application</div>

<div class="para">Defining this simple schema is enough to get us started. Make sure you
followed the setup steps described in detail in the installation
chapter (especially visiting <a class="" href="http://localhost:8080/_load">http://localhost:8080/_load</a> as an
administrator), then launch the application with the command:</div>
<div class="programlisting">
python dev_appserver.py BlogDemo
</div>
<div class="para">and point your browser at <a class="" href="http://localhost:8080/">http://localhost:8080/</a> (if it is easier for
you, use the on-line demo at <a class="" href="http://lax.appspot.com/">http://lax.appspot.com/</a>).</div>
<div class="image"><img src="./images/lax-book.00-login.en.png" alt="login screen"></div><div class="para">After you log in, you will see the home page of your application. It
lists the entity types: Blog and BlogEntry. If these links read
<span class="literal">blog_plural</span> and <span class="literal">blogentry_plural</span> it is because
internationalization (i18n) is not working for you yet. Please ignore
this for now.</div>
<div class="image"><img src="./images/lax-book.01-start.en.png" alt="home page"></div>
<div class="sect1-title">
<a name="creating-system-entities"></a>4. Creating system entities</div>

<div class="para">You can only create new users if you decided not to use google authentication.</div>
<div class="para">[WRITE ME : create users manages permissions etc]</div>

<div class="sect1-title">
<a name="creating-application-entites"></a>5. Creating application entites</div>

<div class="sect2-title">
<a name="create-a-blog"></a>5.1. Create a Blog</div>

<div class="para">Let us create a few of these entities. Click on the [+] at the right
of the link Blog.  Call this new Blog <span class="literal">Tech-blog</span> and type in
<span class="literal">everything about technology</span> as the description, then validate the
form by clicking on <span class="literal">Validate</span>.</div>
<div class="image"><img src="./images/lax-book.02-create-blog.en.png" alt="from to create blog"></div><div class="para">Click on the logo at top left to get back to the home page, then
follow the Blog link that will list for you all the existing Blog.
You should be seeing a list with a single item <span class="literal">Tech-blog</span> you
just created.</div>
<div class="image"><img src="./images/lax-book.03-list-one-blog.en.png" alt="displaying a list of a single blog"></div><div class="para">Clicking on this item will get you to its detailed description except
that in this case, there is not much to display besides the name and
the phrase <span class="literal">everything about technology</span>.</div>
<div class="image"><img src="./images/lax-book.04-detail-one-blog.en.png" alt="displaying the detailed view of a blog"></div><div class="para">Now get back to the home page by clicking on the top-left logo, then
create a new Blog called <span class="literal">MyLife</span> and get back to the home page
again to follow the Blog link for the second time. The list now
has two items.</div>
<div class="image"><img src="./images/lax-book.05-list-two-blog.en.png" alt="displaying a list of two blogs"></div>
<div class="sect2-title">
<a name="create-a-blogentry"></a>5.2. Create a BlogEntry</div>

<div class="para">Get back to the home page and click on [+] at the right of the link
BlogEntry. Call this new entry <span class="literal">Hello World</span> and type in some text
before clicking on <span class="literal">Validate</span>. You added a new blog entry without
saying to what blog it belongs. There is a box on the left entitled
<span class="literal">actions</span>, click on the menu item <span class="literal">modify</span>. You are back to the form
to edit the blog entry you just created, except that the form now has
another section with a combobox titled <span class="literal">add relation</span>. Chose
<span class="literal">entry_of</span> in this menu and a second combobox appears where you pick
<span class="literal">MyLife</span>.</div>
<div class="para">You could also have, at the time you started to fill the form for a
new entity BlogEntry, hit <span class="literal">Apply</span> instead of <span class="literal">Validate</span> and the
combobox titled <span class="literal">add relation</span> would have showed up.</div>
<div class="image"><img src="./images/lax-book.06-add-relation-entryof.en.png" alt="editing a blog entry to add a relation to a blog"></div><div class="para">Validate the changes by clicking <span class="literal">Validate</span>. The entity BlogEntry
that is displayed now includes a link to the entity Blog named
<span class="literal">MyLife</span>.</div>
<div class="image"><img src="./images/lax-book.07-detail-one-blogentry.en.png" alt="displaying the detailed view of a blogentry"></div><div class="para">Remember that all of this was handled by the framework and that the
only input that was provided so far is the schema. To get a graphical
view of the schema, run the <span class="literal">laxctl genschema BlogDemo</span> command as
explained in the installation section and point your browser to the
URL <a class="" href="http://localhost:8080/schema">http://localhost:8080/schema</a>
</div>
<div class="image"><img src="./images/lax-book.08-schema.en.png" alt="graphical view of the schema (aka data-model)"></div>

<div class="sect1-title">
<a name="site-configuration"></a>6. Site configuration</div>

<div class="image"><img src="./images/lax-book.03-site-config-panel.en.png"></div><div class="para">This panel allows you to configure the appearance of your application site.
Six menus are available and we will go through each of them to explain how
to use them.</div>
<div class="sect2-title">
<a name="navigation"></a>6.1. Navigation</div>

<div class="para">This menu provides you a way to adjust some navigation options depending on
your needs, such as the number of entities to display by page of results.
Follows the detailled list of available options:</div>
<ul class="list">
<li class="listitem">
<div class="para">navigation.combobox-limit: maximum number of entities to display in related
combo box (sample format: 23)</div>
</li>
<li class="listitem">
<div class="para">navigation.page-size: maximum number of objects displayed by page of results
(sample format: 23)</div>
</li>
<li class="listitem">
<div class="para">navigation.related-limit: maximum number of related entities to display in
the primary view (sample format: 23)</div>
</li>
<li class="listitem">
<div class="para">navigation.short-line-size: maximum number of characters in short description
(sample format: 23)</div>
</li>
</ul>

<div class="sect2-title">
<a name="ui"></a>6.2. UI</div>

<div class="para">This menu provides you a way to customize the user interface settings such as
date format or encoding in the produced html.
Follows the detailled list of available options:</div>
<ul class="list">
<li class="listitem">
<div class="para">ui.date-format : how to format date in the ui ("man strftime" for format description)</div>
</li>
<li class="listitem">
<div class="para">ui.datetime-format : how to format date and time in the ui ("man strftime" for format
description)</div>
</li>
<li class="listitem">
<div class="para">ui.default-text-format : default text format for rich text fields.</div>
</li>
<li class="listitem">
<div class="para">ui.encoding : user interface encoding</div>
</li>
<li class="listitem">
<div class="para">ui.fckeditor : should html fields being edited using fckeditor (a HTML WYSIWYG editor).
You should also select text/html as default text format to actually get fckeditor.</div>
</li>
<li class="listitem">
<div class="para">ui.float-format : how to format float numbers in the ui</div>
</li>
<li class="listitem">
<div class="para">ui.language : language of the user interface</div>
</li>
<li class="listitem">
<div class="para">ui.main-template : id of main template used to render pages</div>
</li>
<li class="listitem">
<div class="para">ui.site-title : site title, which is displayed right next to the logo in the header</div>
</li>
<li class="listitem">
<div class="para">ui.time-format : how to format time in the ui ("man strftime" for format description)</div>
</li>
</ul>

<div class="sect2-title">
<a name="actions"></a>6.3. Actions</div>

<div class="para">This menu provides a way to configure the context in which you expect the actions
to be displayed to the user and if you want the action to be visible or not.
You must have notice that when you view a list of entities, an action box is
available on the left column which display some actions as well as a drop-down
menu for more actions.</div>
<div class="para">The context available are:</div>
<ul class="list">
<li class="listitem">
<div class="para">mainactions : actions listed in the left box</div>
</li>
<li class="listitem">
<div class="para">moreactions : actions listed in the <span class="emphasis">more</span> menu of the left box</div>
</li>
<li class="listitem">
<div class="para">addrelated : add actions listed in the left box</div>
</li>
<li class="listitem">
<div class="para">useractions : actions listed in the first section of drop-down menu
accessible from the right corner user login link</div>
</li>
<li class="listitem">
<div class="para">siteactions : actions listed in the second section of drop-down menu
accessible from the right corner user login link</div>
</li>
<li class="listitem">
<div class="para">hidden : select this to hide the specific action</div>
</li>
</ul>

<div class="sect2-title">
<a name="boxes"></a>6.4. Boxes</div>

<div class="para">The application has already a pre-defined set of boxes you can use right away.
This configuration section allows you to place those boxes where you want in the
application interface to customize it.</div>
<div class="para">The available boxes are:</div>
<ul class="list">
<li class="listitem">
<div class="para">actions box : box listing the applicable actions on the displayed data</div>
</li>
<li class="listitem">
<div class="para">boxes_blog_archives_box : box listing the blog archives</div>
</li>
<li class="listitem">
<div class="para">possible views box : box listing the possible views for the displayed data</div>
</li>
<li class="listitem">
<div class="para">rss box : RSS icon to get displayed data as a RSS thread</div>
</li>
<li class="listitem">
<div class="para">search box : search box</div>
</li>
<li class="listitem">
<div class="para">startup views box : box listing the configuration options available for
the application site, such as <span class="emphasis">Preferences</span> and <span class="emphasis">Site Configuration</span>
</div>
</li>
</ul>

<div class="sect2-title">
<a name="components"></a>6.5. Components</div>

<div class="para">[WRITE ME]</div>

<div class="sect2-title">
<a name="contextual-components"></a>6.6. Contextual components</div>

<div class="para">[WRITE ME]</div>


<div class="sect1-title">
<a name="set-up-a-workflow"></a>7. Set-up a workflow</div>

<div class="para">Before starting, make sure you refresh your mind by reading [link to
definition_workflow chapter].</div>
<div class="para">We want to create a workflow to control the quality of the BlogEntry
submitted on your application. When a BlogEntry is created by a user
its state should be <span class="emphasis">submitted</span>. To be visible to all, it needs to
be in the state <span class="emphasis">published</span>. To move from <span class="emphasis">submitted</span> to <span class="emphasis">published</span>
we need a transition that we can name <span class="emphasis">approve_blogentry</span>.</div>
<div class="para">We do not want every user to be allowed to change the state of a
BlogEntry. We need to define a group of user, <span class="emphasis">moderators</span>, and
this group will have appropriate permissions to approve BlogEntry
to be published and visible to all.</div>
<div class="para">There are two ways to create a workflow, form the user interface,
and also by defining it in <span class="literal">migration/postcreate.py</span>. This script
is executed each time a new <span class="literal">./bin/laxctl db-init</span> is done.
If you create the states and transitions through the user interface
this means that next time you will need to initialize the database
you will have to re-create all the entities.
We strongly recommand you create the workflow in <span class="literal">migration\postcreate.py</span>
and we will now show you how.
The user interface would only be a reference for you to view the states
and transitions but is not the appropriate interface to define your
application workflow.</div>
<div class="sect2-title">
<a name="update-the-schema"></a>7.1. Update the schema</div>

<div class="para">To enable a BlogEntry to have a State, we have to define a relation
<span class="literal">in_state</span> in the schema of BlogEntry. Please do as follows, add
the line <span class="literal">in_state (...)</span>:</div>
<div class="programlisting">
class BlogEntry(EntityType):
    title = String(maxsize=100, required=True)
    publish_date = Date(default='TODAY')
    text_format = String(meta=True, internationalizable=True, maxsize=50,
                         default='text/rest', constraints=[format_constraint])
    text = String(fulltextindexed=True)
    category = String(vocabulary=('important','business'))
    entry_of = SubjectRelation('Blog', cardinality='?*')
    in_state = SubjectRelation('State', cardinality='1*')
</div>
<div class="para">As you updated the schema, you will have re-execute <span class="literal">./bin/laxctl db-init</span>
to initialize the database and migrate your existing entities.
[WRITE ABOUT MIGRATION]</div>

<div class="sect2-title">
<a name="create-states-transitions-and-group-permissions"></a>7.2. Create states, transitions and group permissions</div>

<div class="para">At the time the <span class="literal">postcreate.py</span> script is executed, several methods
can be used. They are all defined in the <span class="literal">class ServerMigrationHelper</span>.
We will only discuss the method we use to create a wrokflow here.</div>
<div class="para">To define our workflow for BlogDemo, please add the following lines
to <span class="literal">migration/postcreate.py</span>:</div>
<div class="programlisting">
_ = unicode

moderators      = add_entity('CWGroup', name=u"moderators")

submitted = add_state(_('submitted'), 'BlogEntry', initial=True)
published = add_state(_('published'), 'BlogEntry')

add_transition(_('approve_blogentry'), 'BlogEntry', (submitted,), published, ('moderators', 'managers'),)

checkpoint()
</div>
<div class="para">
<span class="literal">add_entity</span> is used here to define the new group of users that we
need to define the transitions, <span class="emphasis">moderators</span>.
If this group required by the transition is not defined before the
transition is created, it will not create the relation <span class="emphasis">transition
require the group moderator</span>.</div>
<div class="para">
<span class="literal">add_state</span> expects as the first argument the name of the state you are
willing to create, then the entity type on which the state can be applied,
and an optionnal argument to set if the state is the initial state
of the entity type or not.</div>
<div class="para">
<span class="literal">add_transition</span> expects as the first argument the name of the
transition, then the entity type on which we can apply the transition,
then the list of possible initial states from which the transition
can be applied, the target state of the transition, and the permissions
(e.g. list of the groups of users who can apply the transition).</div>
<div class="image"><img src="./images/lax-book.03-transitions-view.en.png"></div><div class="para">You can now notice that in the actions box of a BlogEntry, the state
is now listed as well as the possible transitions from this state
defined by the workflow. This transition, as defined in the workflow,
will only being displayed for the users belonging to the group
moderators of managers.</div>

<div class="sect2-title">
<a name="change-view-permission"></a>7.3. Change view permission</div>



<div class="sect1-title">
<a name="conclusion"></a>8. Conclusion</div>

<div class="sect2-title">
<a name="exercise"></a>8.1. Exercise</div>

<div class="para">Create new blog entries in <span class="literal">Tech-blog</span>.</div>

<div class="sect2-title">
<a name="what-we-learned"></a>8.2. What we learned</div>

<div class="para">Creating a simple schema was enough to set up a new application that
can store blogs and blog entries.</div>

<div class="sect2-title">
<a name="what-is-next"></a>8.3. What is next ?</div>

<div class="para">Although the application is fully functionnal, its look is very
basic. In the following section we will learn to create views to
customize how data is displayed.</div>



