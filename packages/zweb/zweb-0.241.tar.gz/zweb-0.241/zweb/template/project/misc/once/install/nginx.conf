
<%
from os.path import join
%>

<%def name="nginx_log_zweb(name)">
access_log /var/log/nginx/${name}.access_log log_zweb;
error_log /var/log/nginx/${name}.error_log log_zweb;
</%def>


<%def name="root_static()">
location ~ ^/(favicon\.ico|crossdomain\.xml|robots.txt) {
	expires max;
	root ${join(static,'html')};
}
</%def>


upstream ${name}{
%for port in ports:
	server 127.0.0.1:${port} weight=1;
%endfor
}

server {
	listen		80;
	server_name www.${host};
	charset utf-8;
	rewrite ^(.*)$ http://${host}$1 permanent;
}
server {
	listen 80;
	server_name ${host} *.${host};

	client_max_body_size 512M;
	${root_static()}

	location ~ ^/sitemap\.xml$ {
		root ${static}/html;
		expires 1d;
	}

	location / {
		expires -1;
		proxy_set_header Host $host;
		proxy_pass http://${name};
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		${nginx_log_zweb("main")}
	}

}


server {
    listen 80;
    server_name	${fs_domain};
	charset utf-8;
% if online_host:
	expires max;
% else:
	expires -1;
% endif
	location / {
		#valid_referers none blocked 41dev.com 42qu.com *.42qu.com 42qu.org *.42qu.org *.qq.com qq.com google.com *.douban.com douban.com *.youdao.com youdao.com *.163.com 42qu.info *.42qu.info;
		autoindex off;
		root	${static};
	}
	location ~ ^/(css|js)/{
		autoindex off;
% if online_host:
		expires max;
% else:
		expires -1;
% endif
		root	${static};
	}
}
