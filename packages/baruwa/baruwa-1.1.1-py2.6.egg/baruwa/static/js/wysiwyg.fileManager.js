(function(b){if(undefined===b.wysiwyg){throw"wysiwyg.fileManager.js depends on $.wysiwyg"}var a={name:"fileManager",version:"0.98",ajaxHandler:"",selected:null,setAjaxHandler:function(d){this.ajaxHandler=d;this.ready=true;return this},ready:false,init:function(e){if(this.ready){var d=new c(this.ajaxHandler);d.load(e)}else{console.log("$.wysiwyg.fileManager: Must set ajax handler first, using $.wysiwyg.fileManager.setAjaxHandler()");return false}}};b.wysiwyg.plugin.register(a);function c(e){this.handler=e;this.loaded=false;this.move=false;this.rename=false;this.remove=false;this.upload=false;this.mkdir=false;this.baseUrl="";this.selectedFile="";this.curDir="/";this.curListHtml="";var d=b.wysiwyg.console;d.log(this.handler);this.load=function(g){var f=this;f.loaded=true;f.authenticate(function(h){if(h!=="success"){alert(h);return false}f.loadDir("/",function(j){var l='<div class="wysiwyg-files-wrapper"><input style="display:none;" type="text" name="url" /><div id="wysiwyg-files-list-wrapper">'+j+"</div>";if(f.upload.enabled){l+='<div class="wysiwyg-files-action-upload" title="{{upload_action}}"></div>'}if(f.mkdir.enabled){l+='<div class="wysiwyg-files-action-mkdir" title="{{mkdir_action}}"></div>'}l+='<input style="display:none;" type="button" name="submit" value="{{select}}" /></div>';l=f.i18n(l);if(b.wysiwyg.dialog){var k=f.i18n("{{file_manager}}");var i=new b.wysiwyg.dialog(e,{title:k,content:l,close:function(){var n=b(".wysiwyg-dialog-content").find(".wysiwyg-files-wrapper");b(".wysiwyg-files-action-rename").die("click");b(".wysiwyg-files-action-remove").die("click");n.find("li").die("mouseenter");n.find("li").die("mouseleave");n.find("li").find("a").die("click");var m=n.find("li.wysiwyg-files-png, li.wysiwyg-files-jpg, li.wysiwyg-files-jpeg, li.wysiwyg-files-gif, li.wysiwyg-files-ico, li.wysiwyg-files-bmp");m.die("mouseenter");m.die("mouseleave");m.die("mouseover");n.find("input[name=submit]").die("click");n.find("li.wysiwyg-files-file").die("dblclick")},open:function(o,n){var m=b(".wysiwyg-dialog-content").find(".wysiwyg-files-wrapper");m.find("li").live("mouseenter",function(){b(this).addClass("wysiwyg-files-hover");if(b(this).hasClass("wysiwyg-files-dir")){b(this).addClass("wysiwyg-files-dir-expanded")}if(!b(this).hasClass("wysiwyg-files-dir-prev")){b(".wysiwyg-files-action").remove();if(f.remove.enabled){var q=f.i18n("{{remove_action}}");b("<div/>",{"class":"wysiwyg-files-action wysiwyg-files-action-remove",title:q}).appendTo(this)}if(f.rename.enabled){var p=f.i18n("{{rename_action}}");b("<div/>",{"class":"wysiwyg-files-action wysiwyg-files-action-rename",title:p}).appendTo(this)}}}).live("mouseleave",function(){b(this).removeClass("wysiwyg-files-dir-expanded");b(this).removeClass("wysiwyg-files-hover");b(".wysiwyg-files-action").remove()});m.find("li").find("a").live("click",function(p){f.selectedFile=b(this).attr("rel");b(".wysiwyg-files-wrapper").find("li").css("backgroundColor","#FFF");if(b(this).parent("li").hasClass("wysiwyg-files-dir")){f.selectedFile="";m.find("input[name=submit]").hide();b(".wysiwyg-files-wrapper").find("input[name=url]").val("");b("#wysiwyg-files-list-wrapper").addClass("wysiwyg-files-ajax");b("#wysiwyg-files-list-wrapper").html("");f.loadDir(b(this).attr("rel"),function(q){b("#wysiwyg-files-list-wrapper").html(q);b("#wysiwyg-files-list-wrapper").removeClass("wysiwyg-files-ajax")});m.find("input[name=submit]").hide()}else{f.selectedFile=b(this).text();b(this).parent("li").css("backgroundColor","#BDF");b(".wysiwyg-files-wrapper").find("input[name=url]").val(b(this).attr("rel"));m.find("input[name=submit]").trigger("click");b("img.wysiwyg-files-file-preview").remove()}});m.find("input[name=submit]").live("click",function(){var p=f.baseUrl+m.find("input[name=url]").val();i.close();f.loaded=false;g(p)});m.find("li.wysiwyg-files-png, li.wysiwyg-files-jpg, li.wysiwyg-files-jpeg, li.wysiwyg-files-gif, li.wysiwyg-files-ico, li.wysiwyg-files-bmp").live("mouseenter",function(){var p=b(this);b("<img/>",{"class":"wysiwyg-files-ajax wysiwyg-files-file-preview",src:f.baseUrl+p.find("a").attr("rel"),alt:p.text()}).appendTo("body");b("img.wysiwyg-files-file-preview").load(function(){b(this).removeClass("wysiwyg-files-ajax")})}).live("mousemove",function(p){b("img.wysiwyg-files-file-preview").css("left",p.pageX+15);b("img.wysiwyg-files-file-preview").css("top",p.pageY)}).live("mouseleave",function(){b("img.wysiwyg-files-file-preview").remove()});b(".wysiwyg-files-action-remove").live("click",function(t){t.preventDefault();var r=b(this).parent("li");var p=r.hasClass("wysiwyg-files-file")?"file":"dir";var u='<p>{{delete_message}}</p><div class=""><input type="button" name="cancel" value="{{no}}" /><input type="button" name="remove" value="{{yes}}" /></div>';u=f.i18n(u);var s=f.i18n("{{remove_title}}");var q=new b.wysiwyg.dialog(null,{title:s,content:u,close:function(){},open:function(w,v){v.find("input[name=remove]").bind("click",function(){var x=(p==="file")?r.find("a").text():r.find("a").attr("rel");f.removeFile(p,x,function(y){f.loadDir(f.curDir,function(z){b("#wysiwyg-files-list-wrapper").html(z)});q.close()})});v.find("input[name=cancel]").bind("click",function(){q.close()})}});q.open()});b(".wysiwyg-files-action-rename").live("click",function(t){t.preventDefault();var q=b(this).parent("li");var p=q.hasClass("wysiwyg-files-file")?"file":"dir";var u='<div><input type="text" class="wysiwyg-files-textfield" name="newName" value="'+q.find("a").text()+'" /><input type="button" name="cancel" value="{{cancel}}" /><input type="button" name="rename" value="{{rename}}" /></div>';u=f.i18n(u);var s=f.i18n("{{rename_title}}");var r=new b.wysiwyg.dialog(null,{title:s,content:u,close:function(){},open:function(w,v){v.find("input[name=rename]").bind("click",function(){var x=(p==="file")?q.find("a").text():q.find("a").attr("rel");f.renameFile(p,x,v.find("input[name=newName]").val(),function(y){f.loadDir(f.curDir,function(z){b("#wysiwyg-files-list-wrapper").html(z)});r.close()})});v.find("input[name=cancel]").bind("click",function(){r.close()})}});r.open()});b(".wysiwyg-files-action-mkdir").bind("click",function(q){q.preventDefault();var s='<div><input type="text" class="wysiwyg-files-textfield" name="newName" value="{{new_directory}}" /><input type="button" name="cancel" value="{{cancel}}" /><input type="button" name="create" value="{{create}}" /></div>';s=f.i18n(s);var r=f.i18n("{{mkdir_title}}");var p=new b.wysiwyg.dialog(null,{title:r,content:s,close:function(){},open:function(u,t){t.find("input[name=create]").bind("click",function(){f.mkDir(t.find("input[name=newName]").val(),function(v){f.loadDir(f.curDir,function(w){b("#wysiwyg-files-list-wrapper").html(w)});p.close()})});t.find("input[name=cancel]").bind("click",function(){p.close()})}});p.open()});b(".wysiwyg-files-action-upload").bind("click",function(p){f.loadUploadUI()})}});i.open()}else{throw"$.wysiwyg.fileManager: Can't find a working '.dialog()' lib."}})})};this.authenticate=function(g){if(!this.loaded){return false}var f=this;b.getJSON(f.handler,{action:"auth",auth:"jwysiwyg"},function(h){if(h.success){f.move=h.data.move;f.rename=h.data.rename;f.remove=h.data.remove;f.mkdir=h.data.mkdir;f.upload=h.data.upload;f.baseUrl=h.data.baseUrl;g("success")}else{d.log("$.wysiwyg.fileManager: Unable to authenticate handler.");g(h.error)}})};this.loadDir=function(g,h){if(!this.loaded){return false}var f=this;f.curDir=g.replace(/\/$/,"")+"/";b.getJSON(f.handler,{dir:f.curDir,action:"list"},function(i){if(i.success){h(f.listDir(i))}else{alert(i.error)}})};this.listDir=function(h){if(!this.loaded){return false}var f=this;var i='<ul class="wysiwyg-files-list">';if(f.curDir!=="/"){var g=f.curDir.replace(/[^\/]+\/?$/,"");i+='<li class="wysiwyg-files-dir wysiwyg-files-dir-prev"><a href="#" rel="'+g+'" title="{{previous_directory}}">'+f.curDir+"</a></li>"}b.each(h.data.directories,function(j,k){i+='<li class="wysiwyg-files-dir"><a href="#" rel="'+k+'">'+j+"</a></li>"});b.each(h.data.files,function(k,j){var l=k.replace(/^.*?\./,"").toLowerCase();i+='<li class="wysiwyg-files-file wysiwyg-files-'+l+'"><a href="#" rel="'+j+'">'+k+"</a></li>"});i+="</ul>";return f.i18n(i)};this.removeFile=function(h,g,i){if(!this.loaded){return false}if(!this.remove.enabled){d.log("$.wysiwyg.fileManager: handler: remove is disabled.");return false}var f=this;b.getJSON(f.remove.handler,{action:"remove",type:h,dir:f.curDir,file:g},function(j){if(j.success){alert(j.data)}else{alert(j.error)}i(j)})};this.renameFile=function(i,h,f,j){if(!this.loaded){return false}if(!this.rename.enabled){d.log("$.wysiwyg.fileManager: handler: rename is disabled.");return false}var g=this;b.getJSON(g.rename.handler,{action:"rename",type:i,dir:g.curDir,file:h,newName:f},function(k){if(k.success){alert(k.data)}else{alert(k.error)}j(k)})};this.mkDir=function(f,h){if(!this.loaded){return false}if(!this.mkdir.enabled){d.log("$.wysiwyg.fileManager: handler: mkdir is disabled.");return false}var g=this;b.getJSON(g.mkdir.handler,{action:"mkdir",dir:g.curDir,newName:f},function(i){if(i.success){alert(i.data)}else{alert(i.error)}h(i)})};this.moveFile=function(){if(!this.loaded){return false}if(!this.move.enabled){d.log("$.wysiwyg.fileManager: handler: move is disabled.");return false}var f=this;return false};this.getCSRF=function(){var l=null;var g="csrftoken";if(document.cookie&&document.cookie!=""){var k=document.cookie.split(";");for(var j=0;j<k.length;j++){var h=jQuery.trim(k[j]);if(h.substring(0,g.length+1)==(g+"=")){l=decodeURIComponent(h.substring(g.length+1));break}}}var f=this;return l};this.loadUploadUI=function(){if(!this.loaded){return false}if(!this.upload.enabled){d.log("$.wysiwyg.fileManager: handler: move is disabled.");return false}var g=this;var i='<form enctype="multipart/form-data" method="post" action="'+g.upload.handler+'"><input type="hidden" name="csrfmiddlewaretoken" value="'+g.getCSRF()+'" /><p><input type="file" name="handle" /><br><input type="text" name="newName" style="width:250px; border:solid 1px !important;" /><br><input type="text" name="action" style="display:none;" value="upload" /><br></p><input type="text" name="dir" style="display:none;" value="'+g.curDir+'" /></p><input type="submit" name="submit" value="{{submit}}" /></form>';i=g.i18n(i);var f=g.i18n("{{upload_title}}");var h=new b.wysiwyg.dialog(null,{title:f,content:"",open:function(k,j){b("<iframe/>",{"class":"wysiwyg-files-upload"}).load(function(){var l=b(this).contents();l.find("body").append(i);l.find("input[type=file]").change(function(){var m=b(this).val();m=m.replace(/.*[\\\/]/,"");l.find("input[name=newName]").val(m)})}).appendTo(j.find(".wysiwyg-dialog-content"))},close:function(){g.loadDir(g.curDir,function(j){b("#wysiwyg-files-list-wrapper").html(j)})}});h.open()};this.defaultTranslations={file_manager:"File Manager",upload_title:"Upload File",rename_title:"Rename File",remove_title:"Remove File",mkdir_title:"Create Directory",upload_action:"Upload new file to current directory",mkdir_action:"Create new directory",remove_action:"Remove this file",rename_action:"Rename this file",delete_message:"Are you sure you want to delete this file?",new_directory:"New Directory",previous_directory:"Go to previous directory",rename:"Rename",select:"Select",create:"Create",submit:"Submit",cancel:"Cancel",yes:"Yes",no:"No"};this.i18n=function(f){var g=this.defaultTranslations;if(b.wysiwyg.i18n){b.each(g,function(h,i){g[h]=b.wysiwyg.i18n.t(h,"dialogs.fileManager")})}b.each(g,function(h,i){f=f.replace("{{"+h+"}}",i)});return f}}})(jQuery);