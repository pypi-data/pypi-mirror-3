<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <title>pyTenjin User's Guide</title>
  <meta name="generator" content="kwaser">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <link rel="stylesheet" href="docstyle.css" type="text/css">
</head>

<body>
  <blockquote>
    <div class="mainbody">
      <div align="left">
        <h1>pyTenjin User's Guide</h1>
      </div>

      <div align="left">
        release: 1.1.1<br>
      </div>

      <div class="note"><span class="caption">NOTE:</span>

      <ul type="disc">
        <li>pyTenjin now supports indent-free syntax since version 1.0.0. See <a href="#render-template">this section</a> for details.</li>

        <li>New embedded notation (<code>{=...=}</code> and <code>{==...==}</code>) is available since version 1.0.0. See <a href="#render-template">this section</a> for details.</li>

        <li>Since 1.1.0, it is possible to include pair of '<code>{</code>' and '<code>}</code>' inside of '<code>${...}</code>' or '<code>#{...}</code>'. See <a href="#template-syntax">this section</a>.</li>
      </ul>

      </div>

      <div class="toc"><span class="caption">Table of Contents:</span>

      <ul>
        <li>
          <a href="#overview">Overview</a>

          <ul>
            <li><a href="#features">Features</a></li>

            <li><a href="#install">Install</a></li>

            <li><a href="#benchmark">Benchmark</a></li>
          </ul>
        </li>

        <li>
          <a href="#basic-examples">Basic Examples</a>

          <ul>
            <li><a href="#template-syntax">Template Syntax</a></li>

            <li><a href="#render-template">Render Template</a></li>

            <li><a href="#source-code">Show Converted Source Code</a></li>

            <li><a href="#layout-template">Layout Template</a></li>

            <li><a href="#context-variables">Context Variables</a></li>

            <li><a href="#template-arguments">Template Arguments</a></li>

            <li><a href="#partial-template">Include Partial Template</a></li>

            <li><a href="#template-short-name">Template Short Name</a></li>

            <li>
              <a href="#template-encoding">Template Encoding</a>

              <ul>
                <li><a href="#template-encoding-py2">Python 2.x</a></li>

                <li><a href="#template-encoding-py3">Python 3.x</a></li>
              </ul>
            </li>

            <li>
              <a href="#helper-functions">Helper Function</a>

              <ul>
                <li><a href="#tenjin-helpers">tenjin.helpers module</a></li>

                <li><a href="#tenjin-escaped">tenjin.escaped module</a></li>

                <li><a href="#tenjin-helpers-html">tenjin.html module</a></li>
              </ul>
            </li>
          </ul>
        </li>

        <li>
          <a href="#advanced-features">Advanced Features</a>

          <ul>
            <li><a href="#auto-escaping">Auto-escaping</a></li>

            <li><a href="#nested-layout-template">Nested Layout Template</a></li>

            <li><a href="#trace">Trace Templates</a></li>

            <li><a href="#capturing">Capturing</a></li>

            <li><a href="#templace-cache">Template Cache</a></li>

            <li><a href="#fragment-cache">Fragment Cache</a></li>

            <li><a href="#logging">Logging</a></li>

            <li><a href="#google-appengine">Google App Engine Support</a></li>

            <li><a href="#m17n">M17N Page</a></li>
          </ul>
        </li>

        <li>
          <a href="#preprocessing">Preprocessing</a>

          <ul>
            <li><a href="#preprocessing-whatis">What is Preprocessing?</a></li>

            <li><a href="#TrimPreprocessor">TrimPreprocessor class</a></li>

            <li><a href="#PrefixedLinePreprocessor">PrefixedLinePreprocessor class</a></li>

            <li><a href="#JavaScriptPreprocessor">JavaScriptPreprocessor class</a></li>

            <li>
              <a href="#TemplatePreprocessor">TemplatePreprocessor class</a>

              <ul>
                <li><a href="#preprocessing-loop-expantion">Loop Expantion</a></li>

                <li><a href="#preprocessing-parameters">Parameters</a></li>
              </ul>
            </li>
          </ul>
        </li>

        <li>
          <a href="#tips">Tips</a>

          <ul>
            <li><a href="#function-names">Specify Function Names of escape() and to_str()</a></li>

            <li><a href="#tips-webext">Webext</a></li>

            <li><a href="#tips-template-inheritance">Template Inheritance</a></li>

            <li><a href="#tips-template-file-suffix">Template File Suffix</a></li>
          </ul>
        </li>

        <li>
          <a href="#command"><code>pytenjin</code> Command</a>

          <ul>
            <li><a href="#command-syntax-check">Syntax Check</a></li>

            <li><a href="#command-convert-script">Convert Template into Python Script</a></li>

            <li><a href="#command-retrieve">Retrieve Embedded Code</a></li>

            <li><a href="#command-execute-template">Execute Template File</a></li>

            <li><a href="#command-context-data">Context Data</a></li>
          </ul>
        </li>

        <li>
          <a href="#shooting">Trouble shooting</a>

          <ul>
            <li><a href="#syntax-error">I got an SyntaxError exception.</a></li>

            <li><a href="#encoding-syntaxerr">I got 'SyntaxError: encoding declaration in Unicode string'</a></li>

            <li><a href="#encoding-unicodedecodeerror">I got UnicodeDecodeError, but I can't find what is wrong</a></li>

            <li><a href="#NameError:%20global%20name%20'xxxx'%20is%20not%20defined">NameError: global name 'xxxx' is not defined</a></li>
          </ul>
        </li>

        <li>
          <a href="#customize">Customization Examples</a>

          <ul>
            <li><a href="#customize-encoding">Template Encoding</a></li>

            <li><a href="#customize-escapefunc">Escaping Function</a></li>

            <li><a href="#customize-tostr">Change Behaviour of <code>to_str()</code></a></li>

            <li><a href="#customize-notation">Embedded Notation</a></li>

            <li><a href="#customize-safetemplate">Custom Safe Template</a></li>

            <li><a href="#customize-helper">Custom Html Helper Function</a></li>

            <li><a href="#customize-templateclass">Switch Default Template Class</a></li>

            <li><a href="#customize-loader">Change Template Loader</a></li>

            <li><a href="#customize-cachestorage">Change Template Cache Storage</a></li>

            <li><a href="#customize-kvstore">Change Fragment Cache Store</a></li>
          </ul>
        </li>
      </ul>

      </div><a name="overview" id="overview"></a>

      <h2 class="section1">Overview</h2>

      <p>Tenjin is a very fast and full-featured template engine implemented in pure Python.</p><a name="features" id="features"></a>

      <h3 class="section2">Features</h3>

      <ul type="disc">
        <li>
          <a href="#benchmark">Very fast</a>

          <ul type="circle">
            <li>About 10 times faster than Django template</li>

            <li>About 4 times faster than Cheetah</li>

            <li>About 2 times faster than Mako</li>

            <li><a href="#auto-escaping">Auto-escaping</a></li>
          </ul>
        </li>

        <li>Full featured

          <ul type="circle">
            <li><a href="#layout-template">Layout template</a></li>

            <li><a href="#partial-template">Partial template</a></li>

            <li><a href="#fragment-cache">Fragment cache</a></li>

            <li><a href="#capturing">Capturing</a></li>

            <li><a href="#preprocessing">Preprocessing</a></li>

            <li><a href="#m17n">M17N Support</a></li>
          </ul>
        </li>

        <li>Easy to learn

          <ul type="circle">
            <li>Because you can embed any python statements or expression in your template files</li>

            <li>You don't have to study template-specific language</li>
          </ul>
        </li>

        <li>Compact

          <ul type="circle">
            <li>Less than 2000 lines of code</li>

            <li>Very ligthweight to load module (important for CGI script and Google App Engine)</li>
          </ul>
        </li>

        <li><a href="#google-appengine">Supports Google App Engine</a></li>
      </ul><br>
      <a name="install" id="install"></a>

      <h3 class="section2">Install</h3>

      <p>pyTenjin supports Python 2.4 or later. Python 3 is also supported.</p>
      <pre class="terminal">
$ sudo easy_install Tenjin
</pre>

      <p>Or:</p>
      <pre class="terminal">
$ wget http://pypi.python.org/packages/source/T/Tenjin/Tenjin-X.X.X.tar.gz
$ tar xzf Tenjin-X.X.X.tar.gz
$ cd Tenjin-X.X.X/
$ sudo python setup.py install
</pre><br>
      <a name="benchmark" id="benchmark"></a>

      <h3 class="section2">Benchmark</h3>

      <p>Tenjin package contains benchmark program.</p>

      <div class="terminal_caption">
        MacOS X 10.6 Snow Leopard, Intel CoreDuo2 2GHz, Memory 2GB
      </div>
      <pre class="terminal">
$ cd pytenjin-X.X.X/benchmark
$ python -V
Python 2.5.5
$ python bench.py -q -n 10000
compiling bench_cheetah.tmpl ... Compiling bench_cheetah.tmpl -&gt; bench_cheetah.py (backup bench_cheetah.py.bak)
*** loading context data (file=bench_context.py)...
*** start benchmark
*** ntimes=10000
                                    utime     stime     total      real
tenjin                             3.7200    0.0300    3.7500    3.7593
tenjin-create                      4.7400    0.5800    5.3200    5.3128
tenjin-str                         2.4100    0.0300    2.4400    2.4326
tenjin-webext                      2.3700    0.0300    2.4000    2.4010
django                            87.3400    0.0700   87.4100   87.5328
django-create                    100.9000    0.3900  101.2900  101.4446
cheetah                           17.7300    0.0200   17.7500   17.7837
cheetah-create                    18.1300    0.0200   18.1500   18.2052
kid                              288.7300    0.3000  289.0300  289.3852
kid-create                       289.6800    0.4300  290.1100  290.5570
genshi                           179.2200    0.1700  179.3900  179.5859
genshi-create                    323.8500    0.9900  324.8400  325.2915
mako                               7.0000    0.0100    7.0100    7.0107
mako-create                        9.8100    0.8100   10.6200   10.6372
mako-nocache                     113.0900    0.5900  113.6800  113.7866
templetor                         10.6600    0.0100   10.6700   11.0737
templetor-create                 302.3700    1.8300  304.2000  304.6179
jinja2                             7.8900    0.0600    7.9500    7.9514
jinja2-create                    129.1300    0.7200  129.8500  130.6778
</pre>

      <p>Versions:</p>

      <ul type="disc">
        <li>Python 2.5.5</li>

        <li>Tenjin 0.9.0</li>

        <li>Django 1.1.0</li>

        <li>Cheetah 2.2.2</li>

        <li>Kid 0.9.6</li>

        <li>Genshi 0.5.1</li>

        <li>Mako 0.2.5</li>

        <li>Templetor (web.py) 0.32</li>

        <li>Jinja2 2.2.1</li>
      </ul>

      <p>This shows the followings.</p>

      <ul type="disc">
        <li>Tenjin is the fastest template engine.</li>

        <li>Cheetah's performance is good.</li>

        <li>Django's performance is not good.</li>

        <li>Kid's performance is worse. It is too slow.</li>

        <li>Genshi's performance is also worse. It is faster than Kid, but slower than others.</li>

        <li>Mako's performance is very good when module caching is enabled.</li>

        <li>Templetor's performance is not good for mod_python and worse for CGI program.</li>

        <li>Jinja's performance is very good if you can cache template object, but sad performance for CGI program.</li>
      </ul><br>
      <br>
      <a name="basic-examples" id="basic-examples"></a>

      <h2 class="section1">Basic Examples</h2>

      <p>This section describes basics of Tenjin.</p><a name="template-syntax" id="template-syntax"></a>

      <h3 class="section2">Template Syntax</h3>

      <p>Notation:</p>

      <dl class="dl1">
        <dt class="dt1"><code>&lt;?py ... ?&gt;</code></dt>

        <dd class="dd1">Python statements</dd>

        <dt class="dt1"><code>${...}</code> or <code>{=...=}</code></dt>

        <dd class="dd1">Python expression (with HTML escape)</dd>

        <dt class="dt1"><code>#{...}</code> or <code>{==...==}</code></dt>

        <dd class="dd1">Python expression (without HTML escape)</dd>
      </dl>

      <div class="note"><span class="caption">NOTE:</span>

      <p>Since version 1.0.0, pyTenjin provides <code>{=...=}</code> and <code>{==...==}</code> for embedded expression as well as <code>${...}</code> and <code>#{...}</code>. This is for:</p>

      <ul type="disc">
        <li><s>Conveniency: <code>${_('Hello {}!').format(name)}</code> is NG (because '}' appears in <code>${...}</code>) but <code>{=_('Hello {}!').format(name)=}</code> is OK.</s> Since pyTenjin 1.1.0, it is possible to include pair of '<code>{</code>' and '<code>}</code>' inside of '<code>${...}</code>' or '<code>#{...}</code>'.</li>

        <li>Security: you may take a mistake to write <code>#{...}</code> instead of <code>${...}</code> easily because they are similar, but you will not confuse between <code>{=...=}</code> and <code>{==...==}</code> because the latter is MUCH longer then the former!</li>
      </ul>

      </div>

      <div class="note"><span class="caption">NOTE:</span>

      <p>Since version 1.1.0, <code>${...}</code> and <code>#{...}</code> can contain pair of '<code>{</code>' and '<code>}</code>' limitedly. See the following example::</p>
      <pre class="program">
## OK
${foo({'x':1})}
${foo({'x':1}) + bar({'y':2})}
${foo({}, {}, {})}
## NG
${foo({'x': {'y': {}}})}
</pre>

      </div><a name="test_010/views/page.pyhtml"></a>

      <div class="program_caption">
        views/page.pyhtml: html template
      </div>
      <pre class="program">
&lt;h2&gt;<strong>${title}</strong>&lt;/h2&gt;
&lt;table&gt;
  <strong>&lt;?py i = 0 ?&gt;</strong>
  <strong>&lt;?py for item in items: ?&gt;</strong>
  <strong>&lt;?py     i += 1 ?&gt;</strong>
  <strong>&lt;?py     klass = i % 2 and 'odd' or 'even' ?&gt; </strong>
  &lt;tr class="<strong>#{klass}</strong>"&gt;
    &lt;td&gt;<strong>${item}</strong>&lt;/td&gt;
  &lt;/tr&gt;
  <strong>&lt;?py #endfor ?&gt;</strong>
&lt;/table&gt;
</pre>

      <p>You can write any Python statements or expression in yor template file, but there are several restrictions.</p>

      <ul type="disc">
        <li><strong>It is necessary to close 'for', 'if', 'while', ... by corresponding '#endfor', '#endif', '#endwhile', and so on.</strong> Notice that '#end' is almighty closer.</li>

        <li><strong>Indentation is not necessary</strong> since version 1.0.0.</li>

        <li>Conditional expression of 'if', 'while', ... should be in a line.</li>

        <li>'#' (comment) after ':' or '#endXXX' are not allowed.</li>
      </ul>

      <div class="program_caption">
        Examples
      </div>
      <pre class="program">
## [OK] Indentation is not necessary.
&lt;?py for x in nums: ?&gt;
&lt;?py if x &gt; 0: ?&gt;
&lt;p&gt;Positive.&lt;/p&gt;
&lt;?py elif x &lt; 0: ?&gt;
&lt;p&gt;Negative.&lt;/p&gt;
&lt;?py else: ?&gt;
&lt;p&gt;Zero.&lt;/p&gt;
&lt;?py #endif ?&gt;
&lt;?py #endfor ?&gt;

## [NG] conditional expression of 'if' is not in a line
&lt;?py if re.search(r'^\[(\w+)\]',?&gt;
&lt;?py              line, re.M): ?&gt;
&lt;p&gt;matched.&lt;/p&gt;
&lt;?py #endif ?&gt;

## [NG] there is a comment after ':' and '#endfor'
&lt;ul&gt;
&lt;?py if item in items:   ## beginning of loop ?&gt;
  &lt;li&gt;${item}&lt;/li&gt;
&lt;?py #endfor             ## end of loop ?&gt;
&lt;/ul&gt;
</pre>

      <div class="tips"><span class="caption">TIPS:</span>

      <p>You can check template syntax by 'pytenjin -z'.</p><a name="test_011/result.output"></a>

      <div class="terminal_caption">
        Syntax check of template files
      </div>
      <pre class="terminal">
$ pytenjin <strong>-z</strong> views/*.pyhtml
views/page.pyhtml - ok.
</pre>

      </div><br>
      <a name="render-template" id="render-template"></a>

      <h3 class="section2">Render Template</h3>

      <p>This is an example code to render template file.</p><a name="test_010/main.py"></a>

      <div class="program_caption">
        main.py: main program
      </div>
      <pre class="program">
## import modules and helper functions
<strong>import tenjin</strong>
#tenjin.set_template_encoding('cp932')   # template encoding
<strong>from tenjin.helpers import *</strong>

## context data
context = {
    'title': 'Tenjin Example',
    'items': ['&lt;AAA&gt;', 'B&amp;B', '"CCC"'],
}

## create engine object
<strong>engine = tenjin.Engine(path=['views'])</strong>

## render template with context data
html = <strong>engine.render('page.pyhtml', context)</strong>
print(html)
</pre><a name="test_010/result.output"></a>

      <div class="terminal_caption">
        result
      </div>
      <pre class="terminal">
$ python main.py
&lt;h2&gt;Tenjin Example&lt;/h2&gt;
&lt;table&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;lt;AAA&amp;gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="even"&gt;
    &lt;td&gt;B&amp;amp;B&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;quot;CCC&amp;quot;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

</pre>

      <p>If you want to specify template encoding, call <code>tenjin.set_template_encoding()</code>. Default encoding is 'utf-8'. See <a href="#template-encoding">Template Encoding</a> section for details.</p><br>
      <a name="source-code" id="source-code"></a>

      <h3 class="section2">Show Converted Source Code</h3>

      <p>pyTenjin converts template files into Python script and executes it. Compiled Python script is saved into cache file automatically in text format.</p>

      <div class="terminal_caption">
        Show cached file
      </div>
      <pre class="terminal">
$ ls views/page.pyhtml*
views/page.pyhtml       views/page.pyhtml.cache
$ file views/page.pyhtml.cache
views/page.pyhtml.cache: text
</pre>

      <p>You can get converted script by '<code>pytenjin -s</code>'.</p><a name="test_020/result.output"></a>

      <div class="terminal_caption">
        Show Python code
      </div>
      <pre class="terminal">
$ pytenjin <strong>-s</strong> views/page.pyhtml
_buf = []; _extend=_buf.extend;_to_str=to_str;_escape=escape; _extend(('''&lt;h2&gt;''', _escape(_to_str(title)), '''&lt;/h2&gt;
&lt;table&gt;\n''', ));
i = 0
for item in items:
    i += 1
    klass = i % 2 and 'odd' or 'even'
    _extend(('''  &lt;tr class="''', _to_str(klass), '''"&gt;
    &lt;td&gt;''', _escape(_to_str(item)), '''&lt;/td&gt;
  &lt;/tr&gt;\n''', ));
#endfor
_extend(('''&lt;/table&gt;\n''', ));
print(''.join(_buf))
</pre>

      <p>If you specify '<code>-sb</code>' instead of '<code>-s</code>', neither preamble (= '<code>_buf = [];</code>') nor postamble (= '<code>print("".join(_buf))</code>') are printed. See <a href="#command-retrieve">Retrieve Embedded Code</a> section for more information.</p>

      <p>Or:</p><a name="test_021/main.py"></a>

      <div class="program_caption">
        How to convert template file into Python script
      </div>
      <pre class="program">
import tenjin
template = tenjin.Template('views/page.pyhtml')
print(template.script)

### or:
#template = tenjin.Template()
#with open('views/page.pyhtml') as f:
#    print(template.convert(f.read(), 'views/page.pyhtml'))

### or:
#engine = tenjin.Engine(path=['views'])
#print(engine.get_template('page.pyhtml').script)
</pre><br>
      <a name="layout-template" id="layout-template"></a>

      <h3 class="section2">Layout Template</h3>

      <p>Layout template will help you to use common HTML design for all pages.</p><a name="test_030/views/_layout.pyhtml"></a>

      <div class="program_caption">
        views/_layout.pyhtml
      </div>
      <pre class="program">
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;${title}&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
<strong>#{_content}</strong>
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_030/main.py"></a>

      <div class="program_caption">
        main.py
      </div>
      <pre class="program">
## import modules and helper functions
import tenjin
from tenjin.helpers import *

## context data
context = {
    'title': 'Tenjin Example',
    'items': ['&lt;AAA&gt;', 'B&amp;B', '"CCC"'],
}

## cleate engine object
engine = tenjin.Engine(path=['views']<strong>, layout='_layout.pyhtml'</strong>)

## render template with context data
html = engine.render('page.pyhtml', context)
print(html)
</pre><a name="test_030/result.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ python main.py
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;Tenjin Example&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
&lt;h2&gt;Tenjin Example&lt;/h2&gt;
&lt;table&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;lt;AAA&amp;gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="even"&gt;
    &lt;td&gt;B&amp;amp;B&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;quot;CCC&amp;quot;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

  &lt;/body&gt;
&lt;/html&gt;

</pre>

      <p>You can specify other layout template file with <code>render()</code> method.</p>
      <pre class="program">
## use other layout template file
engine.render('page.pyhtml', context, <strong>layout='_other_layout.pyhtml'</strong>)

## don't use layout template file
engine.render('page.pyhtml', context, <strong>layout=False</strong>)
</pre>

      <p>Tenjin supports nested layout template. See <a href="#nested-layout-template">Nested Layout Template</a> section for details.</p><br>
      <a name="context-variables" id="context-variables"></a>

      <h3 class="section2">Context Variables</h3>

      <p>'<code>_context</code>' dictionary contains context data which are passed from main program into template file.</p>

      <p>Using '<code>_context</code>' dictionary, you can pass any data from template file to main program or layout template file.</p><a name="test_040/views/_layout.pyhtml"></a>

      <div class="program_caption">
        views/_layout.pyhtml
      </div>
      <pre class="program">
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;<strong>${page_title}</strong>&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
#{_content}
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_040/views/page.pyhtml"></a>

      <div class="program_caption">
        views/page.pyhtml: pass page title date from template to layout template
      </div>
      <pre class="program">
<strong>&lt;?py _context['page_title'] = 'Tenjin: Layout Template Example' ?&gt;</strong>
&lt;h2&gt;${title}&lt;/h2&gt;
&lt;table&gt;
&lt;?py i = 0 ?&gt;
&lt;?py for item in items: ?&gt;
&lt;?py     i += 1 ?&gt;
&lt;?py     klass = i % 2 and 'odd' or 'even' ?&gt;
  &lt;tr class="#{klass}"&gt;
    &lt;td&gt;${item}&lt;/td&gt;
  &lt;/tr&gt;
&lt;?py #endfor ?&gt;
&lt;/table&gt;
</pre><a name="test_040/result.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ python main.py
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;<strong>Tenjin: Layout Template Example</strong>&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
&lt;h2&gt;Tenjin Example&lt;/h2&gt;
&lt;table&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;lt;AAA&amp;gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="even"&gt;
    &lt;td&gt;B&amp;amp;B&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;quot;CCC&amp;quot;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

  &lt;/body&gt;
&lt;/html&gt;

</pre><br>
      <a name="template-arguments" id="template-arguments"></a>

      <h3 class="section2">Template Arguments</h3>

      <p>For readability, it is recommended to declare context variables in your template files.</p><a name="test_050/views/page.pyhtml"></a>

      <div class="program_caption">
        views/page.pyhtml
      </div>
      <pre class="program">
<strong>&lt;?py #@ARGS title, items ?&gt;</strong>
&lt;?py _context['page_title'] = 'Tenjin: Layout Template Example' ?&gt;
&lt;h2&gt;${title}&lt;/h2&gt;
&lt;table&gt;
&lt;?py i = 0 ?&gt;
&lt;?py for item in items: ?&gt;
&lt;?py     i += 1 ?&gt;
&lt;?py     klass = i % 2 and 'odd' or 'even' ?&gt; 
  &lt;tr class="#{klass}"&gt;
    &lt;td&gt;${item}&lt;/td&gt;
  &lt;/tr&gt;
&lt;?py #endfor ?&gt;
&lt;/table&gt;
</pre><a name="test_050/result.output"></a>

      <div class="terminal_caption">
        Converted Python script
      </div>
      <pre class="terminal">
$ pytenjin -sb views/page.pyhtml
_extend=_buf.extend;_to_str=to_str;_escape=escape; <strong>title = _context.get('title'); items = _context.get('items'); </strong>
_context['page_title'] = 'Tenjin: Layout Template Example'
_extend(('''&lt;h2&gt;''', _escape(_to_str(title)), '''&lt;/h2&gt;
&lt;table&gt;\n''', ));
i = 0
for item in items:
    i += 1
    klass = i % 2 and 'odd' or 'even'
    _extend(('''  &lt;tr class="''', _to_str(klass), '''"&gt;
    &lt;td&gt;''', _escape(_to_str(item)), '''&lt;/td&gt;
  &lt;/tr&gt;\n''', ));
#endfor
_extend(('''&lt;/table&gt;\n''', ));
</pre><a name="test_051/views/_layout.pyhtml"></a>

      <div class="program_caption">
        views/_layout.pyhtml
      </div>
      <pre class="program">
<strong>&lt;?py #@ARGS _content, page_title ?&gt;</strong>
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;${page_title}&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
#{_content}
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_051/result.output"></a>

      <div class="terminal_caption">
        Converted Python script
      </div>
      <pre class="terminal">
$ pytenjin -sb views/_layout.pyhtml
<strong>_content = _context.get('_content'); page_title = _context.get('page_title'); </strong>
_extend=_buf.extend;_to_str=to_str;_escape=escape; _extend(('''&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;''', _escape(_to_str(page_title)), '''&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
''', _to_str(_content), '''
  &lt;/body&gt;
&lt;/html&gt;\n''', ));
</pre>

      <div class="tips"><span class="caption">TIPS:</span>

      <p>If you want to specify default value of context variable, try <code>_context.get('<em>varname</em>', <em>defaultvalue</em>)</code>.</p>
      <pre class="program">
&lt;?py
## if username is not specified, use 'World' as default.
username = <strong>_context.get('username', 'World')</strong>
?&gt;
&lt;p&gt;Hello ${username}&lt;/p&gt;
</pre>

      </div><br>
      <a name="partial-template" id="partial-template"></a>

      <h3 class="section2">Include Partial Template</h3>

      <p>You can include other template files by <code>include()</code> helper function.</p>

      <dl class="dl1">
        <dt class="dt1">include(<em>template-name</em>, <em>**kwargs</em>)</dt>

        <dd class="dd1">Include other template. <em>template-name</em> can be file name or template short name. <em>kwargs</em> is passed to template as local variables.</dd>
      </dl>

      <p>In the following example, layout template includes header and footer templates into it.</p><a name="test_060/views/_layout.pyhtml"></a>

      <div class="program_caption">
        views/_layout.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS _content, page_title ?&gt;
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;${page_title}&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
<strong>&lt;?py include('_header.pyhtml', title=page_title) ?&gt;</strong>
#{_content}
<strong>&lt;?py include('_footer.pyhtml') ?&gt;</strong>
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_060/views/_header.pyhtml"></a>

      <div class="program_caption">
        views/_header.pyhtml
      </div>
      <pre class="program">
<strong>&lt;?py #@ARGS title ?&gt;</strong>
<strong>&lt;div class="header"&gt;</strong>
  <strong>&lt;h1&gt;${title}&lt;/h1&gt;</strong>
<strong>&lt;/div&gt;</strong>
</pre><a name="test_060/views/_footer.pyhtml"></a>

      <div class="program_caption">
        views/_footer.pyhtml
      </div>
      <pre class="program">
<strong>&lt;?py #@ARGS ?&gt;</strong>
<strong>&lt;address&gt;</strong>
  <strong>copyright(c) 2010 kuwata-lab.com all rights reserved</strong>
<strong>&lt;/address&gt;</strong>
</pre>

      <p>Output result shows that header and footer templates are included as you expect.</p><a name="test_060/result.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ python main.py
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;Tenjin: Layout Template Example&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
<strong>&lt;div class="header"&gt;</strong>
  <strong>&lt;h1&gt;Tenjin: Layout Template Example&lt;/h1&gt;</strong>
<strong>&lt;/div&gt;</strong>
&lt;h2&gt;Tenjin Example&lt;/h2&gt;
&lt;table&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;lt;AAA&amp;gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="even"&gt;
    &lt;td&gt;B&amp;amp;B&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;quot;CCC&amp;quot;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

<strong>&lt;address&gt;</strong>
  <strong>copyright(c) 2010 kuwata-lab.com all rights reserved</strong>
<strong>&lt;/address&gt;</strong>
  &lt;/body&gt;
&lt;/html&gt;

</pre><br>
      <a name="template-short-name" id="template-short-name"></a>

      <h3 class="section2">Template Short Name</h3>

      <p>If you set template postfix, you can specify template by short name such as '<code>:page</code>' instead of '<code>page.pyhtml</code>'. Notice that template short name should start with '<code>:</code>'.</p><a name="test_070/main.py"></a>

      <div class="program_caption">
        main.py
      </div>
      <pre class="program">
## import modules and helper functions
import tenjin
from tenjin.helpers import *

## context data
context = {
    'title': 'Tenjin Example',
    'items': ['&lt;AAA&gt;', 'B&amp;B', '"CCC"'],
}

## cleate engine object
engine = tenjin.Engine(path=['views'], <strong>postfix='.pyhtml'</strong>, layout=<strong>':_layout'</strong>)

## render template with context data
html = engine.render(<strong>':page'</strong>, context)
print(html)
</pre><a name="test_070/views/_layout.pyhtml"></a>

      <div class="program_caption">
        views/_layout.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS _content, page_title ?&gt;
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;${page_title}&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
&lt;?py include(<strong>':_header'</strong>, title=page_title) ?&gt;
#{_content}
&lt;?py include(<strong>':_footer'</strong>) ?&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre><br>
      <a name="template-encoding" id="template-encoding"></a>

      <h3 class="section2">Template Encoding</h3>

      <p>If you want to specify encoding name, call <code>tenjin.set_template_encoding('utf-8')</code> in your main program or add magic comment into template file.</p>

      <p>See the following description.</p><a name="template-encoding-py2" id="template-encoding-py2"></a>

      <h4 class="section3">Python 2.x</h4>

      <div class="note"><span class="caption">NOTE:</span>

      <p>It is planned to change pyTenjin to be unicode-based templates in the future release. This is because a lot of O/R Mapper or helper libraries assume string to be unicode object. However pyTenjin will provides users to select str-based or uicode-based by <code>tenjin.set_template_encoding()</code> function.</p>

      </div>

      <p>Tenjin provides two approaches for encoding in Python 2.x.</p>

      <dl class="dl2">
        <dt class="dt2">(A) Binary-based approach (default)</dt>
      </dl>

      <p>Tenjin converts templates into binary string. You can see that converted script uses str instead of unicode.</p>
      <pre class="program">
_extend(('''Hello ''', _to_str(name), '''!''', ))
</pre>

      <p>If you got troubles around encoding in this approach, add magic comment into template files.</p>
      <pre class="program">
<strong>&lt;?py # -*- coding: utf-8 -*- ?&gt;</strong>
&lt;h1&gt;Hello&lt;/h1&gt;
</pre>

      <p>If you want to specify encoding name such as euc-jp or cp932, call <code>tenjin.set_template_encoding(encode='cp932')</code> before importing helper functions.</p>
      <pre class="program">
import tenjin
<strong>tenjin.set_template_encoding(encode='cp932')</strong>   # or shift_jis
from tenjin.helpers import *
   # ex. to_str(<strong>u</strong>'日本語') =&gt; '\xe6\x97\xa5\xe6\x9c\xac\xe8\xaa\x9e'
</pre>

      <p>In this approach, unicode object should be converted into str and this is done by <code>to_str()</code> automatically. <code>tenjin.set_template_encoding()</code> generates correct <code>to_str()</code> function therefore you must call it before importing helper functions.</p>

      <div class="note"><span class="caption">NOTE:</span>

      <p>When you called <code>tenjin.set_template_encoding()</code>, it is strongly recommened to touch template files (= update timestamp of template files) in order to clear template caches.</p>

      </div>

      <dl class="dl2">
        <dt class="dt2">(B) Unicode-based approach</dt>
      </dl>

      <p>You can specify pyTenjin to convert template files into unicode object, such as:</p>
      <pre class="program">
_extend((<strong>u</strong>'''Hello ''', _to_str(name), <strong>u</strong>'''!''', ))
</pre>

      <p>If you prefer this approach, call <code>tenjin.set_template_encoding()</code> before importing helper functions.</p>
      <pre class="program">
import tenjin
<strong>tenjin.set_template_encoding('utf-8')   # or decode='utf-8'</strong>
from tenjin.helpers import *
   # ex. to_str('日本語')  #=&gt; <strong>u</strong>'\u65e5\u672c\u8a9e'
</pre>

      <p>In this approach, str object should be converted into unicode and this is done by <code>to_str()</code> automatically. <code>tenjin.set_template_encoding()</code> generates correct <code>to_str()</code> function therefore you must call it before importing helper functions.</p>

      <p>In addition, you must convert output into str object because output will be unicode object.</p>
      <pre class="program">
import tenjin
tenjin.set_template_encoding(decode='utf-8')
from tenjin.helpers import *
engine = tenjin.Engine()
output = engine.render('index.pyhtml')
<strong>if isinstance(output, unicode):</strong>
    <strong>output = output.encode('utf-8')</strong>
print(html)
</pre>

      <p>You should not add magic comment in your templates, or you will get the following SyntaxError.</p>
      <pre class="program">
## SyntaxError: encoding declaration in Unicode string
&lt;?py # -*- coding: utf-8 -*- ?&gt;
</pre>

      <div class="note"><span class="caption">NOTE:</span>

      <p>When you called <code>tenjin.set_template_encoding()</code>, it is strongly recommened to touch template files (= update timestamp of template files) in order to clear template caches.</p>

      </div><br>
      <a name="template-encoding-py3" id="template-encoding-py3"></a>

      <h4 class="section3">Python 3.x</h4>

      <p>In Python 3.x, string is treated as unicode object. So pyTenjin handles all templates in string base (= unicode base), and bytes data is converted into str by <code>to_str()</code> function. If you don't specify any encoding, Tenjin uses 'utf-8' encoding as default.</p>
      <pre class="program">
import tenjin
<strong>tenjin.set_template_encoding('cp932')</strong>   # or shift_jis
from tenjin.helpers import *
</pre><br>
      <br>
      <a name="helper-functions" id="helper-functions"></a>

      <h3 class="section2">Helper Function</h3>

      <p>Tenjin provides some modules for helper functions.</p><a name="tenjin-helpers" id="tenjin-helpers"></a>

      <h4 class="section3">tenjin.helpers module</h4>

      <p>Module <code>tenjin.helpers</code> provides basic helper functions.</p>

      <dl class="dl1">
        <dt class="dt1">to_str(<em>value</em>)</dt>

        <dd class="dd1">
          Converts value into string. <strong>None is converted into empty string instead of "None".</strong> Unicode object is encoded into string with 'utf-8' encoding name. If you want to use other encoding name, use generate_tostr_func().
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers import to_str
&gt;&gt;&gt; to_str(123)
'123'
&gt;&gt;&gt; to_str(None)       # None is converted into empty string
''
&gt;&gt;&gt; to_str(u'日本語')  # unicode object is encoded into str
'\xe6\x97\xa5\xe6\x9c\xac\xe8\xaa\x9e'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">escape(<em>str</em>)</dt>

        <dd class="dd1">
          Escape HTML special characters. This is same as <code>tenjin.html.escape_html()</code>.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers import escape
&gt;&gt;&gt; escape('&lt; &gt; &amp; " \' ')
'&amp;lt; &amp;gt; &amp;amp; &amp;quot; &amp;#39; '
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">generate_tostrfunc(<em>encode</em>=<em>encoding</em>, <em>decode</em>=<em>encoding</em>)</dt>

        <dd class="dd1">
          Generate to_str() function with enoding name.<br>
          (Since version 1.0.0, you don't need to call this directly. Call <code>tenjin.set_template_encoding()</code> instead.)
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers import generate_tostrfunc
&gt;&gt;&gt; ## generate to_str() function which encodes unicode into binary(=str).
&gt;&gt;&gt; to_str = generate_tostrfunc(encode='utf-8')
&gt;&gt;&gt; to_str(<strong>u</strong>'SOS')
'SOS'
&gt;&gt;&gt; ## generate to_str() function which decodes binary(=str) into unicode.
&gt;&gt;&gt; to_str = generate_tostrfunc(decode='utf-8')
&gt;&gt;&gt; to_str('SOS')
<strong>u</strong>'SOS'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">echo(<em>value</em>)</dt>

        <dd class="dd1">
          Add value string into _buf. This is similar to echo() function of PHP.
          <pre class="program">
## add _content into here
&lt;?py echo(_content) ?&gt;
## this is same as #{...} or {==...==}
#{_content}
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">new_cycle(*<em>values</em>)</dt>

        <dd class="dd1">
          Generates cycle object.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers import new_cycle
&gt;&gt;&gt; cycle = new_cycle('odd', 'even')
&gt;&gt;&gt; cycle()
'odd'
&gt;&gt;&gt; cycle()
'even'
&gt;&gt;&gt; cycle()
'odd'
&gt;&gt;&gt; cycle()
'even'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">cache_as(<em>key</em>, <em>lifetime=0</em>)</dt>

        <dd class="dd1">Caches fragment of output. See <a href="#fragment-cache">Fragment Cache</a> for details.</dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">not_cached(<em>key</em>, <em>lifetime=0</em>)</dt>

        <dd class="dd1">(OBSOLETE; use cache_as() instead)<br>
        If fragment is expired or not cached, start caching fragment with <em>key</em> and <em>lifetime</em> (seconds), and returns True. If fragment is already cached with <em>key</em>, returns False. See <a href="#fragment-cache">Fragment Cache</a> for details.</dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">echo_cached()</dt>

        <dd class="dd1">(OBSOLETE; use cache_as() instead)<br>
        Echo cached fragment. If caching is started by not_cached, stop and cache it. This function should be used with not_cached(). See <a href="#fragment-cache">Fragment Cache</a> for details.</dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">capture_as(<em>name</em>)</dt>

        <dd class="dd1">Capture a part of template. See <a href="#capturing">Capturing</a> section for details.</dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">captured_as(<em>name</em>)</dt>

        <dd class="dd1">Return True if captured with name. See <a href="#capturing">Capturing</a> section for details.</dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">start_capture(<em>name</em>), stop_capture()</dt>

        <dd class="dd1">(OSOLETE; use capture_as() instead)<br>
        Start capturing with specified name. See <a href="#capturing">Capturing</a> section for details.</dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">_P(<em>value</em>), _p(<em>value</em>)</dt>

        <dd class="dd1">Helper method for preprocessing. See <a href="#preprocessing">Preprocessing</a> section for details.</dd>
      </dl><br>
      <a name="tenjin-escaped" id="tenjin-escaped"></a>

      <h4 class="section3">tenjin.escaped module</h4>

      <p>Module <code>tenjin.escaped</code> provides auto-escaping helpers and classes.</p>

      <dl class="dl1">
        <dt class="dt1">as_escaped(<em>string</em>)</dt>

        <dd class="dd1">
          Mark <em>string</em> as escaped and returns marked string. <strong>Notice that this doesn't escape string at all.</strong> This function just mark string as escaped. See <a href="#auto-escaping">Auto-escaping</a> section for details.
          <pre class="program">
&gt;&gt;&gt; s = '&lt;p&gt;Hello&lt;/p&gt;'
&gt;&gt;&gt; as_escaped(s)              # not changes string content
'&lt;p&gt;Hello&lt;/p&gt;'
&gt;&gt;&gt; type(as_escaped(s))        # marks string as escaped
&lt;class 'tenjin.escaped.EscapedStr'&gt;
&gt;&gt;&gt; as_escaped(s) == s         # returned value is also string
True
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">is_escaped(<em>value</em>):</dt>

        <dd class="dd1">
          Return True if <em>value</em> is marked as escaped, else False. See <a href="#auto-escaping">Auto-escaping</a> section for details.
          <pre class="program">
&gt;&gt;&gt; s = '&lt;p&gt;Hello&lt;/p&gt;'
&gt;&gt;&gt; is_escaped(s)              # returns False if string is not marked
False
&gt;&gt;&gt; s = as_escaped('&lt;p&gt;Hello&lt;/p&gt;')
&gt;&gt;&gt; is_escaped(s)              # returns True if string is marked as escaped
True
</pre>
        </dd>

        <dt class="dt1">to_escaped(<em>value</em>):</dt>

        <dd class="dd1">
          Convert <em>value</em> into string, escape it, and return string which is marked as escaped. If <em>value</em> is already escaped, this helper function doesn't escape it any more. See <a href="#auto-escaping">Auto-escaping</a> section for details.
          <pre class="program">
&gt;&gt;&gt; s = '&lt;p&gt;Hello&lt;/p&gt;'
&gt;&gt;&gt; to_escaped(s)              # escapes html special characters
'&amp;lt;p&amp;gt;Hello&amp;lt;/p&amp;gt;'
&gt;&gt;&gt; is_escaped(to_escaped(s))  # returned value is marked as escaped
True
&gt;&gt;&gt; to_escaped(123)            # converts any value into string
'123'
&gt;&gt;&gt; to_escaped(None)           # converts None into empty string
''
</pre>
        </dd>
      </dl><br>
      <a name="tenjin-helpers-html" id="tenjin-helpers-html"></a>

      <h4 class="section3">tenjin.html module</h4>

      <p>Module <code>tenjin.html</code> provides HTML specific helper functions.</p>

      <dl class="dl1">
        <dt class="dt1">escape_html(<em>str</em>)</dt>

        <dd class="dd1">
          Escapes HTML special characters. Same as <code>tejin.helpers.escape()</code>.
          <pre class="program">
&gt;&gt;&gt; escape_html('&lt;&gt;&amp;"')
'&amp;lt;&amp;gt;&amp;amp;&amp;quot;'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">checked(<em>value</em>)</dt>

        <dd class="dd1">
          Returns <code>' checked="checked"'</code> if value is true value, else returns empty string.
          <pre class="program">
&gt;&gt;&gt; checked(1+1==2)
' checked="checked"'
&gt;&gt;&gt; checked(1+1==3)
''
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">selected(<em>value</em>)</dt>

        <dd class="dd1">
          Returns <code>' selected="selected"'</code> if value is true value, else returns empty string.
          <pre class="program">
&gt;&gt;&gt; selected(1+1==2)
' selected="selected"'
&gt;&gt;&gt; selected(1+1==3)
''
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">disabled(<em>value</em>)</dt>

        <dd class="dd1">
          Returns <code>' disabled="disabled"'</code> if value is true value, else returns empty string.
          <pre class="program">
&gt;&gt;&gt; disabled(1+1==2)
' disabled="disabled"'
&gt;&gt;&gt; disabled(1+1==3)
''
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">nl2br(<em>str</em>)</dt>

        <dd class="dd1">
          Replaces <code>"\n"</code> into <code>"&lt;br /&gt;\n"</code>.
          <pre class="program">
&gt;&gt;&gt; nl2br("foo\nbar\nbaz\n")
'foo&lt;br /&gt;\nbar&lt;br /&gt;\nbaz&lt;br /&gt;\n'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">text2html(<em>str</em>)</dt>

        <dd class="dd1">
          (experimental) Escapes xml characters and replace <code>"\n"</code> into <code>"&lt;br /&gt;\n"</code>.
          <pre class="program">
&gt;&gt;&gt; text2html('&lt;AAA&gt;\nB&amp;B\n"CCC"\n')
'&amp;lt;AAA&amp;gt;&lt;br /&gt;\nB&amp;amp;B&lt;br /&gt;\n&amp;quot;CCC&amp;quot;&lt;br /&gt;\n'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">tagattr(<em>name</em>, <em>expr</em>, <em>value</em>=None, <em>escape</em>=True)</dt>

        <dd class="dd1">
          <strong>(experimental)</strong> Returns <code>' name="value"'</code> if <em>expr</em> is true value, else <code>''</code> (empty string). If <em>value</em> is not specified, <em>expr</em> is used as value instead.
          <pre class="program">
&gt;&gt;&gt; tagattr('name', 'account')
' name="account"'
&gt;&gt;&gt; tagattr('name', None)
''
&gt;&gt;&gt; tagattr('checked', True, 'checked')
' checked="checked"'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">tagattrs(**<em>kwargs</em>)</dt>

        <dd class="dd1">
          <strong>(experimental)</strong> Builds html tag attribtes.
          <pre class="program">
&gt;&gt;&gt; tagattrs(klass='main', size=20)
' class="main" size="20"'
&gt;&gt;&gt; tagattrs(klass='', size=0)
''
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">nv(<em>name</em>, <em>value</em>, <em>sep</em>=None, **<em>kwargs</em>)</dt>

        <dd class="dd1">
          <strong>(experimental)</strong> Builds name and value attributes.
          <pre class="program">
&gt;&gt;&gt; nv('rank', 'A')
'name="rank" value="A"'
&gt;&gt;&gt; nv('rank', 'A', '-')
'name="rank" value="A" id="rank-A"'
&gt;&gt;&gt; nv('rank', 'A', '-', checked=True)
'name="rank" value="A" id="rank-A" checked="checked"'
&gt;&gt;&gt; nv('rank', 'A', '-', klass='error', style='color:red')
'name="rank" value="A" id="rank-A" class="error" style="color:red"'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">js_link(<em>label</em>, <em>onclick</em>, **<em>kwargs</em>)</dt>

        <dd class="dd1">
          <strong>(experimental)</strong> Builds &lt;a onclick="..."&gt;&lt;/a&gt; link.
          <pre class="program">
&gt;&gt;&gt; js_link('click', 'alert("OK")', klass='link')
'&lt;a href="javascript:undefined" onclick="alert(&amp;quot;OK&amp;quot;);return false" class="link"&gt;click&lt;/a&gt;'
</pre>
        </dd>
      </dl>

      <div class="note"><span class="caption">NOTE:</span>

      <p><code>tenjin.html</code> module is renamed to <code>tenjin.html</code> since version 1.0.0. But old module name is still available for backward compatibility.</p>

      </div><br>
      <br>
      <br>
      <a name="advanced-features" id="advanced-features"></a>

      <h2 class="section1">Advanced Features</h2><a name="auto-escaping" id="auto-escaping"></a>

      <h3 class="section2">Auto-escaping</h3>

      <p>Tenjin provides <code>SafeTemplate</code> and <code>SafeEngine</code> class which enforces HTML escape. These are similar to Django's feature or Jinja2's autoescape feature.</p>

      <p><strong>The point of these classes is that you can control whether escape html or not by data type, not by embedded notation.</strong></p>

      <p>See the following example.</p><a name="test_safe/safe-test.py"></a>

      <div class="program_caption">
        safe-test.py
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *
<strong>from tenjin.escaped import is_escaped, as_escaped, to_escaped</strong>

## both are same notation
input = r"""
a = <strong>${a}</strong>
b = <strong>${b}</strong>
"""

## but passed different data type
context = {
    "a": "&lt;b&gt;SOS&lt;/b&gt;",
    "b": <strong>as_escaped</strong>("&lt;b&gt;SOS&lt;/b&gt;"),
}

## SafeTemplate will escape 'a' but not 'b'
template = <strong>tenjin.SafeTemplate</strong>(input=input)
print(template.script)
print("---------------------")
print(template.render(context))
</pre>

      <p>The follwoing output shows that:</p>

      <ul type="disc">
        <li><code>SafeTemplate</code> and <code>SafeEngine</code> classes uses <code>to_escaped()</code> instead of <code>escape()</code> to escape value.</li>

        <li>Normal string (= <code>"&lt;b&gt;SOS&lt;/b&gt;"</code>) is escaped automatically, but the other string which is marked as escaped (= <code>as_escaped("&lt;b&gt;SOS&lt;/b&gt;")</code>) is not escaped. This means that you can controll escape by data type, not embedded notation.</li>
      </ul><a name="test_safe/result.output"></a>

      <div class="terminal_caption">
        Output example
      </div>
      <pre class="terminal">
$ python safe-test.py
_extend=_buf.extend;_to_str=to_str;_escape=<strong>to_escaped</strong>; _extend(('''
a = ''', _escape(a), '''
b = ''', _escape(b), '''\n''', ));

---------------------

a = &amp;lt;b&amp;gt;SOS&amp;lt;/b&amp;gt;
b = <strong>&lt;b&gt;SOS&lt;/b&gt;</strong>

</pre>

      <p>See <a href="#tenjin-escaped">tenjin.escaped module</a> section for details about <code>as_escaped()</code> and <code>to_escaped()</code>.</p>

      <p>In addition, <code>SafeTemplate</code>/<code>SafeEngine</code> classes inhibits <code>#{...}</code> because some people mistake it with <code>${...}</code> and it can be XSS security hole in the result. Use <code>{==...==}</code> instead of <code>#{...}</code>.</p>

      <div align="center">
        <table class="table2" border="1" cellspacing="0">
          <tr class="tr2">
            <th class="th2"></th>

            <th class="th2">Template, Engine</th>

            <th class="th2">SafeTemplate, SafeEngine</th>
          </tr>

          <tr class="tr2">
            <td class="td2">Escape html</td>

            <td class="td2"><code>${...}</code> or <code>{=...=}</code></td>

            <td class="td2"><code>${...}</code> or <code>{=...=}</code></td>
          </tr>

          <tr class="tr2">
            <td class="td2">Not escape</td>

            <td class="td2"><code>#{...}</code> or <code>{==...==}</code></td>

            <td class="td2">only <code>{==...==}</code></td>
          </tr>
        </table>
      </div><br>
      <a name="nested-layout-template" id="nested-layout-template"></a>

      <h3 class="section2">Nested Layout Template</h3>

      <p>It is able to nest several layout template files.</p><a name="test_nested/views/_site_layout.pyhtml"></a>

      <div class="program_caption">
        views/_site_layout.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS _content ?&gt;
&lt;html&gt;
  &lt;body&gt;
<strong>#{_content}</strong>
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_nested/views/_blog_layout.pyhtml"></a>

      <div class="program_caption">
        views/_blog_layout.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS _content, title ?&gt;
<strong>&lt;?py _context['_layout'] = '_site_layout.pyhtml' ?&gt;</strong>
&lt;h2&gt;${title}&lt;/h2&gt;
&lt;!-- content --&gt;
<strong>#{_content}</strong>
&lt;!-- /content --&gt;
</pre><a name="test_nested/views/blog_post.pyhtml"></a>

      <div class="program_caption">
        views/blog_post.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS post_content ?&gt;
<strong>&lt;?py _context['_layout'] = '_blog_layout.pyhtml' ?&gt;</strong>
&lt;div class="article"&gt;
#{text2html(post_content)}
&lt;/div&gt;
</pre><a name="test_nested/main.py"></a>

      <div class="program_caption">
        main.py
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *
from tenjin.html import text2html
engine = tenjin.Engine(path=['views'])
context = {
    'title': 'Blog Post Test',
    'post_content': "Foo\nBar\nBaz",
}
html = engine.render('blog_post.pyhtml', context)
print(html)
</pre><a name="test_nested/result.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ python main.py
&lt;html&gt;                        # by _layout.pyhtml
  &lt;body&gt;                      #       :
&lt;h2&gt;Blog Post Test&lt;/h2&gt;       #   by _blog_layout.pyhtml
&lt;!-- content --&gt;              #         :
&lt;div class="article"&gt;         #     by blog_post.pyhtml
Foo&lt;br /&gt;                     #           :
Bar&lt;br /&gt;                     #           :
Baz                           #           :
&lt;/div&gt;                        #           :
                              #           :
&lt;!-- /content --&gt;             #   by _blog_layout.pyhtml
                              #         :
  &lt;/body&gt;                     # by _layout.pyhtml
&lt;/html&gt;                       #       :

</pre><br>
      <a name="trace" id="trace"></a>

      <h3 class="section2">Trace Templates</h3>

      <p>If you pass '<code>trace=True</code>' to tenjin.Template class or tenjin.Engine class, Template class will print template file name at the beginning and end of output.</p>

      <p>For example:</p><a name="test_trace/trace-example.py"></a>

      <div class="program_caption">
        trace-example.py
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *
engine = tenjin.Engine(layout='layout.pyhtml', <strong>trace=True</strong>)
output = engine.render('main.pyhtml', {'items': ['A','B','C']})
print(output)
</pre>

      <p>Will print:</p><a name="test_trace/result.output"></a>
      <pre class="terminal">
$ python trace-example.py
<strong>&lt;!-- ***** begin: layout.pyhtml ***** --&gt;</strong>
&lt;html&gt;
  &lt;body&gt;
    &lt;div class="content"&gt;
<strong>&lt;!-- ***** begin: main.pyhtml ***** --&gt;</strong>
&lt;ul&gt;
  &lt;li&gt;A&lt;/li&gt;
  &lt;li&gt;B&lt;/li&gt;
  &lt;li&gt;C&lt;/li&gt;
&lt;/ul&gt;
<strong>&lt;!-- ***** end: main.pyhtml ***** --&gt;</strong>
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
<strong>&lt;!-- ***** end: layout.pyhtml ***** --&gt;</strong>

</pre>

      <p>This feature is very useful when debugging to detect template file name from HTML output.</p>

      <p>If you like it, you can make it always enabled.</p>
      <pre class="program">
## trace is always enabled
tenjin.Engine.trace = True
</pre><br>
      <a name="capturing" id="capturing"></a>

      <h3 class="section2">Capturing</h3>

      <p>It is able to capture parital of output. You can use this feature as an alternative of Django's template-inheritance.</p><a name="test_capturing/views/blog-post.pyhtml"></a>

      <div class="program_caption">
        views/blog-post.pyhtml : one partial capture ('sidebar')
      </div>
      <pre class="program">
&lt;?py from __future__ import with_statement ?&gt;
&lt;?py #@ARGS blog_post, recent_posts ?&gt;
&lt;h2&gt;#{blog_post['title']}&lt;/h2&gt;
&lt;div class="blog-post"&gt;
#{text2html(blog_post['content'])}
&lt;/div&gt;

<strong>&lt;?py with capture_as('sidebar'): ?&gt;</strong>
&lt;h3&gt;Recent Posts&lt;/h3&gt;
&lt;ul&gt;
&lt;?py for post in recent_posts: ?&gt; 
  &lt;a href="/blog/#{post['id']}"&gt;${post['title']}&lt;/a&gt;
&lt;?py #endfor ?&gt;
&lt;/ul&gt;
<strong>&lt;?py #endwith ?&gt;</strong>
</pre>

      <div class="note"><span class="caption">NOTE:</span>

      <p><code>capture_as()</code> supports both with-statement and for-statement. If you are using Python 2.4, change <code>with capture_as("sidebar"): ... #endwith</code> to <code>for _ in capture_as("sidebar"): ... #endfor</code>.</p>

      </div><a name="test_capturing/views/_layout.pyhtml"></a>

      <div class="program_caption">
        views/_layout.pyhtml : two placeholders ('header' and 'sidebar')
      </div>
      <pre class="program">
&lt;html&gt;
  &lt;body&gt;
    &lt;div id="header-part"&gt;
    <strong>&lt;?py if not captured_as('header'): ?&gt;</strong>
      &lt;h1&gt;My Great Blog&lt;/h1&gt;
    <strong>&lt;?py #endif ?&gt;</strong>
    &lt;/div&gt;
    &lt;div id="main-content"&gt;
#{_content}
    &lt;/div&gt;
    &lt;div id="sidebar-part"&gt;
    <strong>&lt;?py if not captured_as('sidebar'): ?&gt;</strong>
      &lt;h3&gt;Links&lt;/h3&gt;
      &lt;ul&gt;
        &lt;a href="http://google.com/"&gt;Google&lt;/a&gt;
        &lt;a href="http://yahoo.com/"&gt;Yahoo!&lt;/a&gt;
      &lt;/ul&gt;
    <strong>&lt;?py #endif ?&gt;</strong>
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_capturing/main.py"></a>

      <div class="program_caption">
        main.py
      </div>
      <pre class="program">
## context data
blog_post = {
  'title': 'Tenjin is Great',
  'content': """
Tenjin has great features.
- Very Fast
- Full Featured
- Easy to Use
"""[1:]
}
recent_posts = [
  {'id': 1, 'title': 'Tenjin is Fast' },
  {'id': 2, 'title': 'Tenjin is Full-Featured' },
  {'id': 3, 'title': 'Tenjin is Easy-to-Use' },
]
context = {
  'blog_post': blog_post,
  'recent_posts': recent_posts,
}

## render template
import tenjin
from tenjin.helpers import *
from tenjin.html import text2html
engine = tenjin.Engine(path=['views'], layout='_layout.pyhtml')
html = engine.render('blog-post.pyhtml', context)
print(html)
</pre>

      <p>The result shows that captured string (with name 'sidebar') overwrites layout template content.</p><a name="test_capturing/result.output"></a>

      <div class="program_caption">
        Result : only 'sidebar' placeholder is overwritten by capturing.
      </div>
      <pre class="program">
$ python main.py
&lt;html&gt;
  &lt;body&gt;
    &lt;div id="header-part"&gt;
      &lt;h1&gt;My Great Blog&lt;/h1&gt;
    &lt;/div&gt;
    &lt;div id="main-content"&gt;
&lt;h2&gt;Tenjin is Great&lt;/h2&gt;
&lt;div class="blog-post"&gt;
Tenjin has great features.&lt;br /&gt;
- Very Fast&lt;br /&gt;
- Full Featured&lt;br /&gt;
- Easy to Use&lt;br /&gt;

&lt;/div&gt;


    &lt;/div&gt;
    &lt;div id="sidebar-part"&gt;
<strong>&lt;h3&gt;Recent Posts&lt;/h3&gt;</strong>
<strong>&lt;ul&gt;</strong>
  <strong>&lt;a href="/blog/1"&gt;Tenjin is Fast&lt;/a&gt;</strong>
  <strong>&lt;a href="/blog/2"&gt;Tenjin is Full-Featured&lt;/a&gt;</strong>
  <strong>&lt;a href="/blog/3"&gt;Tenjin is Easy-to-Use&lt;/a&gt;</strong>
<strong>&lt;/ul&gt;</strong>
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;

</pre>

      <div class="note"><span class="caption">NOTE:</span>

      <p><code>start_capture()</code> and <code>stop_capture()</code> are still available but obsolete.</p>

      </div><br>
      <a name="templace-cache" id="templace-cache"></a>

      <h3 class="section2">Template Cache</h3>

      <p>Tenjin converts template file into Python script and save it as cache file. By default, it is saved as template-filename + '.cache' in bytecode format. You can change this behaviour by setting <code>tenjin.Engine.cache</code> or passing cache object to <code>tenjin.Engine</code> object.</p>

      <p>For example, if you want to cache template object but want not to create '*.cache' file, use <code>tenjin.MemoryCacheStorage</code> object.</p>

      <div class="program_caption">
        example to change template caching
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *

## change to store template cache into memory instead of file system
<strong>tenjin.Engine.cache = tenjin.MemoryCacheStorage()</strong>
engine = tenjin.Engine()

## or
engine = tenjin.Engine(<strong>cache=tenjin.MemoryCacheStorage()</strong>)
</pre><br>
      <a name="fragment-cache" id="fragment-cache"></a>

      <h3 class="section2">Fragment Cache</h3>

      <p>You can cache a certain part of HTML to improve performance. This is called as Fragment Cache.</p><a name="test_fragmentcache/views/items.pyhtml"></a>

      <div class="program_caption">
        views/items.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS get_items ?&gt;
&lt;div&gt;
  <strong>&lt;?py # fragment cache with key ('items/1') and lifetime (60sec) ?&gt;</strong>
  <strong>&lt;?py for _ in cache_as('items/1', 60): ?&gt;</strong>
  &lt;ul&gt;
    &lt;?py     for item in get_items(): ?&gt;
    &lt;li&gt;${item}&lt;/li&gt;
    &lt;?py     #endfor ?&gt;
  &lt;/ul&gt;
  <strong>&lt;?py #endfor ?&gt;</strong>
&lt;/div&gt;
</pre>

      <p>Tenjin stores fragments caches into memory by default. If you want to change or customize cache store, see the following example.</p><a name="test_fragmentcache/main.py"></a>

      <div class="program_caption">
        main.py
      </div>
      <pre class="program">
import os, tenjin
from tenjin.helpers import *

## create key-value store object
if not os.path.isdir('cache.d'): os.mkdir('cache.d')
<strong>kv_store = tenjin.FileBaseStore('cache.d')      # file based</strong>

## set key-value store into tenjin.helpers.fagment_cache object
<strong>tenjin.helpers.fragment_cache.store = kv_store</strong>

## context data
## (it is strongly recommended to create function object
##  to provide pull-style context data)
def get_items():   # called only when cache is expired
    return ['AAA', 'BBB', 'CCC']
context = {'get_items': get_items}

## render html
engine = tenjin.Engine(path=['views'])
html = engine.render('items.pyhtml', context)
print(html)
</pre><a name="test_fragmentcache/result.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ python main.py
&lt;div&gt;
  &lt;ul&gt;
    &lt;li&gt;AAA&lt;/li&gt;
    &lt;li&gt;BBB&lt;/li&gt;
    &lt;li&gt;CCC&lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;

</pre>

      <p>You'll find that HTML fragment is cached into cache directory. This cache data will be expired at 60 seconds after.</p><a name="test_fragmentcache/result2.output"></a>
      <pre class="terminal">
$ cat cache.d/items/1
  &lt;ul&gt;
    &lt;li&gt;AAA&lt;/li&gt;
    &lt;li&gt;BBB&lt;/li&gt;
    &lt;li&gt;CCC&lt;/li&gt;
  &lt;/ul&gt;
</pre>

      <div class="note"><span class="caption">NOTE:</span>

      <p><code>not_cached()</code> and <code>echo_cached()</code> are still available but obsolete.</p>

      </div><br>
      <a name="logging" id="logging"></a>

      <h3 class="section2">Logging</h3>

      <p>If you set logging object to <code>tenjin.logger</code>, pyTenjin will report loading template files.</p>

      <p>For example:</p><a name="test_logging/ex-logger.py"></a>

      <div class="program_caption">
        ex-logger.py
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *

## set logging object
<strong>import logging</strong>
<strong>logging.basicConfig(level=logging.INFO)</strong>
<strong>tenjin.logger = logging</strong>

engine = tenjin.Engine()
context = {'name': 'World'}
html = engine.render('example.pyhtml', context)
#print(html)
</pre>

      <p>If you run it first time, Tenjin will report that template object is stored into cache file.</p><a name="test_logging/result1.output"></a>
      <pre class="terminal">
$ python ex-logger.py
INFO:root:[tenjin.TextCacheStorage] <strong>store cache (file='/home/user/example.pyhtml.cache')</strong>
</pre>

      <p>And if you run it again, Tenjin will report that template object is loaded from cache file.</p><a name="test_logging/result2.output"></a>
      <pre class="terminal">
$ python ex-logger.py
INFO:root:[tenjin.TextCacheStorage] <strong>load cache (file='/home/user/example.pyhtml.cache')</strong>
</pre><br>
      <a name="google-appengine" id="google-appengine"></a>

      <h3 class="section2">Google App Engine Support</h3>

      <p>Tenjin supports Google App Engine. All you have to do is just call <code>tenjin.gae.init()</code>.</p>
      <pre class="program">
import tenjin
from tenjin.helpers import *
<strong>import tenjin.gae; tenjin.gae.init()</strong>

## it is recommended to configure logging
import logging
logging.basicConfig(level=logging.DEBUG)
<strong>tenjin.logger = logging</strong>
</pre>

      <p>You can see <a href="examples.html#gae">source code</a> of GAE example using Tenjin.</p>

      <p><code>tenjin.gae.init()</code> do the followings internally.</p>
      <pre class="program">
## change tenjin.Engine to cache template objects into memcache service
## (using CURRENT_VERSION_ID as namespace).
ver = os.environ.get('CURRENT_VERSION_ID', '1.1')#.split('.')[0]
Engine.cache = tenjin.gae.GaeMemcacheCacheStorage(namespace=ver)
## change fragment cache store to use memcache service
fragcache = tenjin.helpers.fragment_cache
fragcache.store    = tenjin.gae.GaeMemcacheStore(namespace=ver)
fragcache.lifetime = 60    #  1 minute
fragcache.prefix   = 'fragment.'
</pre>

      <div class="note"><span class="caption">NOTE:</span>

      <p>Google App Engine shares memcache in any version. In other words, Google App Engine doesn't allow to separate memcache for each version. This means that <strong>memcache data can be conflict between old and new version application in Google App Engine</strong>. Tenjin avoids this confliction by using version id as namespace.</p>

      </div><br>
      <a name="m17n" id="m17n"></a>

      <h3 class="section2">M17N Page</h3>

      <p>If you have M17N site, you can make your site faster by Tenjin.</p>

      <p>In M17N-ed site, message translation function (such as <code>_('message-key')</code>) is called many times. Therefore if you can eliminate calling that function, your site can be faster.</p>

      <div class="note"><span class="caption">NOTE:</span>

      <p>This feature is implemented with preprocessing feature. See <a href="#preprocessing">this section</a> for details about preprocessing.</p>

      </div>

      <p>The points are:</p>

      <ul type="disc">
        <li>Change cache filename according to language. For example, create cache file 'file.pyhtml.en.cache', 'file.pyhtml.fr.cache', 'file.pyhtml.it.cache', and so on from a template file 'file.pyhtml'. This is done by Tenjin automatically if you pass '<code>lang="en"</code>' or '<code>lang="fr"</code>' option to Engine class.</li>

        <li>Create Engine object for each language and pass <code>lang</code> option respectively.</li>

        <li>Enable preprocessing to create different cache content for each language.</li>
      </ul>

      <p>The following is an example to generate M17N pages from a template file.</p><a name="test_m17n/m17n.pyhtml"></a>

      <div class="program_caption">
        m17n.pyhtml:
      </div>
      <pre class="program">
&lt;div&gt;
&lt;?PY ## '_()' represents translator method ?&gt;
 &lt;p&gt;<strong>${{_('Hello')}}</strong> ${username}!&lt;/p&gt;
&lt;/div&gt;
</pre><a name="test_m17n/m17n.py"></a>

      <div class="program_caption">
        m17n.py:
      </div>
      <pre class="program">
# -*- coding: utf-8 -*-
import tenjin
from tenjin.helpers import *
import re

##
## message catalog to translate message
##
MESSAGE_CATALOG = {
    'en': { 'Hello': 'Hello',
            'Good bye': 'Good bye',
          },
    'fr': { 'Hello': 'Bonjour',
            'Good bye': 'Au revoir',
          },
}

##
## create translation function and return it.
## ex.
##    _ = create_m17n_func('fr')
##    print _('Hello')   #=&gt; 'Bonjour'
##
def create_m17n_func(lang):
    dct = MESSAGE_CATALOG.get(lang)
    if not dct:
        raise ValueError("%s: unknown lang." % lang)
    def _(message_key):
        return dct.get(message_key)
    return _
    # or return dct.get

##
## test program
##
if __name__ == '__main__':

    ## render html for English
    engine_en = tenjin.Engine(preprocess=True, <strong>lang='en'</strong>)
    context = { 'username': 'World' }
    <strong>context['_'] = create_m17n_func('en')</strong>
    html = engine_en.render('m17n.pyhtml', context)
    print("--- lang: en ---")
    print(html)

    ## render html for French
    engine_fr = tenjin.Engine(preprocess=True, <strong>lang='fr'</strong>)
    context = { 'username': 'World' }
    <strong>context['_'] = create_m17n_func('fr')</strong>
    html = engine_fr.render('m17n.pyhtml', context)
    print("--- lang: fr ---")
    print(html)
</pre><a name="test_m17n/result.output"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ python m17n.py
--- lang: en ---
&lt;div&gt;
 &lt;p&gt;<strong>Hello</strong> World!&lt;/p&gt;
&lt;/div&gt;

--- lang: fr ---
&lt;div&gt;
 &lt;p&gt;<strong>Bonjour</strong> World!&lt;/p&gt;
&lt;/div&gt;

</pre>

      <p>After that, you can find two cache files are created.</p>
      <pre class="terminal">
$ ls m17n.pyhtml*
m17n.pyhtml    m17n.pyhtml.<strong>en</strong>.cache    m17n.pyhtml.<strong>fr</strong>.cache
</pre>

      <p>And each cache files have different content.</p><a name="test_m17n/result_en.output"></a>

      <div class="terminal_caption">
        <code>_('Hello')</code> is translated into "Hello" in Engilish cache file
      </div>
      <pre class="terminal">
$ cat m17n.pyhtml.en.cache
timestamp: 1329291933.0

_extend=_buf.extend;_to_str=to_str;_escape=escape; _extend(('''&lt;div&gt;
 &lt;p&gt;<strong>Hello</strong> ''', _escape(_to_str(username)), '''!&lt;/p&gt;
&lt;/div&gt;\n''', ));
</pre><a name="test_m17n/result_fr.output"></a>

      <div class="terminal_caption">
        <code>_('Hello')</code> is translated into "Bonjour" in French cache file
      </div>
      <pre class="terminal">
$ cat m17n.pyhtml.fr.cache
timestamp: 1329291933.0

_extend=_buf.extend;_to_str=to_str;_escape=escape; _extend(('''&lt;div&gt;
 &lt;p&gt;<strong>Bonjour</strong> ''', _escape(_to_str(username)), '''!&lt;/p&gt;
&lt;/div&gt;\n''', ));
</pre><br>
      <br>
      <a name="preprocessing" id="preprocessing"></a>

      <h2 class="section1">Preprocessing</h2>

      <p>Tenjin supports template preprocessing.</p><a name="preprocessing-whatis" id="preprocessing-whatis"></a>

      <h3 class="section2">What is Preprocessing?</h3>

      <p>Preprocessing is a mechanism to manipulate template content when loading template file.</p>

      <p>For example, Tenjin provides TrimPreprocessor class which trims spaces in HTML templates. Using it, you can elminiate size of html output.</p><a name="test_pp/example.pyhtml"></a>

      <div class="program_caption">
        Preprocessing example by TrimPreprocessor
      </div>
      <pre class="program">
## Original html template
&lt;div&gt;
  &lt;ul&gt;
    &lt;?py for item in items: ?&gt;
    &lt;li&gt;${item}&lt;/li&gt;
    &lt;?py #endfor ?&gt;
  &lt;/ul&gt;
&lt;/div&gt;

## Preprocessed template when loading
&lt;div&gt;
&lt;ul&gt;
&lt;?py for item in items: ?&gt;
&lt;li&gt;${item}&lt;/li&gt;
&lt;?py #endfor ?&gt;
&lt;/ul&gt;
&lt;/div&gt;

## Output example
&lt;div&gt;
&lt;ul&gt;
&lt;li&gt;Foo&lt;/li&gt;
&lt;li&gt;Bar&lt;/li&gt;
&lt;li&gt;Baz&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</pre>

      <p>Tenjin provides the following preprocessor classses. See the succeeding sections for details about these classes.</p>

      <dl class="dl2">
        <dt class="dt2">TemplatePreprocessor</dt>

        <dd class="dd2">
          <p>Execute any logic or code in advance. Same as 'preprocess' option.</p>
        </dd>
      </dl>

      <dl class="dl2">
        <dt class="dt2">TrimPreprocessor</dt>

        <dd class="dd2">
          <p>Trims spaces at the beginning of lines.</p>
        </dd>
      </dl>

      <dl class="dl2">
        <dt class="dt2">PrefixedLinePreprocessor</dt>

        <dd class="dd2">
          <p>Converts '<code>:: ...</code>' lines into '<code>&lt;?py ... ?&gt;</code>'.</p>
        </dd>
      </dl>

      <dl class="dl2">
        <dt class="dt2">JavaScriptPreprocessor</dt>

        <dd class="dd2">
          <p>Generates client-side template code.</p>
        </dd>
      </dl>

      <p>If you want preprocessing, pass instance objects of these classes to engine object.</p><a name="test_pp/preprocess-example1.py"></a>

      <div class="program_caption">
        How to use preprocessors
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *
<strong>pp = [</strong>
<strong>  tenjin.TemplatePreprocessor(),</strong>      # same as preprocess=True
<strong>  tenjin.TrimPreprocessor(),</strong>          # trim spaces before tags
<strong>  tenjin.PrefixedLinePreprocessor(),</strong>  # convert ':: ...' into '&lt;?py ... ?&gt;'
<strong>  tenjin.JavaScriptPreprocessor(),</strong>    # allow to embed client-side template
<strong>]</strong>
engine = tenjin.Engine(<strong>pp=pp</strong>)
context = {'items': ["Haruhi", "Mikuru", "Yuki"]}
html = engine.render('example.pyhtml', context)
</pre><br>
      <a name="TrimPreprocessor" id="TrimPreprocessor"></a>

      <h3 class="section2">TrimPreprocessor class</h3>

      <p>TrimPreprocessor trims spaces before tags in order to eliminate size of output.</p>

      <p>For examle, the follwoing template file:</p><a name="test_pp_trim/example.pyhtml"></a>
      <pre class="program">
&lt;div&gt;
  &lt;ul&gt;
    &lt;?py for item in items: ?&gt;
    &lt;li&gt;${item}&lt;/li&gt;
    &lt;?py #endfor ?&gt;
  &lt;/ul&gt;
&lt;/div&gt;
</pre>

      <p>will generate the following output:</p><a name="test_pp_trim/result.expected"></a>
      <pre class="program">
&lt;div&gt;
&lt;ul&gt;
&lt;li&gt;Haruhi&lt;/li&gt;
&lt;li&gt;Mikuru&lt;/li&gt;
&lt;li&gt;Yuki&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;

</pre>

      <p>with the following code:</p><a name="test_pp_trim/pp-trim-main.py"></a>
      <pre class="program">
import tenjin
from tenjin.helpers import *
<strong>pp = [ tenjin.TrimPreprocessor() ]</strong>
engine = tenjin.Engine(<strong>pp=pp</strong>)
context = { 'items': ["Haruhi", "Mikuru", "Yuki"] }
html = engine.render('example.pyhtml', context)
print(html)
</pre>

      <div class="note"><span class="caption">NOTE:</span>

      <p>The default of TrimPreprocessor trims spaces on lines which starts with '&lt;'.</p>
      <pre class="program">
&lt;div&gt;
  &lt;pre&gt;       ## spaces will be trimmed
    x = 10    ## spaces will NOT be trimmed
  &lt;/pre&gt;      ## spaces will be trimmed
&lt;/pre&gt;
</pre>

      <p>If you want to trim all spaces, try <code>TrimPreprocessor(True)</code>.</p>

      </div><br>
      <a name="PrefixedLinePreprocessor" id="PrefixedLinePreprocessor"></a>

      <h3 class="section2">PrefixedLinePreprocessor class</h3>

      <p>PrefixedLinePreprocessor converts '<code>:: ...</code>' into '<code>&lt;?py ... ?&gt;</code>'.</p>

      <p>For examle, the follwoing template file:</p><a name="test_pp_prefixed/example.pyhtml"></a>
      <pre class="program">
&lt;div&gt;
  &lt;ul&gt;
    <strong>::</strong> for item in items:
    &lt;li&gt;${item}&lt;/li&gt;
    <strong>::</strong> #endfor
  &lt;/ul&gt;
&lt;/div&gt;
</pre>

      <p>is converted into:</p><a name="test_pp_prefixed/example.pyhtml"></a>
      <pre class="program">
&lt;div&gt;
  &lt;ul&gt;
    <strong>&lt;?py</strong> for item in items: <strong>?&gt;</strong>
    &lt;li&gt;${item}&lt;/li&gt;
    <strong>&lt;?py</strong> #endfor <strong>?&gt;</strong>
  &lt;/ul&gt;
&lt;/div&gt;
</pre>

      <p>and will generate the following output:</p><a name="test_pp_prefixed/result.expected"></a>
      <pre class="program">
&lt;div&gt;
  &lt;ul&gt;
    &lt;li&gt;Haruhi&lt;/li&gt;
    &lt;li&gt;Mikuru&lt;/li&gt;
    &lt;li&gt;Yuki&lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;

</pre>

      <p>with the following code:</p><a name="test_pp_prefixed/pp-prefixed-main.py"></a>
      <pre class="program">
import tenjin
from tenjin.helpers import *
<strong>pp = [ tenjin.PrefixedLinePreprocessor() ]</strong>
engine = tenjin.Engine(<strong>pp=pp</strong>)
context = { 'items': ["Haruhi", "Mikuru", "Yuki"] }
html = engine.render('example.pyhtml', context)
print(html)
</pre>

      <div class="note"><span class="caption">NOTE:</span>

      <p>Notice that space after '::' is necessary!</p>
      <pre class="program">
:: x = 10    # OK
::x = 10     # NG
</pre>

      </div><br>
      <a name="JavaScriptPreprocessor" id="JavaScriptPreprocessor"></a>

      <h3 class="section2">JavaScriptPreprocessor class</h3>

      <p>JavaScriptPreprocessor class enables you to embed client-side template code in your template file.</p><a name="test_pp_javascript/example.pyhtml"></a>

      <div class="program_caption">
        example.pyhtml
      </div>
      <pre class="program">
&lt;html&gt;
  &lt;body&gt;
    &lt;div id="placeholder"&gt;
      <strong>&lt;!-- #JS: render_table(items) --&gt;</strong>
      &lt;table&gt;
        &lt;tbody&gt;
          <strong>&lt;?js for (var i = 0, n = items.length; i &lt; n; i++) { ?&gt;</strong>
          <strong>&lt;?js     var klass = i % 2 ? 'even' : 'odd'; ?&gt;</strong>
          &lt;tr class="<strong>#{klass}</strong>"&gt;
            &lt;td&gt;<strong>${items[i]}</strong>&lt;/td&gt;
          &lt;/tr&gt;
          <strong>&lt;?js } ?&gt;</strong>
        &lt;/tbody&gt;
      &lt;/table&gt;
      <strong>&lt;!-- #/JS --&gt;</strong>
    &lt;/div&gt;
    &lt;script&gt;<strong>#{tenjin.JS_FUNC}</strong>&lt;/script&gt;
    &lt;script&gt;
/// example code to render table
(function() {
   var items = ["Haruhi", "Mikuru", "Yuki"];
   var e = document.getElementById('placeholder');
   e.innerHTML = <strong>render_table(items)</strong>;
 })();
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_pp_javascript/pp-javascript.py"></a>

      <div class="program_caption">
        Example (pp-javascript.py)
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *
<strong>pp = [ tenjin.JavaScriptPreprocessor() ]</strong>
<strong>## or pp = [ tenjin.JavaScriptPreprocessor(type='text/javascript') ]</strong>
engine = tenjin.Engine(<strong>pp=pp</strong>)
context = { 'items': ["Haruhi", "Mikuru", "Yuki"] }
html = engine.render('example.pyhtml', context)
print(html)
</pre><a name="test_pp_javascript/result.output"></a>

      <div class="terminal_caption">
        Output example
      </div>
      <pre class="terminal">
$ python pp-javascript.py
&lt;html&gt;
  &lt;body&gt;
    &lt;div id="placeholder"&gt;
      <strong>&lt;script&gt;function render_table(items){var _buf='';</strong>
<strong>_buf+='      &lt;table&gt;\n\</strong>
        <strong>&lt;tbody&gt;\n';</strong>
           <strong>for (var i = 0, n = items.length; i &lt; n; i++) {</strong>
               <strong>var klass = i % 2 ? 'even' : 'odd';</strong>
<strong>_buf+='          &lt;tr class="'+_S(klass)+'"&gt;\n\</strong>
            <strong>&lt;td&gt;'+_E(items[i])+'&lt;/td&gt;\n\</strong>
          <strong>&lt;/tr&gt;\n';</strong>
           <strong>}</strong>
<strong>_buf+='        &lt;/tbody&gt;\n\</strong>
      <strong>&lt;/table&gt;\n';</strong>
      <strong>return _buf;};&lt;/script&gt;</strong>
    &lt;/div&gt;
    &lt;script&gt;<strong>function _S(x){return x==null?'':x;}</strong>
<strong>function _E(x){return x==null?'':typeof(x)!=='string'?x:x.replace(/[&amp;&lt;&gt;"']/g,_EF);}</strong>
<strong>var _ET={'&amp;':"&amp;amp;",'&lt;':"&amp;lt;",'&gt;':"&amp;gt;",'"':"&amp;quot;","'":"&amp;#039;"};</strong>
<strong>function _EF(c){return _ET[c];};</strong>&lt;/script&gt;
    &lt;script&gt;
/// example code to render table
(function() {
   var items = ["Haruhi", "Mikuru", "Yuki"];
   var e = document.getElementById('placeholder');
   e.innerHTML = <strong>render_table(items)</strong>;
 })();
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;

</pre>

      <p>According to HTML syntax, <code>&lt;script&gt;</code> tag can be appeared in limited place. But client-side template code will work well even in the case that <code>&lt;script&gt;</code> is appeared in non-valid place.</p>
      <pre class="program">
### OK (valid as HTML)
&lt;div&gt;
  <strong>&lt;script&gt;</strong>function render_table(items){var _buf='';
 _buf += '  <strong>&lt;table&gt;</strong>\n\
    <strong>&lt;tbody&gt;</strong>\n';
    ....
 _buf += '    <strong>&lt;/tbody&gt;</strong>\n\
  <strong>&lt;/table&gt;</strong>\n';
  return _buf;<strong>&lt;/script&gt;</strong>
&lt;/div&gt;

### NG (not valid as HTML because &lt;script&gt; tag can't be appreared
### in &lt;table&gt; or &lt;tbody&gt; tag, but this code works well in browser)
&lt;div&gt;
  <strong>&lt;table&gt;</strong>
    <strong>&lt;tbody&gt;</strong>
      <strong>&lt;script&gt;</strong>function render_table(items) {var _buf='';
    ....
  return _buf;<strong>&lt;/script&gt;</strong>
    <strong>&lt;/tbody&gt;</strong>
  <strong>&lt;/table&gt;</strong>
&lt;/div&gt;
</pre>

      <p>In this moment it is not possible to nest client-side template code.</p>
      <pre class="program">
## NOT AVAILABLE!!
<strong>&lt;!-- #JS: render_table(items) --&gt;</strong>
&lt;table&gt;
  &lt;tbody&gt;
    &lt;?js for (var i = 0, n = items.length; i &lt; n; i++) { ?&gt;
    <strong>&lt;!-- #JS: render_raw(item) --&gt;</strong>
    &lt;tr&gt;
      &lt;td&gt;${item}&lt;/td&gt;
    &lt;/tr&gt;
    <strong>&lt;!-- #/JS --&gt;</strong>
    &lt;?js } ?&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
<strong>&lt;!-- #/JS --&gt;</strong>
</pre><br>
      <a name="TemplatePreprocessor" id="TemplatePreprocessor"></a>

      <h3 class="section2">TemplatePreprocessor class</h3>

      <p><code>TemplatePreprocessor</code> class allows you to execute some logics when templates are compiled into script, and these logics are not executed when rendering.</p>

      <div class="note"><span class="caption">NOTE:</span>

      <p><code>preprocess</code> option for Engine class is still available for backward compatibility.</p>

      </div>

      <p><code>TemplatePreprocessor</code> class makes your application faster, because some logics are executed on compiling stage, not on rendering stage.</p>

      <p>Notation of preprocessing with <code>TemplatePreprocessor</code> class:</p>

      <dl class="dl1">
        <dt class="dt1"><code>&lt;?PY ... ?&gt;</code></dt>

        <dd class="dd1">Preprocessing statement.</dd>

        <dt class="dt1"><code>${{...}}</code> or <code>{#=...=#}</code></dt>

        <dd class="dd1">Preprocessing expression (with HTML escape)</dd>

        <dt class="dt1"><code>#{{...}}</code> or <code>{#==...==#}</code></dt>

        <dd class="dd1">Preprocessing expression (without HTML escape)</dd>
      </dl>

      <p>The following shows difference between <code>${...}</code> and <code>${{...}}</code>.</p><a name="test_preprocessing/views/pp-example1.pyhtml"></a>

      <div class="program_caption">
        views/pp-example1.pyhtml
      </div>
      <pre class="program">
## normal expression
value = <strong>${value}</strong>
## with preprocessing
value = <strong>${{value}}</strong>
</pre><a name="test_preprocessing/pp-example1.py"></a>

      <div class="program_caption">
        pp-example1.py
      </div>
      <pre class="program">
value = 'My Great Example'

## create engine object with preprocessing enabled
import tenjin
from tenjin.helpers import *
engine = tenjin.Engine(path=['views'], <strong>preprocess=True</strong>)

## print Python script code
print("------ converted script ------")
print(engine.get_template('pp-example1.pyhtml').script)

## render html
html = engine.render('pp-example1.pyhtml', {})
print("------ rendered html ------")
print(html)
</pre><a name="test_preprocessing/result1a.output"></a>

      <div class="terminal_caption">
        Result: notice that <code>${{...}}</code> is evaluated at template converting stage.
      </div>
      <pre class="terminal">
$ python pp-example1.py
------ converted script ------
_extend=_buf.extend;_to_str=to_str;_escape=escape; _extend(('''## normal expression
value = ''', <strong>_escape(_to_str(value))</strong>, '''
## with preprocessing
value = <strong>My Great Example</strong>\n''', ));

------ rendered html ------
## normal expression
value = My Great Example
## with preprocessing
value = My Great Example

</pre>

      <p>You can confirm preprocessed template by '<code>pytenjin -P</code>' command.</p><a name="test_preprocessing/result1b.output"></a>

      <div class="terminal_caption">
        Preprocessed template
      </div>
      <pre class="terminal">
$ pytenjin <strong>-P</strong> -c 'value="My Great Example"' views/pp-example1.pyhtml
## normal expression
value = ${value}
## with preprocessing
value = My Great Example
</pre>

      <p>If you want to see preprocessing script (not preprocessed script), use '<code>pytenjin -sP</code>' command.</p><a name="test_preprocessing/result1c.output"></a>
      <pre class="terminal">
$ pytenjin <strong>-sP</strong> -c 'value="My Great Example"' views/pp-example1.pyhtml
_buf = []; _extend=_buf.extend;_to_str=to_str;_escape=escape; _extend(('''## normal expression
value = ${value}
## with preprocessing
value = ''', _escape(_to_str(_decode_params(value))), '''\n''', ));
print(''.join(_buf))
</pre><a name="preprocessing-loop-expantion" id="preprocessing-loop-expantion"></a>

      <h4 class="section3">Loop Expantion</h4>

      <p>It is possible to evaluate some logics by '<code>&lt;?PY ... ?&gt;</code>' when convert template into Python script code. For example, you can expand loop in advance to improve performance.</p><a name="test_preprocessing/views/pp-example2.pyhtml"></a>

      <div class="program_caption">
        views/pp-example2.pyhtml
      </div>
      <pre class="program">
<strong>&lt;?PY states = { "CA": "California", ?&gt;</strong>
<strong>&lt;?PY            "NY": "New York", ?&gt;</strong>
<strong>&lt;?PY            "FL": "Florida",  ?&gt;</strong>
<strong>&lt;?PY            "TX": "Texas",  ?&gt;</strong>
<strong>&lt;?PY            "HI": "Hawaii", } ?&gt;</strong>
<strong>&lt;?PY # ?&gt;</strong>
&lt;?py chk = { params['state']: ' selected="selected"' } ?&gt;
<strong>&lt;?PY codes = list(states.keys()) ?&gt;</strong>
<strong>&lt;?PY codes.sort() ?&gt;</strong>
&lt;select name="state"&gt;
  &lt;option value=""&gt;-&lt;/option&gt;
  <strong>&lt;?PY for code in codes: ?&gt;</strong>
  &lt;option value="<strong>#{{code}}</strong>"#{chk.get('<strong>#{{code}}</strong>', '')}&gt;<strong>${{states[code]}}</strong>&lt;/option&gt;
  <strong>&lt;?PY #endfor ?&gt;</strong>
&lt;/select&gt;
</pre>

      <p>Preprocessed script code shows that loop is expanded in advance. It means that loop is not executed when rendering template.</p><a name="test_preprocessing/result2a.output"></a>

      <div class="terminal_caption">
        Preprocessed template
      </div>
      <pre class="terminal">
$ pytenjin -P views/pp-example2.pyhtml
&lt;?py chk = { params['state']: ' selected="selected"' } ?&gt;
&lt;select name="state"&gt;
  &lt;option value=""&gt;-&lt;/option&gt;
  &lt;option value="CA"#{chk.get('CA', '')}&gt;California&lt;/option&gt;
  &lt;option value="FL"#{chk.get('FL', '')}&gt;Florida&lt;/option&gt;
  &lt;option value="HI"#{chk.get('HI', '')}&gt;Hawaii&lt;/option&gt;
  &lt;option value="NY"#{chk.get('NY', '')}&gt;New York&lt;/option&gt;
  &lt;option value="TX"#{chk.get('TX', '')}&gt;Texas&lt;/option&gt;
&lt;/select&gt;
</pre><br>
      <a name="preprocessing-parameters" id="preprocessing-parameters"></a>

      <h4 class="section3">Parameters</h4>

      <p>Assume that link_to() is a helper method which takes label and url and generate &lt;a&gt;&lt;/a&gt; tag. In this case, label and url can be parameterized by <code>_p("...")</code> and <code>_P("...")</code>. The former is converted into #{...} and the latter converted into ${...} by preprocessor.</p><a name="test_preprocessing/views/pp-example3.pyhtml"></a>

      <div class="program_caption">
        views/pp-example3.pyhtml
      </div>
      <pre class="program">
<strong>&lt;?PY</strong>
## ex. link_to('Show', '/show/1')  =&gt; &lt;a href="/show/1"&gt;Show&lt;/a&gt;
def link_to(label, url):
    try:    from urllib.parse import quote
    except: from urllib import quote
    return '&lt;a href="%s"&gt;%s&lt;/a&gt;' % (quote(url), label)
#enddef
<strong>?&gt;</strong>
<strong>#{{</strong>link_to('Show '+<strong>_P(</strong>'params["name"]'<strong>)</strong>, '/items/show/'+<strong>_p(</strong>'params["id"]'<strong>)</strong>)<strong>}}</strong>
</pre>

      <p>The following shows that <code>_P('...')</code> and <code>_p('...')</code> are converted into <code>${...}</code> and <code>#{...}</code> respectively.</p><a name="test_preprocessing/result3a.output"></a>

      <div class="terminal_caption">
        Preprocessed template:
      </div>
      <pre class="terminal">
$ pytenjin -P views/pp-example3.pyhtml
&lt;a href="/items/show/<strong>#{</strong>params["id"]<strong>}</strong>"&gt;Show <strong>${</strong>params["name"]<strong>}</strong>&lt;/a&gt;
</pre>

      <p>There are many web-application framework and they provides helper functions. These helper functions are divided into two groups. link_to() or _() (function for M17N) return the same result when the same arguments are passed. These functions can be expanded by preprocessor. Some functions return the different result even if the same arguments are passed. These functions can't be expaned by preprocessor.</p>

      <p>Preprocessor has the power to make view-layer much faster, but it may make the debugging difficult. You should use it carefully.</p><br>
      <br>
      <br>
      <a name="tips" id="tips"></a>

      <h2 class="section1">Tips</h2><a name="function-names" id="function-names"></a>

      <h3 class="section2">Specify Function Names of escape() and to_str()</h3>

      <p>It is able to specify function names of <code>escape()</code> and <code>to_str()</code> which are used in converted Python script.</p><a name="test_escape/main.py"></a>

      <div class="program_caption">
        main.py
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *
import cgi
engine = tenjin.Engine(path=['views'], <strong>escapefunc="cgi.escape", tostrfunc="str"</strong>)
print(engine.get_template('page.pyhtml').script)
</pre><a name="test_escape/views/page.pyhtml"></a>

      <div class="program_caption">
        views/page.pyhtml
      </div>
      <pre class="program">
&lt;p&gt;
  escaped:     ${value}
  not escaped: #{value}
&lt;/p&gt;
</pre><a name="test_escape/result.output"></a>

      <div class="program_caption">
        Result
      </div>
      <pre class="program">
$ python main.py
_extend=_buf.extend;_to_str=<strong>str</strong>;_escape=<strong>cgi.escape</strong>; _extend(('''&lt;p&gt;
  escaped:     ''', _escape(_to_str(value)), '''
  not escaped: ''', _to_str(value), '''
&lt;/p&gt;\n''', ));

</pre>

      <p>If you need faster version of <code>to_str()</code> and <code>escape()</code>, see <a href="#webext">next section</a>.</p><br>
      <a name="tips-webext" id="tips-webext"></a>

      <h3 class="section2">Webext</h3>

      <p>I have to say that <strong>bottleneck of Tenjin is calling <code>to_str()</code> and <code>escape()</code>, not string concatenation</strong>. Therefore if you want to make Tenjin much faster, you must make <code>to_str()</code> and <code>escape()</code> faster (or eliminate calling them).</p>

      <p>For example, using <code>str()</code> instead of <code>to_str()</code> will make Tenjin much faster. The following benchmark result shows that <code>str()</code>(= 'tenjin-str') is much faster than <code>to_str()</code>(= 'tenjin').</p>

      <div class="terminal_caption">
        <code>str()</code> is faster than <code>to_str()</code>
      </div>
      <pre class="terminal">
$ cd Tenjin-X.X.X/benchmark
$ python -V
Python 2.5.5
$ python bench.py -q -n 10000 tenjin tenjin-str
*** ntimes=10000
                                    utime     stime     total      real
tenjin                             3.7500    0.0400    3.7900    3.7936
tenjin-str                         2.4500    0.0300    2.4800    2.4857
</pre>

      <p>But <code>str()</code> doesn't return empty string if argument is <code>None</code>. In addition <code>str()</code> raises UnicodeEncodeError frequently.</p>

      <p>Other solution is <a href="http://pypi.python.org/Webext/">Webext</a>. <a href="http://pypi.python.org/Webext/">Webext</a> is an extension module which implement <code>to_str()</code> and <code>escape()</code> in C language.</p>
      <pre class="program">
import tenjin
from tenjin.helpers import *
<strong>from webext import to_str, escape</strong>    # use webext's functions instead of tenjin's
</pre>

      <p>Benchmark script in Tenjin already supports Webext. It shows that Webext makes Tenjin much faster especially html escaping.</p>

      <div class="terminal_caption">
        Intel CoreDuo2 2GHz, Mac OS X 10.6, Python 2.5.5
      </div>
      <pre class="terminal">
### without html escape
$ cd Tenjin-X.X.X/
$ cd benchmark/
$ python bench.py -q -n 10000 tenjin tenjin-str tenjin-webext
*** ntimes=10000
                                    utime     stime     total      real
tenjin                             3.8100    0.0400    3.8500    3.8462
tenjin-str                         2.4500    0.0200    2.4700    2.4815
tenjin-webext                      2.4500    0.0300    2.4800    2.4825

## with html escape
$ python bench.py -e -q -n 10000 tenjin tenjin-str tenjin-webext
*** ntimes=10000
                                    utime     stime     total      real
tenjin                             7.2900    0.0500    7.3400    7.4669
tenjin-str                         5.7400    0.0400    5.7800    5.8202
tenjin-webext                      2.9700    0.0400    3.0100    3.0079
</pre><br>
      <a name="tips-template-inheritance" id="tips-template-inheritance"></a>

      <h3 class="section2">Template Inheritance</h3>

      <p>Tenjin doesn't support Template Inheritance which Django template engine does. But you can emulate it by capturing<sup>(<a href="#fnref:1" name="fnlink:1" id="fnlink:1">*1</a>)</sup>. See <a href="#capturing">this section</a> for details.</p>

      <div class="footnote">
        <dl compact>
          <dt>(<a name="fnref:1" href="#fnlink:1" id="fnref:1">*1</a>)</dt>

          <dd>Notice that capturing is useful but not so powerful than template inheritance.</dd>
        </dl>
      </div><br>
      <a name="tips-template-file-suffix" id="tips-template-file-suffix"></a>

      <h3 class="section2">Template File Suffix</h3>

      <p>If you want to change template suffix rule, override Engine#to_filename().</p>
      <pre class="program">
def to_filename(self, template_name):
    ### original
    #if template_name[0] == ':' :
    #    return self.prefix + template_name[1:] + self.postfix
    #return template_name
    ### customize suffix rule:
    ### - ':foo'     =&gt; 'foo.html.tjn'
    ### - 'foo.json' =&gt; 'foo.json.tjn'
    if template_name[0] == ':':
        return template_name + '.html.tjn'
    return template_name + '.tjn'

tenjin.Engine.to_filename = to_filename
</pre><br>
      <br>
      <a name="command" id="command"></a>

      <h2 class="section1"><code>pytenjin</code> Command</h2>

      <p>See '<code>pytenjin -h</code>' for details.</p><a name="command-syntax-check" id="command-syntax-check"></a>

      <h3 class="section2">Syntax Check</h3>

      <p>Command-line option '<code>-z</code>' checks syntax of template files.</p><a name="test_syntax_check/example.pyhtml"></a>

      <div class="program_caption">
        example.pyhtml
      </div>
      <pre class="program">
&lt;ul&gt;
&lt;?py for item in items: ?&gt;
 &lt;li&gt;${item}&lt;/li&gt;
&lt;?py <strong>#endif</strong> ?&gt;
&lt;/ul&gt;
</pre><a name="test_syntax_check/result.output"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ pytenjin <strong>-z</strong> example.pyhtml
example.pyhtml:4:1: '#endfor' expected but got '#endif'.
   4: #endif
      ^
</pre>

      <p>Error message is the same format as gcc compiler or java compiler. Error jump in Emacs or other editor is available.</p>

      <p>Command-line option '-q' (quiet-mode) prints nothing if there are no syntax errors.</p><br>
      <a name="command-convert-script" id="command-convert-script"></a>

      <h3 class="section2">Convert Template into Python Script</h3>

      <p>Command-line option '-s' converts template file into Python script code.</p><a name="test_convert/example.pyhtml"></a>

      <div class="program_caption">
        example.pyhtml
      </div>
      <pre class="program">
&lt;ul&gt;
  &lt;?py for item in items: ?&gt;
  &lt;li&gt;${item}&lt;/li&gt;
  &lt;?py #endfor ?&gt;
&lt;/ul&gt;
</pre><a name="test_convert/result1.output"></a>

      <div class="terminal_caption">
        Result (-s)
      </div>
      <pre class="terminal">
$ pytenjin <strong>-s</strong> example.pyhtml
_buf = []; _extend=_buf.extend;_to_str=to_str;_escape=escape; _extend(('''&lt;ul&gt;\n''', ));
for item in items:
    _extend(('''  &lt;li&gt;''', _escape(_to_str(item)), '''&lt;/li&gt;\n''', ));
#endfor
_extend(('''&lt;/ul&gt;\n''', ));
print(''.join(_buf))
</pre>

      <p>Option '-b' removes preamble ('<code>_buf = []</code>') and postamble ('<code>print "".join(_buf))</code>').</p><a name="test_convert/result2.output"></a>

      <div class="terminal_caption">
        Result (-sb)
      </div>
      <pre class="terminal">
$ pytenjin -s<strong>b</strong> example.pyhtml
_extend=_buf.extend;_to_str=to_str;_escape=escape; _extend(('''&lt;ul&gt;\n''', ));
for item in items:
    _extend(('''  &lt;li&gt;''', _escape(_to_str(item)), '''&lt;/li&gt;\n''', ));
#endfor
_extend(('''&lt;/ul&gt;\n''', ));
</pre><br>
      <a name="command-retrieve" id="command-retrieve"></a>

      <h3 class="section2">Retrieve Embedded Code</h3>

      <p>Tenjin allows you to retrieve embedded code from template files in order to help template debugging.</p>

      <p>It is hard to debug large template files because HTML and embedded code are mixed in a file. Retrieving embedded code from template files will help you to debug large template files.</p>

      <p>Assume the following template file.</p><a name="test_retrieve/example.pyhtml"></a>

      <div class="program_caption">
        example.pyhtml
      </div>
      <pre class="program">
&lt;table&gt;
  &lt;?py i = 0 ?&gt;
  &lt;?py for item in items: ?&gt;
  &lt;?py     i += 1 ?&gt;
  &lt;tr&gt;
    &lt;td&gt;#{i}&lt;/td&gt;
    &lt;td&gt;${item}&lt;/td&gt;
  &lt;/tr&gt;
  &lt;?py #endfor ?&gt;
&lt;/table&gt;
</pre>

      <p>Option '-S' (or '-a retrieve') retrieves embedded codes.</p><a name="test_retrieve/result1.output"></a>

      <div class="terminal_caption">
        Result (-Sb)
      </div>
      <pre class="terminal">
$ pytenjin -<strong>S</strong>b example.pyhtml
_extend=_buf.extend;_to_str=to_str;_escape=escape; 
i = 0
for item in items:
    i += 1

    _to_str(i); 
    _escape(_to_str(item)); 

#endfor

</pre>

      <p>Option '-X' (or '-a statements') retrieves only statements.</p><a name="test_retrieve/result2.output"></a>

      <div class="terminal_caption">
        Result (-Xb)
      </div>
      <pre class="terminal">
$ pytenjin -<strong>X</strong>b example.pyhtml
_extend=_buf.extend;_to_str=to_str;_escape=escape; 
i = 0
for item in items:
    i += 1




#endfor

</pre>

      <p>Option '-N' adds line numbers.</p><a name="test_retrieve/result3.output"></a>

      <div class="terminal_caption">
        Result (-NXb)
      </div>
      <pre class="terminal">
$ pytenjin -<strong>N</strong>Xb example.pyhtml
    1:  _extend=_buf.extend;_to_str=to_str;_escape=escape; 
    2:  i = 0
    3:  for item in items:
    4:      i += 1
    5:  
    6:  
    7:  
    8:  
    9:  #endfor
   10:  
</pre>

      <p>Option '-U' (unique) compress empty lines.</p><a name="test_retrieve/result4.output"></a>

      <div class="terminal_caption">
        Result (-UNXb)
      </div>
      <pre class="terminal">
$ pytenjin -<strong>U</strong>NXb example.pyhtml
    1:  _extend=_buf.extend;_to_str=to_str;_escape=escape; 
    2:  i = 0
    3:  for item in items:
    4:      i += 1

    9:  #endfor

</pre>

      <p>Option '-C' (compact) removes empty lines.</p><a name="test_retrieve/result5.output"></a>

      <div class="terminal_caption">
        Result (-CNXb)
      </div>
      <pre class="terminal">
$ pytenjin -<strong>C</strong>NXb example.pyhtml
    1:  _extend=_buf.extend;_to_str=to_str;_escape=escape; 
    2:  i = 0
    3:  for item in items:
    4:      i += 1
    9:  #endfor
</pre><br>
      <a name="command-execute-template" id="command-execute-template"></a>

      <h3 class="section2">Execute Template File</h3>

      <p>You can execute template file in command-line.</p><a name="test_execute/example.pyhtml"></a>

      <div class="program_caption">
        example.pyhtml
      </div>
      <pre class="program">
&lt;?py items = ['&lt;AAA&gt;', 'B&amp;B', '"CCC"'] ?&gt;
&lt;ul&gt;
  &lt;?py for item in items: ?&gt;
  &lt;li&gt;${item}&lt;/li&gt;
  &lt;?py #endfor ?&gt;
&lt;/ul&gt;
</pre><a name="test_execute/result.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ pytenjin example.pyhtml
&lt;ul&gt;
  &lt;li&gt;&amp;lt;AAA&amp;gt;&lt;/li&gt;
  &lt;li&gt;B&amp;amp;B&lt;/li&gt;
  &lt;li&gt;&amp;quot;CCC&amp;quot;&lt;/li&gt;
&lt;/ul&gt;
</pre><br>
      <a name="command-context-data" id="command-context-data"></a>

      <h3 class="section2">Context Data</h3>

      <p>You can specify context data with command-line option '<code>-c</code>'.</p><a name="test_context/example.pyhtml"></a>

      <div class="program_caption">
        example.pyhtml
      </div>
      <pre class="program">
&lt;ul&gt;
  &lt;?py for item in items: ?&gt;
  &lt;li&gt;${item}&lt;/li&gt;
  &lt;?py #endfor ?&gt;
&lt;/ul&gt;
</pre><a name="test_context/result1.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ pytenjin <strong>-c 'items=["A","B","C"]'</strong> example.pyhtml
&lt;ul&gt;
  &lt;li&gt;A&lt;/li&gt;
  &lt;li&gt;B&lt;/li&gt;
  &lt;li&gt;C&lt;/li&gt;
&lt;/ul&gt;
</pre>

      <p>If you want to specify several values, separate them by ';' such as '-c "x=10; y=20"'.</p>

      <p>If you installed PyYAML library, you can specify context data in YAML format. Tenjin regards context data string as YAML format if it starts with '{'.</p><a name="test_context/result2.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ pytenjin <strong>-c '{items: [A, B, C]}'</strong> example.pyhtml
&lt;ul&gt;
  &lt;li&gt;A&lt;/li&gt;
  &lt;li&gt;B&lt;/li&gt;
  &lt;li&gt;C&lt;/li&gt;
&lt;/ul&gt;
</pre>

      <p>In addition, Tenjin supports context data file in Python format or YAML format.</p><a name="test_context/context.py"></a>

      <div class="program_caption">
        context.py
      </div>
      <pre class="program">
items = [
   "AAA",
   123,
   True,
]
</pre><a name="test_context/result3.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ pytenjin <strong>-f context.py</strong> example.pyhtml
&lt;ul&gt;
  &lt;li&gt;AAA&lt;/li&gt;
  &lt;li&gt;123&lt;/li&gt;
  &lt;li&gt;True&lt;/li&gt;
&lt;/ul&gt;
</pre><a name="test_context/context.yaml"></a>

      <div class="program_caption">
        context.yaml
      </div>
      <pre class="program">
items:
  - AAA
  - 123
  - true
</pre><a name="test_context/result4.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ pytenjin <strong>-f context.yaml</strong> example.pyhtml
&lt;ul&gt;
  &lt;li&gt;AAA&lt;/li&gt;
  &lt;li&gt;123&lt;/li&gt;
  &lt;li&gt;True&lt;/li&gt;
&lt;/ul&gt;
</pre><br>
      <br>
      <a name="shooting" id="shooting"></a>

      <h2 class="section1">Trouble shooting</h2><a name="syntax-error" id="syntax-error"></a>

      <h3 class="section2">I got an SyntaxError exception.</h3>

      <p>Command-line option '-z' checks syntax of template file. You should check template by it.</p>

      <p>File 'syntaxerr.pyhtml':</p><a name="test_syntaxerr/syntaxerr.pyhtml"></a>
      <pre class="program">
&lt;?py #@ARGS ?&gt;
&lt;?py for i in range(0, 10): ?&gt;
&lt;?py     if i % 2 == 0: ?&gt;
#{i} is even.
&lt;?py     else ?&gt;
#{i} is odd.
&lt;?py     #endif ?&gt;
&lt;?py #endfor ?&gt;
</pre>

      <p>Result:</p><a name="test_syntaxerr/result.output"></a>
      <pre class="terminal">
$ pytenjin <strong>-z</strong> syntaxerr.pyhtml
syntaxerr.pyhtml:5:12: invalid syntax
  5:         else
                ^
</pre><br>
      <a name="encoding-syntaxerr" id="encoding-syntaxerr"></a>

      <h3 class="section2">I got 'SyntaxError: encoding declaration in Unicode string'</h3>

      <p>This is because you added magic comment (such as <code>&lt;?py # -*- coding: utf-8 -*- ?&gt;</code>) in template file AND you specified template encoding by <code>tenjin.set_template_encoding()</code> or pass encoding option to <code>tenjin.Engine()</code>.</p>

      <p>Solution:</p>

      <ul type="disc">
        <li>If you called <code>tenjin.set_template_encoding()</code>, remove magic comment.</li>

        <li>If you want to add magic comment, call <code>tenjin.set_template_encoding()</code> with <code>encode</code> option, or don't call it.</li>
      </ul><br>
      <a name="encoding-unicodedecodeerror" id="encoding-unicodedecodeerror"></a>

      <h3 class="section2">I got UnicodeDecodeError, but I can't find what is wrong</h3>

      <p>If you got UnicodeDecodeError, you should do the following solutions.</p>

      <ul type="disc">
        <li>Set logger to <code>tenjin.logger</code>. If you set, Tenjin will report the content of <code>_buf</code>.
          <pre class="program">
<strong>import logging</strong>
<strong>logging.basicConfig(level=logging.DEBUG)</strong>
<strong>tenjin.logger = logging</strong>
</pre>
        </li>
      </ul>

      <ul type="disc">
        <li>Render tempalte with specifying <code>_buf</code> and check it directly.
          <pre class="program">
<strong>_buf = []</strong>
try:
    engine.get_template("index.pyhtml").render(context, <strong>_buf=_buf</strong>)
    print(''.join(_buf))
except UnicodeDecodeError:
    for item in _buf:
        if isinstance(item, str):
            try:
                str.decode('ascii')
            except UnicodeDecodeError:
                print("*** failed to decode: %s" % repr(item))
</pre>
        </li>
      </ul><br>
      <a name="NameError: global name 'xxxx' is not defined"></a>

      <h3 class="section2">NameError: global name 'xxxx' is not defined</h3>

      <p>Assume the following template file.</p>
      <pre class="program">
&lt;?py

values = {'A': 10, 'B': 20}

def getval(key):
  return values.get(key, None)
#end

?&gt;
&lt;p&gt;getval('A') = ${getval('A')}&lt;/p&gt;
</pre>

      <p>This will raise NameError, such as:</p>
      <pre class="terminal">
$ python ex.py
Traceback (most recent call last):
  File "ex.py", line 5, in &lt;module&gt;
    output = engine.render('ex.pyhtml', context)
  File "tenjin.py", line 1582, in render
    content  = template.render(context, globals)
  File "tenjin.py", line 941, in render
    exec(self.bytecode, globals, locals)
  File "ex.pyhtml", line 10, in &lt;module&gt;
    &lt;p&gt;getval('A') = ${getval('A')}&lt;/p&gt;
  File "ex.pyhtml", line 6, in getval
    return values.get(key, None)
NameError: global name 'values' is not defined
</pre>

      <p>This is a restriction of Tenjin.</p>

      <p>Workaround:</p>

      <ul type="disc">
        <li>Pass values as default value of argument.</li>
      </ul>
      <pre class="program">
&lt;?py

values = {'A': 10, 'B': 20}

def getval(key, <strong>_values=values</strong>):   # works very well!
  return <strong>_values</strong>.get(key, None)
#end

?&gt;
&lt;p&gt;getval('A') = ${getval('A')}&lt;/p&gt;
</pre><br>
      <br>
      <a name="customize" id="customize"></a>

      <h2 class="section1">Customization Examples</h2>

      <p>This section shows how to customize pyTenjin.</p>

      <p><strong>Notice that these customization may be changed in the future release.</strong></p><a name="customize-encoding" id="customize-encoding"></a>

      <h3 class="section2">Template Encoding</h3>
      <pre class="program">
tenjin.set_template_encoding('cp932')   # or shift_jis
</pre><br>
      <a name="customize-escapefunc" id="customize-escapefunc"></a>

      <h3 class="section2">Escaping Function</h3>
      <pre class="program">
tenjin.Template.escapefunc = 'cgi.escape'
## or
engine = tenjin.Engine(escapefunc='cgi.escape')
</pre><br>
      <a name="customize-tostr" id="customize-tostr"></a>

      <h3 class="section2">Change Behaviour of <code>to_str()</code></h3>
      <pre class="program">
## encode unicode into str, and unchange str.
to_str = tenjin.helpers.generate_tostrfunc(encode='utf-8')
  # ex. 
  #   &gt;&gt;&gt; to_str('日本語')
  #   '\xe6\x97\xa5\xe6\x9c\xac\xe8\xaa\x9e'
  #   &gt;&gt;&gt; to_str(<strong>u</strong>'日本語')
  #   '\xe6\x97\xa5\xe6\x9c\xac\xe8\xaa\x9e'

## decode str into unicode, and unchange unicode.
to_str = tenjin.helpers.generate_tostrfunc(decode='utf-8')
  # ex.
  #   &gt;&gt;&gt; to_str("日本語")
  #   <strong>u</strong>'\u65e5\u672c\u8a9e'
  #   &gt;&gt;&gt; to_str(<strong>u</strong>"日本語")
  #   <strong>u</strong>'\u65e5\u672c\u8a9e'
</pre>

      <div class="note"><span class="caption">NOTE:</span>

      <p>It is recommended to call <code>tenjin.set_template_encoding()</code> instead of calling <code>tenjin.helpers.generate_tostrfunc()</code> directly because the former calls the latter internally.</p>

      </div><br>
      <a name="customize-notation" id="customize-notation"></a>

      <h3 class="section2">Embedded Notation</h3>
      <pre class="program">
class MyTemplate(tenjin.Template):

    STMT_PATTERN = re.compile(r'&lt;\?py( |\t|\r?\n)(.*?) ?\?&gt;([ \t]*\r?\n)?', re.S)

    def stmt_pattern(self):
        return self.STMT_PATTERN

    EXPR_PATTERN = re.compile(r'([#\$])\{(.*?)\}', re.S)

    def expr_pattern(self):
        return self.EXPR_PATTERN

    def get_expr_and_flags(self, match):
        prefix, expr = match.groups()
        flag_tostr  = True
        flag_escape = prefix == "$"   # escape if prefix is "$"
        return expr, (flag_escape, flag_tostr)

    def add_expr(self, buf, code, *flags):
        flag_escape, flag_tostr = flags
        if   flag_escape: buf.extend(("_escape(_to_str(", code, ")), "))
        elif flag_tostr:  buf.extend((        "_to_str(", code, "), "))
        else:             buf.extend((               "(", code, "), "))

tenjin.Engine.templateclass = MyTemplate
</pre><br>
      <a name="customize-safetemplate" id="customize-safetemplate"></a>

      <h3 class="section2">Custom Safe Template</h3>

      <p>For example you want to use <a href="http://pypi.python.org/pypi/MarkupSafe">MarkupSafe</a> module<sup>(<a href="#fnref:2" name="fnlink:2" id="fnlink:2">*2</a>)</sup>:</p>
      <pre class="program">
import tenjin
tenjin.set_template_encoding('utf-8')  # change templates to be unicode-base
from tenjin.helpers import *
from tenjin.html import *

## import Markup
from markupsafe import Markup, escape_silent

## change SafeTemplate to use Markup
tenjin.SafeTemplate.tostrfunc      = 'Markup'
tenjin.SafeTemplate.escapefunc     = 'Markup.escape' # or 'escape_silent'
tenjin.SafePreprocessor.tostrfunc  = 'Markup'
tenjin.SafePreprocessor.escapefunc = 'Markup.escape' # or 'escape_silent'

## change safe helpers to use Markup
import tenjin.escape
tenjin.escaped.is_escaped = lambda x: isinstance(x, Markup)
tenjin.escaped.as_escaped = Markup
tenjin.escaped.to_escaped = Markup.escape # or escape_silent
from tenjin.escaped import is_escaped, as_escaped, to_escaped
</pre>

      <div class="note"><span class="caption">NOTE:</span>

      <p>You must call <code>tenjin.set_template_encoding()</code> to change pyTenjin to be unicode-based because MarkupSafe requires it.</p>

      </div>

      <div class="footnote">
        <dl compact>
          <dt>(<a name="fnref:2" href="#fnlink:2" id="fnref:2">*2</a>)</dt>

          <dd>MarkupSafe is a module to enable auto-escape on Jinja2 or other python products.</dd>
        </dl>
      </div><br>
      <a name="customize-helper" id="customize-helper"></a>

      <h3 class="section2">Custom Html Helper Function</h3>
      <pre class="program">
from tenjin.escaped import as_escaped, to_escaped

def js_link(label, onclick):
    html = '&lt;a href="javascript:undefined" onclick="%s;return false"&gt;%s&lt;/a&gt;' % \
              (to_escaped(onclick), to_escaped(label))
    return as_escaped(html)
</pre><br>
      <a name="customize-templateclass" id="customize-templateclass"></a>

      <h3 class="section2">Switch Default Template Class</h3>
      <pre class="program">
tenjin.Engine.templateclass = MyTemplate
tenjin.Engine.preprocessorclass = MyPreprocessor
#
tenjin.SafeEngine.templateclass = MySafeTemplate
tenjin.SafeEngine.preprocessorclass = MySafePreprocessor
</pre><br>
      <a name="customize-loader" id="customize-loader"></a>

      <h3 class="section2">Change Template Loader</h3>
      <pre class="program">
class MyFileSystemLoader(tenjin.FileSystemLoader):
   def load(self, filepath):
     ...

tenjin.Engine.loader = MyFileSystemLoader()
## or
engine = tenjin.Engine(finder=MyFileSystemLoader())
</pre><br>
      <a name="customize-cachestorage" id="customize-cachestorage"></a>

      <h3 class="section2">Change Template Cache Storage</h3>
      <pre class="program">
tenjin.Engine.cache = tenjin.MemoryCacheStorage()
## or
engine = tenjin.Engine(cache=tenjin.MemoryCacheStorage())
</pre><br>
      <a name="customize-kvstore" id="customize-kvstore"></a>

      <h3 class="section2">Change Fragment Cache Store</h3>
      <pre class="program">
if not os.path.isdir('cache.d'):
    os.mkdir('cache.d')
kv_store = tenjin.FileBaseStore('cache.d')      # file based
tenjin.helpers.fragment_cache.store = kv_store
</pre><br>
      <br>
    </div>
  </blockquote>
</body>
</html>
