{% extends "base.html" %}

{% block headtitle %}Contributions to Corp tax{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}ecm/css/jquery-ui-1.8.13.custom.css" />
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}accounting/css/classes.css" />
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}hr/css/classes.css" />
{% endblock %}



{% block breadcrumbs %}
<li><a href="/">Home</a></li>
<li><a href="/accounting/">Accounting</a></li>
<li><a href="/accounting/contributions/">Contributions</a></li>
{% endblock %}

{% block main_content %}
<h1>Contributions to Corp tax <small>last update {{ scan_date|ecm_datetime }}</small></h1>

<form id="search_form" class="form-search form-inline btn-toolbar center">
  <div class="control-group info" style="display: inline;">
    <span class="label label-info">Period</span>
    <select id="period_selector" class="input-small">
      <option value="all" selected="selected">All Time</option>
      <option value="thismonth">This Month</option>
      <option value="week">Last Week</option>
      <option value="month">Last Month</option>
      <option value="year">Last Year</option>
    </select>
    <span class="label label-info">From</span>
    <input type="text" id="from_date" name="from_date" value="{{ from_date }}" class="input-small"/>
    <span class="label label-info">To</span>
    <input type="text" id="to_date" name="to_date" value="{{ to_date }}" class="input-small"/>
    <a class="btn btn-info btn-small" id="refresh_table"><i class="icon-refresh icon-white"></i> Refresh</a>
  </div>
</form>

<div class="center well">
    <h2>Total tax income: <span class="credit" id="total_contribs">{{total_contribs|ecm_price}}</span> ISK</h2>
</div>

<div class="row-fluid">
  <div class="span6">
    <table class="table table-bordered table-condensed" id="member_contrib_table">
      <thead>
        <tr>
          <th class="top" scope="col" >Member</th>
          <th class="top" scope="col" >Contributions</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="2" class="dataTables_empty">Loading data from server...</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <th>Member</th>
          <th>Contributions</th>
        </tr>
      </tfoot>
    </table>
  </div>
  <div class="span6">
    <table class="table table-bordered table-condensed" id="system_contrib_table">
      <thead>
        <tr>
          <th class="top" scope="col" >Solar System</th>
          <th class="top" scope="col" >Contributions</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="2" class="dataTables_empty">Loading data from server...</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <th>Solar System</th>
          <th>Contributions</th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
{% endblock %}



{% block compressed_javascripts %}
<script type="text/javascript" src="{{ STATIC_URL }}ecm/js/lib/jquery.ui.js"></script>
<script type="text/javascript">
FROM_DATE = "{{ from_date }}";
TO_DATE = "{{ to_date }}";
DAY = 1000 * 60 * 60 * 24;
WEEK = DAY * 7;
MONTH = DAY * 30;
YEAR = DAY * 365;
$(document).ready(function() {
    var table1 = $('#member_contrib_table').dataTable($.extend(true, {}, DATATABLE_DEFAULTS, {
        sAjaxSource: "/accounting/contributions/members/data/",
        aaSorting: [[1,'desc']],
        aoColumns: [
            { /* Member */       sWidth: "50%",   sType: "html" },
            { /* Contributions */     sWidth: "50%",   sType: "html" , sClass : "right"   }
        ],
        fnRowCallback: function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
            $('td:eq(1)', nRow).addClass('credit');
            return nRow;
        },
        /* this function will be called when the table has to query data to be displayed */
        fnServerData: function ( sSource, aoData, fnCallback ) {
            /* Add some extra variables to the url */
            aoData.push( {
                name: "from_date",
                value: $("#from_date").val()
            }, {
                name: "to_date",
                value: $("#to_date").val()
            } );

            $.getJSON( sSource, aoData, function (json) {
                fnCallback(json)
            } );
        },

    }));
    
    var table2 = $('#system_contrib_table').dataTable($.extend(true, {}, DATATABLE_DEFAULTS, {
        sAjaxSource: "/accounting/contributions/systems/data/",
        aaSorting: [[1,'desc']],
        aoColumns: [
            { /* Solar System */       sWidth: "50%",   sType: "html" },
            { /* Contributions */     sWidth: "50%",   sType: "html" , sClass : "right"   }
        ],
        fnRowCallback: function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
            $('td:eq(1)', nRow).addClass('credit');
            return nRow;
        },

        /* this function will be called when the table has to query data to be displayed */
        fnServerData: function ( sSource, aoData, fnCallback ) {
            /* Add some extra variables to the url */
            aoData.push( {
                name: "from_date",
                value: $("#from_date").val()
            }, {
                name: "to_date",
                value: $("#to_date").val()
            } );

            $.getJSON( sSource, aoData, function (json) {
                fnCallback(json)
            } );
        },

    }));

    $("#refresh_table").click(function () {
        table1.fnDraw();
    });
    $("#refresh_table").click(function () {
        table2.fnDraw();
    });
    $("#refresh_table").click(function() {
        var params = {
            from_date: $("#from_date").val(),
            to_date: $("#to_date").val()
        };
        $("#total_contribs").load('/accounting/contributions/total/data/', params);
    });

    $("#period_selector").change(function() {
        var period = $("#period_selector option:selected").val();
        if (period == "all") {
            $("#from_date").val(FROM_DATE);
            $("#to_date").val(TO_DATE);
        } else if (period == "thismonth") {
            var date = $.datepicker.parseDate('yy-mm-dd', TO_DATE);
            date.setTime(Date.UTC(date.getFullYear(),date.getMonth(),1));
            $("#from_date").val($.datepicker.formatDate("yy-mm-dd", date));
            $("#to_date").val(TO_DATE);
        } else if (period == "week") {
            var date = $.datepicker.parseDate('yy-mm-dd', TO_DATE);
            date.setTime(date.getTime() - WEEK);
            $("#from_date").val($.datepicker.formatDate("yy-mm-dd", date));
            $("#to_date").val(TO_DATE);
        } else if (period == "month") {
            var date = $.datepicker.parseDate('yy-mm-dd', TO_DATE);
            date.setTime(date.getTime() - MONTH);
            $("#from_date").val($.datepicker.formatDate("yy-mm-dd", date));
            $("#to_date").val(TO_DATE);
        } else if (period == "year") {
            var date = $.datepicker.parseDate('yy-mm-dd', TO_DATE);
            date.setTime(date.getTime() - YEAR);
            $("#from_date").val($.datepicker.formatDate("yy-mm-dd", date));
            $("#to_date").val(TO_DATE);
        }
    });

    $(function() {
        var dates = $( "#from_date, #to_date" ).datepicker({
            dateFormat: 'yy-mm-dd',
            defaultDate: "{{ to_date }}",
            changeMonth: true,
            numberOfMonths: 1,
            onSelect: function( selectedDate ) {
                var option = this.id == "from_date" ? "minDate" : "maxDate",
                    instance = $( this ).data( "datepicker" ),
                    date = $.datepicker.parseDate(
                        instance.settings.dateFormat ||
                        $.datepicker._defaults.dateFormat,
                        selectedDate, instance.settings );
                dates.not( this ).datepicker( "option", option, date );
            }
        });
    });
    
    /* disable multi column sorting */
    $('#member_contrib_table thead th').click(function(event) {
        if (!$(event.target).hasClass('sorthandle')) {
            event.shiftKey = false;
        }
    });

} );

</script>
{% endblock %}





