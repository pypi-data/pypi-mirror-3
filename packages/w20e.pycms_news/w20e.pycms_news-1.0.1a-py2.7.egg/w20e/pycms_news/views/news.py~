from repoze.catalog.query import Eq


class NewsViewlet(object):

    def __init__(self, context, request):

        self.context = context
        self.request = request

        self.limit = self.request.get('kwargs', {}).get('limit', 5)


    def __call__(self):

        cat = self.context.root._catalog

        res = cat.query(Eq('ctype', 'news'))

        objs = []

        for result in res[1]:
            obj = cat.get_object(result)

            if obj:
                objs.append({"title": obj.title,
                             "date": obj.created.strftime('%d-%m-%Y'),
                             "sortdate": obj.created.strftime('%Y%m%d'),
                             "url": "/nieuws",
                             "text": obj.text})

        def newest_sort(a, b):

            return cmp(b['sortdate'], a['sortdate'])

        objs.sort(newest_sort)
                
        return {'newslisting': objs[:self.limit]}
