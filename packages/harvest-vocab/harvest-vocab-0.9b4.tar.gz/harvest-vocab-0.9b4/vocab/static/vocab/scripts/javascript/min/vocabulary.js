define(["jquery","underscore","cilantro/define/viewelement"],function(a,b,c){var d,e,f,g,h;return d='<% for (var b, i = 0; i < breadcrumbs.length; i++) { %>\n    <% b = breadcrumbs[i]; %>\n    <% if (i === (breadcrumbs.length-1)) {%>\n        <h3 title="<%= b.name %>"><%= b.name %></h3>\n    <% } else { %>\n        &raquo; <a href="<%= b.uri %>" title="<%= b.name %>"><%= b.name %></a>\n    <% } %>\n<% } %>',e='<li data-id="<%= id %>" data-uri="<%= uri %>" <% if (!terminal) { %>class="folder"<% } %>>\n    <button class="button-add">+</button>\n    <span><%= name %>\n        <% if (attrs) { %>\n            <br><small class="info"><% for (var k in attrs) { %>\n                <%= k %>: <%= attrs[k] %>\n            <% } %></small>\n        <% } %>\n    </span>\n</li>',f='<li data-id="<%= id %>" <% if (!terminal) { %>class="folder"<% } %>>\n    <button class="button-add">+</button>\n    <span>\n        <% if (search_only) { %>\n            <span><%= name %></span>\n        <% } else { %>\n            <a href="<%= parent.uri %>"><%= name %></a>\n        <% } %>\n        <% if (attrs) { %>\n            <br><small class="info"><% for (var k in attrs) { %>\n                <%= k %>: <%= attrs[k] %>\n            <% } %></small>\n        <% } %>\n    </span>\n</li>',g='<li data-id="<%= id %>" <% if (!terminal) { %>class="folder"<% } %>>\n    <button class="button-remove">-</button>\n    <% if (search_only) { %>\n        <span><%= name %></span>\n    <% } else { %>\n        <a href="<%= parent.uri %>"><%= name %></a>\n    <% } %>\n</li>',h='<div class="browser">\n    <% if (!search_only) { %>\n        <div class="tabs">\n            <a class="tab" href="#browse-tab-<%= pk %>">Browse <%= title %></a>\n            <a class="tab" href="#search-tab-<%= pk %>">Search <%= title %></a>\n        </div>\n    <% } %>\n    <div>\n        <% if (!search_only) { %>\n            <div id="browse-tab-<%= pk %>">\n                <div class="breadcrumbs"></div>\n                <ul class="list choices"></ul>\n            </div>\n        <% } %>\n\n        <div id="search-tab-<%= pk %>">\n            <form method="get" action="<%= directory %>">\n                <input type="text" class="search" name="q" placeholder="Search...">\n                <em>Note: only the first 100 results are displayed</em>\n            </form>\n            <div>\n                <ul class="list results">\n                    <li class="start">Enter search terms above. Results can be clicked to go to their location in the Browse tab.</li>\n                </ul>\n            </div>\n        </div>\n\n        <h2>Selected <%= title %></h2>\n        <small>Note: this query is currently limited to getting results having at least ONE of these <%= title.toLowerCase() %>.</small>\n        <ul class="list selected"></ul>\n    </div>\n</div>',c.extend({constructor:function(a,b){return this.base(a,b),this.ds=[]},render:function(){var c,d,e,f,g,i,j,k,l,m,n;return c=function(b){var c;return c=a(this).parent(),i.addNode(c.data()),!1},g=function(b){var c,d;return c=a(this),d=c.parents("li"),n.tabs("toggle",0),i.reloadBrowser(c.attr("href"),function(){var b;return b=a("[data-id="+d.data("id")+"]",i.choices),i.choices.scrollTo(b,500,{offset:-150,onAfter:function(){return b.effect("highlight",null,2e3)}})}),!1},i=this,j=this.pk=this.concept_pk+"_"+this.viewset.pk,f=this.dom=a(b.template(h,this.viewset)),n=a(".tabs",f),e=this.choices=a(".choices",f),m=this.selected=a(".selected",f),l=this.search=a(".search",f),k=this.results=a(".results",f),d=this.breadcrumbs=a(".breadcrumbs",f),n.tabs(!1,function(b,c){var d;return d=n.find(".tab"),d.each(function(b,c){return a(c.hash,i.dom).hide()}),a(c.prop("hash"),i.dom).show()}),d.delegate("a","click",function(){return i.reloadBrowser(a(this).attr("href")),!1}),e.delegate("button","click",c),k.delegate("button","click",c),k.delegate("a","click",g),m.delegate("a","click",g),e.delegate(".folder","click",function(){return i.reloadBrowser(a(this).data("uri")),!1}),m.delegate("button","click",function(){var b,c;return c=a(this),b=c.parent(),i.removeNode(b.data()),b.remove(),!1}),this.execute()},execute:function(){var b,c;return b=this,c=this.results,this.reloadBrowser(),this.search.autocomplete2({start:function(){return c.block()},success:function(d,e){c.empty();if(!e.length){c.html('<li class="empty">No results found.</li>');return}return a.each(e,function(a,d){var e;return e=b.renderListElement(d,f),c.append(e)}),b.refreshBrowser(),c.unblock()}})},updateDS:function(b,c){var d,e,f,g;e=this,f=/operator$/,this.refreshBrowser();if(!a.isEmptyObject(c)){g=[];for(d in c){if(f.test(d))continue;g.push(a.each(c[d],function(b,c){return a.ajax({url:e.viewset.directory+c+"/",success:function(a){return e.addNode(a)}})}))}return g}},updateElement:function(a,b){},elementChanged:function(a,b){},reloadBrowser:function(c,f){var g,h;return c=c||this.viewset.directory,f=f||function(){},h=this,g=[{name:"All",uri:this.viewset.directory}],this.choices.block(),a.getJSON(c,function(c){var i,j,k,l,m;h.choices.empty(),h.breadcrumbs.empty(),a.isArray(c)?l=c:(l=c.children,g=g.concat(c.ancestors.length?c.ancestors:[]),g.push({name:c.name})),j=void 0,k=void 0,i=0;while(i<l.length)k=l[i],j=h.renderListElement(k,e),h.choices.append(j),i++;return m=b.template(d,{breadcrumbs:g}),h.breadcrumbs.html(m),h.refreshBrowser(),f(),h.choices.unblock()})},renderListElement:function(c,d){var e;return c.parent||(!c.ancestors||c.ancestors.length===0?c.parent={uri:this.viewset.directory}:c.parent={uri:c.ancestors[0].uri}),c.search_only=this.viewset.search_only,e=a(b.template(d,c)),e.data(c),e},addNode:function(a){var b;return this.ds.indexOf(a.id)<0&&(this.ds.push(a.id),b=this.renderListElement(a,g),this.selected.append(b)),this.dom.trigger("ElementChangedEvent",[{name:this.pk,value:this.ds}]),this.refreshBrowser()},removeNode:function(a){var b;return b=void 0,(b=this.ds.indexOf(a.id))>-1&&this.ds.splice(b,1),this.dom.trigger("ElementChangedEvent",[{name:this.pk,value:this.ds.length>0?this.ds:"undefined"}]),this.refreshBrowser()},refreshBrowser:function(){var b,c,d,e;a("li",this.choices).removeClass("added"),a("button",this.choices).attr("disabled",!1),a("li",this.results).removeClass("added"),a("button",this.results).attr("disabled",!1),c=void 0,d=void 0,b=this.ds.length,e=[];while(b--)c=this.ds[b],a("li[data-id="+c+"]",this.choices).addClass("added").find("button").attr("disabled",!0),e.push(a("li[data-id="+c+"]",this.results).addClass("added").find("button").attr("disabled",!0));return e}})})