<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Dashboard</title>
	<style type="text/css">
		body { font-family: "Helvetica Neue", "Helvetica", "Arial", sans-serif; font-size: 13px; color: #fff; background: #000; margin: 0; }
		h1,h2,h3,h4,h5,h6 { color: #fff; font-weight: normal; }
		a { color: #ccc; text-decoration: none; font-weight: normal; }
		a:hover { color: #fff; }
		.align-right { text-align: right; }
		.map { border-bottom: 1px dashed #444; padding: 5px 5px 10px 5px; margin: 0; }
		.map_title { margin: 5px 0 5px 10px; }
		.map_title span { color: #bbb; }
		.host { display: inline-block; background: #333; border: 1px solid #555; border-bottom-width: 6px; border-radius: 5px; padding: 8px 10px; margin: 5px; }
		.host h2 { margin: 0 0 5px 0; text-shadow: 1px 1px 0px #000; }
		.host h2 a { visibility: hidden; }
		.host h2:hover a { visibility: visible; }
		.host.code-0 { background: #232; border-color: #151; box-shadow: 0px 0px 10px #262; }
		.host.code-2 { background: #611; border-color: #822; box-shadow: 0px 0px 15px #822; }
		.host.code-1 { background: #661; border-color: #882; box-shadow: 0px 0px 5px #882; }
		.service { display: inline-block; padding: 2px 5px; margin: 2px 2px; background: #333; border: 1px solid #666; color: #fff; border-radius: 5px; }
		.service.code-0 { background: #3a3; border-color: #6c6; color: #fff; }
		.service.code-2 { background: #f33; border-color: #f66; color: #fff; box-shadow: 0px 0px 5px #f66; }
		.service.code-1 { background: #ff3; border-color: #ff6; color: #222; box-shadow: 0px 0px 5px #ff6; }
		#tooltip { position: fixed; top: 0; right: 20px; color: #888; background: #333; border: 1px solid #444;
			border-top: none; border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; overflow: hidden; }
		#tooltip .wrap { padding: 10px 10px 5px 10px; }
		#tooltip p { margin: 0; font-size: 12px; }
		#tooltip .updater { font-weight: bold; color: #aaa; }
		#tooltip.warning { background: #611; border-color: #822; box-shadow: 0px 0px 15px #822; color: #ddd; }
		#tooltip.warning .updater { color: #fff; }
		#tooltip .loader { height: 5px; background: #444; color: #444; overflow: hidden;
			border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; }
		#tooltip.warning .loader { background: #822; color: #822; }
	</style>
</head>
<body>

<div id="content">
	<p>No data available!</p>
</div>
<div id="tooltip" class="align-right">
	<div class="wrap">
		<p>Last update was <span class="updater"></span> minutes ago.</p>
	</div>
	<div class="loader">0</div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/jquery.min.js"><\/script>')</script>
<script type="text/javascript">
	var Dx = {};
	Dx.REFRESH_RATE = 30 * 1000; // how often should the page check for updates (in milliseconds)
	Dx.LOADER_RATE = 100; // loader refresh rate (in milliseconds)
	Dx.MAX_TIME_DIFF = 5 * 60 * 1000; // at what time difference should a warning be displayed (in milliseconds)
	Dx.content = $('#content'); // container to be replaced with content
	Dx.tooltip = $('#tooltip'); // container that displays time related info
	Dx.loader = $('#tooltip .loader'); // container for the loader
	Dx.updater = $('#tooltip .updater'); // container for the update time
	Dx.last_update = new Date(0);
	$(function(){
		updateData();
		setInterval(updateData, Dx.REFRESH_RATE);
		setInterval(increaseLoader, Dx.LOADER_RATE);
	});
	function parseData(data) {
		var result = '';
		$.each(data, function(map_key, map) {
			if (map.groups.length) $.each(map.groups, function(group_key, group) {
				result += '<div class="map">';
				result += '<h1 class="map_title">'+map.name+'<span title="'+group.type+'"> - '+group.name+'</span></h1>';
				if (group.hosts.length) $.each(group.hosts, function(host_key, host) {
					result += '<div class="host code-'+host.code+'">';
					result += '<h2>'+host.hostname+'</h2>';
					if (host.hostgroup.length) $.each(host.hostgroup, function(service_key, service) {
						result += '<span class="service code-'+service.code+'" title="'+service.text+'">'+service.servicename+'</span>';
					});
					result += '</div>';
				});
				result += '</div>';
			});
		});
		return result;
	}
	function updateData() {
		$.ajax({
			url: '/',
			headers: { "Accept": "application/json" },
			dataType: 'json',
			success: function (data) {
				//console.log(data);
				Dx.content.html(parseData(data.maps));
				setLastUpdate(data.updated_at);
				resetTimer();
			},
			error: function (jqXHR, textStatus, errorThrown) {
				console.log('Error: '+textStatus);
				setLastUpdate(false);
				resetTimer();
			}
		});
	}
	function setLastUpdate(unixtime) {
		if (unixtime) Dx.last_update = new Date(unixtime*1000);
		var formatted_date = pad(Dx.last_update.getHours(), 2)+':'+pad(Dx.last_update.getMinutes(), 2)+':'+
				pad(Dx.last_update.getSeconds(), 2)+', '+pad(Dx.last_update.getDate(), 2)+'.'+
				pad((Dx.last_update.getMonth()+1), 2)+'.'+Dx.last_update.getFullYear();
		var now = new Date();
		var time_diff = now - Dx.last_update;
		if (time_diff > Dx.MAX_TIME_DIFF) {
			Dx.tooltip.addClass('warning');
		}
		Dx.updater.html(Math.ceil(time_diff/1000/60)); // minutes
		Dx.updater.val('title', formatted_date);
	}
	function increaseLoader() {
		if (Dx.loader.html().length < 1) Dx.loader.html(0);
		Dx.loader.html(parseInt(Dx.loader.html())+1);
		Dx.loader.css('width', Math.min(parseInt(Dx.loader.html()) * Dx.LOADER_RATE * 100 / Dx.REFRESH_RATE, 100) + '%' );
	}
	function resetTimer() {
		Dx.loader.html(0);
	}
	function pad(num, size) {
		var s = num+"";
		while (s.length < size) s = "0" + s;
		return s;
	}
</script>
</body>
</html>
