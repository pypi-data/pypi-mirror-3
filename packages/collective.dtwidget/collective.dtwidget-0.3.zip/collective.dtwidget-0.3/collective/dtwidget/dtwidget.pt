<div tal:define="
    context nocall:view/context/context;
    portal_url context/@@plone_portal_state/portal_url;
    ">

   <span tal:replace="structure string:<script><!--" />
if (typeof(Calendar) == 'undefined') {
    var css = '<span tal:replace="string:$portal_url/jscalendar/calendar-system.css"/>',
        cal_stripped = '<span tal:replace="string:$portal_url/jscalendar/calendar_stripped.js"/>',
        cal_en = '<span tal:replace="string:$portal_url/jscalendar/calendar-en.js"/>';

   $('head')
      .append('<link type="text/css" rel="stylesheet" media="screen" href="' + css + '"/>')
      .append('<script type="text/javascript" src="' + cal_stripped + '"/>')
      .append('<script type="text/javascript" src="' + cal_en + '"/>');
}
   <span tal:replace="structure string:--></script>" />

   <tal:to define="
      inputname view/name;
      formname string:form_${context/__name__};
      inputvalue view/getDT
      ">
    <metal:box use-macro="context/calendar_macros/macros/calendarDatePickerBox">
      <!-- a calendar, hopefully -->
    </metal:box>
  </tal:to>
  <script type="text/javascript">
    // Fix generated ids (zope.form likes periods, but the calendar JS doesn't handle these so well)
    jQuery('.plone_jscalendar').find('input[id*="."], select[id*="."], span[id*="."]').each(function() { this.id = this.id.replace(/([^a-z0-9:_])/ig, '_'); });
  </script>

</div>
