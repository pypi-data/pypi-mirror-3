<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">

  <body>

    <div metal:fill-slot="main"
         tal:define="errors options/state/getErrors;
                     lockable python:hasattr(here, 'wl_isLocked');
                     isLocked python:lockable and here.wl_isLocked();
                     signatories here/signatories;
		     member here/portal_membership/getAuthenticatedMember;
                     able_to_sign here/hasMemberSignature">

      <h1 i18n:translate="heading_edit_item">
        Sign
        <span tal:replace="context/title_or_id"/>
      </h1>

      <p class="formHelp">In order to sign this document, you must have installed BastionCrypto
       <a href="http://www.last-bastion.net/BastionCrypto">helper</a> for your operating system
       (this is available as the <em>BastionCrypto-helper</em> package in <a href="https://linux.last-bastion.net/LBN/up2date/rpmmanager_channel_search?name=BastionCrypto-helper">BastionLinux</a>).</p>

      <p class="formHelp">You must also have your web browser configured to invoke the helper for
       <code>application/x-bastioncrypto</code> content types.</p>

      <p class="formHelp">Unfortunately, because signing technically happens outside your browser,
       you must also manually <a href="" 
           tal:attributes="href string:${here/absolute_url}/signed_document_sign_form">Refresh</a> 
       this page once you've completed signing it to see your signature.</p>

      <form name="signature_form" action="" method="post" 
            tal:attributes="action string:${request/URL1}/sign_bastioncrypto">

         <fieldset tal:define="siginfos here/getSignatoryInfo">
             <legend>Signatories</legend>

            <dl>
               <span tal:repeat="siginfo siginfos" tal:omit-tag="">
                   <dt>
                       <img src="" tal:attributes="src here/icon"/>
                       <a href="" tal:attributes="href siginfo/absolute_url" tal:content="siginfo/name"/>
                   </dt>
                   <dd><span tal:replace="siginfo/date"/></dd>
               </span>
            </dl>

            <div tal:condition="not: siginfos">Document is unsigned</div>

            <img src="" class="context"
                   tal:define="portal context/portal_url/getPortalObject; locked portal/lock_icon.gif;"
                   tal:condition="isLocked"
                   tal:replace="structure python:locked.tag(title='This item is locked')"
                   alt="Object locked"
                   i18n:attributes="alt"/>

            <input class="context" tal:condition="able_to_sign"
                   type="submit"
                   name="form.button.Sign"
                   value="Sign"
                   i18n:attributes="value"
                   tal:attributes="disabled python:test(isLocked, 'disabled', None);" />

            <span class="formHelp" tal:condition="not: able_to_sign">Add your PGP Key
               <a href="" 
                  tal:attributes="href string:${here/pks/absolute_url}/pgp_add_form">here</a>...</span>

            <span class="formHelp" tal:condition="not: member/email">Set your email address
               <a href="/personalize_form" 
                  tal:attributes="href string:${portal_url}/personalize_form">here</a>...</span>
         </fieldset>

         <input type="hidden" name="form.submitted" value="1" />

      </form>


      <div metal:use-macro="here/document_byline/macros/byline">
        Get the byline - contains details about author and modification date.
      </div>

    </div>

  </body>
</html>
