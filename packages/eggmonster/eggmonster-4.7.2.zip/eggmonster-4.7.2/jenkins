#!/bin/bash

virtualenv --no-site-packages env
sudo aptitude install -y libevent-dev python2.7-dev
# remove the dist directory
rm -R dist || echo -n
# build an sdist in dist/
env/bin/python setup.py sdist
# install the sdist just created (with [server])
env/bin/easy_install -U -f "dist http://cheeseshop.polimetrix.com" eggmonster[server]
# jaraco.compat 0.8 or greater is required for tests
env/bin/easy_install 'jaraco.compat>=0.8'
env/bin/python ./run-tests.py --verbose --ignore env "--junitxml=test results.xml"
sudo aptitude remove -y libevent-dev python2.7-dev
