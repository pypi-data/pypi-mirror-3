

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Schema Revisions and Migrations &mdash; Camelot  documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Camelot  documentation" href="../index.html" />
    <link rel="up" title="Camelot Documentation" href="index.html" />
    <link rel="next" title="Camelot Shortcuts" href="shortcuts.html" />
    <link rel="prev" title="Managing a Camelot project" href="manage.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2652891-3']);
  _gaq.push(['_trackPageview']);
</script>

  </head>
  <body>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="shortcuts.html" title="Camelot Shortcuts"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="manage.html" title="Managing a Camelot project"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Camelot  documentation</a> &raquo;</li>
          <li><a href="../contents.html" >Camelot Documentation contents</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Camelot Documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="schema-revisions-and-migrations">
<span id="doc-schemas"></span><h1>Schema Revisions and Migrations<a class="headerlink" href="#schema-revisions-and-migrations" title="Permalink to this headline">¶</a></h1>
<p>Schema revisions and migrations is a serious issue when you develop
a application beyond a certain scale.</p>
<p>there is no functionallity in Camelot as such for handling this
&#8216;automagically&#8217;.</p>
<p>The recommended approach is to use sqlalchemy-migrate <a class="reference external" href="http://code.google.com/p/sqlalchemy-migrate/">http://code.google.com/p/sqlalchemy-migrate/</a>
It requires a bit of an effort to set it up and understand it, but once you got it up and running,
it&#8217;s well worth the effort.</p>
<p>There are 2 approaches, depending on the needs of your project :</p>
<div class="section" id="leave-it-all-to-sqlalchemy-migrate">
<h2>Leave it all to sqlalchemy-migrate<a class="headerlink" href="#leave-it-all-to-sqlalchemy-migrate" title="Permalink to this headline">¶</a></h2>
<p>Let sqlalchemy-migrate do a diff between your model and your db and add tables / columns
as needed.  This is easy to implement, but not very powerfull and will fail on complex
migrations.</p>
<p>Camelot comes with a function that uses sqlalchemy-migrate to perform such action :</p>
<dl class="function">
<dt id="camelot.core.sql.update_database_from_model">
<tt class="descclassname">camelot.core.sql.</tt><tt class="descname">update_database_from_model</tt><big>(</big><big>)</big><a class="headerlink" href="#camelot.core.sql.update_database_from_model" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Call this function in the setup_model function in settings.py, right after
the setup_all function.</p>
</div>
<div class="section" id="use-schema-revisions">
<h2>Use schema revisions<a class="headerlink" href="#use-schema-revisions" title="Permalink to this headline">¶</a></h2>
<p>Work with database revisions (takes some work to get up and
running, but very nice), you can even create database views and
update those views as well, and migrate data to the next
schema revision etc.</p>
<p>A possible scenario is to create a <tt class="xref py py-meth docutils literal"><span class="pre">migrate_model()</span></tt> method.  This
<tt class="xref py py-meth docutils literal"><span class="pre">migrate_model()</span></tt> needs to be called inside the <tt class="xref py py-meth docutils literal"><span class="pre">setup_model()</span></tt> of
settings.py before anything else happens:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">controlled_schema</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get or create a ControlledSchema for an engine&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">settings</span>
    <span class="kn">from</span> <span class="nn">migrate.versioning.schema</span> <span class="kn">import</span> <span class="n">ControlledSchema</span>
    <span class="kn">from</span> <span class="nn">migrate</span> <span class="kn">import</span> <span class="n">exceptions</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">ControlledSchema</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span>
                                         <span class="n">settings</span><span class="o">.</span><span class="n">REPOSITORY</span><span class="p">,</span>
                                         <span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DatabaseAlreadyControlledError</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">ControlledSchema</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">REPOSITORY</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;current database version : </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">schema</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">schema</span>

<span class="k">def</span> <span class="nf">migrate_model</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">settings</span>
    <span class="n">migrate_engine</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENGINE</span><span class="p">()</span>
    <span class="n">migrate_connection</span> <span class="o">=</span> <span class="n">migrate_engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="n">controlled_schema</span><span class="p">(</span><span class="n">migrate_engine</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">migrate.versioning.repository</span> <span class="kn">import</span> <span class="n">Repository</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">Repository</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">REPOSITORY</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;latest available version : </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">latest</span><span class="p">))</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">latest</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">upgrade</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
    <span class="n">migrate_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Where settings.REPOSITORY is the directory of the sqlalchemy-migrate
repository.  For more source code, have a look at the source of
<a href="#id1"><span class="problematic" id="id2">:module:`camelot.bin.camelot_manage`</span></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Schema Revisions and Migrations</a><ul>
<li><a class="reference internal" href="#leave-it-all-to-sqlalchemy-migrate">Leave it all to sqlalchemy-migrate</a></li>
<li><a class="reference internal" href="#use-schema-revisions">Use schema revisions</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="manage.html"
                        title="previous chapter">Managing a Camelot project</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="shortcuts.html"
                        title="next chapter">Camelot Shortcuts</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/doc/schemas.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="shortcuts.html" title="Camelot Shortcuts"
             >next</a> |</li>
        <li class="right" >
          <a href="manage.html" title="Managing a Camelot project"
             >previous</a> |</li>
        <li><a href="../index.html">Camelot  documentation</a> &raquo;</li>
          <li><a href="../contents.html" >Camelot Documentation contents</a> &raquo;</li>
          <li><a href="index.html" >Camelot Documentation</a> &raquo;</li> 
      </ul>
    </div>

<br/>
<a href="http://example.com/my_article.html#disqus_thread">Comments</a>
<br/>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /**
    * var disqus_identifier; [Optional but recommended: Define a unique identifier (e.g. post id or slug) for this thread] 
    */

  /** var disqus_developer = 1 **/

  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'http://camelot.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=camelot">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2009 - 2011, Conceptive Engineering.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.
    </div>
<div class="footer">
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

<script type="text/javascript">
var disqus_shortname = 'camelot';
(function () {
  var s = document.createElement('script'); s.async = true;
  s.src = 'http://disqus.com/forums/camelot/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



  </body>
</html>