# Rhaptos2                                                                                 
# ToDO: privileges - run as www-data or other user 
# http://superuser.com/questions/213416/running-upstart-jobs-as-unprivileged-users                                                                                   


description     "Rhaptos2"

start on runlevel [2345]
stop on runlevel [!2345]

#enable starting multiple instances on one server, diff ports
instance $PORT


pre-start script
    echo '**** start on $PORT'    |	  logger -ist 'rhaptos2'					   
end script

post-stop script
    echo '*** stopping $PORT' | logger -ist 'rhaptos2'					   
end script


## We MUST pass in two 
## sudo service rhaptos2 start PORT=7999 CONFIGFILE=/etc/rhaptos2.ini
## PORT acts as in instance variable, CONFIGFILE is repeated and picked up in os.environ

env rhaptos2_repodir=%(rhaptos2_repodir)s
env rhaptos2_statsd_host=%(rhaptos2_statsd_host)s
env rhaptos2_statsd_port=%(rhaptos2_statsd_port)s
env rhaptos2_www_server_name=%(rhaptos2_www_server_name)s
env rhaptos2_cdn_server_name=%(rhaptos2_cdn_server_name)s

env rhaptos2_use_logging=%(rhaptos2_use_logging)s
env rhaptos2_loglevel=%(rhaptos2_loglevel)s

export rhaptos2_repodir
export rhaptos2_statsd_host
export rhaptos2_statsd_port
export rhaptos2_www_server_name
export rhaptos2_cdn_server_name

export rhaptos2_loglevel
export rhaptos2_use_logging

exec /usr/bin/python /usr/local/bin/rhaptos2_runrepo.py \
                     --host='0.0.0.0' \
                     --port=$PORT \
                     --debug=True \
         	            2>&1 | logger -ist 'rhaptos2'

respawn
respawn limit 3 20
