define(["coweb/topics","coweb/util/Promise","org/OpenAjax"],function(a,b,c){var d=function(){this._mutex=!1,this._serviceId=0,this._tokens={},this.id=undefined},e=d.prototype;e.init=function(a){if(!a||a.id===undefined)throw new Error("collab id required");this.id=a.id},e.subscribeReady=function(d,e){e===undefined&&(e=d,d=this);if(typeof e!=="function"){e=d[e];if(typeof e!=="function")throw new Error("callback must be a function")}var f=a.READY,g=c.hub.subscribe(f,function(a,b){e.call(d,b)},this);this._tokens[g]=null;var h=new b;h._cowebToken=g,h.resolve();return h},e.subscribeEnd=function(d,e){e===undefined&&(e=d,d=this);if(typeof e!=="function"){e=d[e];if(typeof e!=="function")throw new Error("callback must be a function")}var f=a.END,g=c.hub.subscribe(f,function(a,b){e.call(d,b)},this);this._tokens[g]=null;var h=new b;h._cowebToken=g,h.resolve();return h},e.subscribeSiteJoin=function(d,e){e===undefined&&(e=d,d=this);if(typeof e!=="function"){e=d[e];if(typeof e!=="function")throw new Error("callback must be a function")}var f=a.SITE_JOIN,g=c.hub.subscribe(f,function(a,b){e.call(d,b)},this);this._tokens[g]=null;var h=new b;h._cowebToken=g,h.resolve();return h},e.subscribeSiteLeave=function(d,e){e===undefined&&(e=d,d=this);if(typeof e!=="function"){e=d[e];if(typeof e!=="function")throw new Error("callback must be a function")}var f=a.SITE_LEAVE,g=c.hub.subscribe(f,function(a,b){e.call(d,b)},this);this._tokens[g]=null;var h=new b;h._cowebToken=g,h.resolve();return h},e.sendSync=function(b,d,e,f){if(this.id===undefined)throw new Error("call init() first");e===undefined&&(e="update"),f===undefined&&(f=0);var g=a.SYNC+b+"."+this.id,h={value:d,type:e,position:f};this._mutex=!0,c.hub.publish(g,h),this._mutex=!1},e.subscribeSync=function(d,e,f){if(this.id===undefined)throw new Error("call init() first");if(!d)throw new Error("valid sync name required");f===undefined&&(f=e,e=this);if(typeof f!=="function"){f=e[f];if(typeof f!=="function")throw new Error("callback must be a function")}var g=a.SYNC+d+"."+this.id,h=a.SYNC.length,i=this.id.length+1,j=c.hub.subscribe(g,function(a,b){this._mutex||(b.name=a.substring(h,a.length-i),b.topic=a,f.call(e,b))},this);this._tokens[j]=null;var k=new b;k._cowebToken=j,k.resolve();return k},e.subscribeStateRequest=function(d,e){e===undefined&&(e=d,d=this);if(typeof e!=="function"){e=d[e];if(typeof e!=="function")throw new Error("callback must be a function")}var f=a.GET_STATE,g=c.hub.subscribe(f,function(a,b){e.call(d,b)},this);this._tokens[g]=null;var h=new b;h._cowebToken=g,h.resolve();return h},e.sendStateResponse=function(b,d){if(this.id===undefined)throw new Error("call init() first");var e={state:b,recipient:d};this._mutex=!0;try{c.hub.publish(a.SET_STATE+this.id,e)}finally{this._mutex=!1}},e.subscribeStateResponse=function(d,e){if(this.id===undefined)throw new Error("call init() first");e===undefined&&(e=d,d=this);if(typeof e!=="function"){e=d[e];if(typeof e!=="function")throw new Error("callback must be a function")}var f=a.SET_STATE+this.id,g=c.hub.subscribe(f,function(a,b){this._mutex||e.call(d,b)},this);this._tokens[g]=null;var h=new b;h._cowebToken=g,h.resolve();return h},e.subscribeService=function(d,e,f){f===undefined&&(f=e,e=this);if(typeof f!=="function"){f=e[f];if(typeof f!=="function")throw new Error("callback must be a function")}var g=a.SET_SERVICE+d,h={callback:f,context:e,type:"subscribe"},i=c.hub.subscribe(g,"_cowebServiceResponse",this,h),j={topic:g,service:d},k=a.SUB_SERVICE+d;c.hub.publish(k,j);var l={topic:g,service:d,hubToken:i};this._tokens[i]=l;var m=new b;m.resolve(),m._cowebToken=l;return m},e.postService=function(d,e,f,g){if(this.id===undefined)throw new Error("call init() first");g===undefined&&(g=f,f=this);if(typeof g!=="function"){g=f[g];if(typeof g!=="function")throw new Error("callback must be a function")}var h=a.SET_SERVICE+d+"_"+this._serviceId+"."+this.id,i={context:f,callback:g,type:"get"},j=c.hub.subscribe(h,"_cowebServiceResponse",this,i);this._tokens[j]=null,i.hubToken=j;var k={topic:h,params:e,service:d},l=a.GET_SERVICE+d;c.hub.publish(l,k),this._serviceId++;var m=new b;m.resolve(),m._cowebToken=j;return m},e._cowebServiceResponse=function(a,b,d){var e=d.hubToken,f={value:b.value,error:b.error};try{d.callback.call(d.context,f)}finally{d.type==="get"&&(c.hub.unsubscribe(d.hubToken),delete this._tokens[e])}},e.unsubscribe=function(b){var d,e;if(b)if(b._cowebToken&&b._cowebToken.hubToken){d=b._cowebToken,delete b._cowebToken,c.hub.unsubscribe(d.hubToken),delete this._tokens[d.hubToken];var f=a.UNSUB_SERVICE+d.service;c.hub.publish(f,d)}else b._cowebToken&&(d=b._cowebToken,delete b._cowebToken,delete this._tokens[d],c.hub.unsubscribe(d))},e.unsubscribeAll=function(){for(var b in this._tokens)if(this._tokens.hasOwnProperty(b)){var d=this._tokens[b];c.hub.unsubscribe(b),delete this._tokens[b];if(d){var e=a.UNSUB_SERVICE+d.service;c.hub.publish(e,d)}}},e.pauseSync=function(){c.hub.publish(a.PAUSE_TOPIC,!0)},e.resumeSync=function(){c.hub.publish(a.RESUME_TOPIC,!0)};return d})