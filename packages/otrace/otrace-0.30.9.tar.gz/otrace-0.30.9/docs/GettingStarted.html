<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9: http://docutils.sourceforge.net/" />
<title>Getting started with otrace and oshell</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7056 2011-06-17 10:50:48Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="getting-started-with-otrace-and-oshell">
<h1 class="title">Getting started with <em>otrace</em> and <em>oshell</em></h1>

<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#installation" id="id1">1&nbsp;&nbsp;&nbsp;Installation</a></li>
<li><a class="reference internal" href="#demo-program" id="id2">2&nbsp;&nbsp;&nbsp;Demo program</a></li>
<li><a class="reference internal" href="#help-cd-ls-and-view-commands" id="id3">3&nbsp;&nbsp;&nbsp;help, cd, ls, and view commands</a></li>
<li><a class="reference internal" href="#pr-and-exec-commands" id="id4">4&nbsp;&nbsp;&nbsp;pr and exec commands</a></li>
<li><a class="reference internal" href="#trace-command" id="id5">5&nbsp;&nbsp;&nbsp;trace command</a></li>
<li><a class="reference internal" href="#edit-and-traceassert" id="id6">6&nbsp;&nbsp;&nbsp;edit and traceassert</a></li>
<li><a class="reference internal" href="#unpatch-and-untrace" id="id7">7&nbsp;&nbsp;&nbsp;unpatch and untrace</a></li>
<li><a class="reference internal" href="#object-tag-tracing" id="id8">8&nbsp;&nbsp;&nbsp;Object tag tracing</a></li>
<li><a class="reference internal" href="#preserving-trace-contexts" id="id9">9&nbsp;&nbsp;&nbsp;Preserving trace contexts</a></li>
<li><a class="reference internal" href="#monitoring-using-the-repeat-command" id="id10">10&nbsp;&nbsp;&nbsp;Monitoring using the repeat command</a></li>
<li><a class="reference internal" href="#breakpoints" id="id11">11&nbsp;&nbsp;&nbsp;Breakpoints</a></li>
</ul>
</div>
<p>This tutorial introduces the main features of <em>otrace</em> by explaining
how to &quot;debug&quot; the demo program, <tt class="docutils literal">hello_trace.py</tt>,
included in the distribution.</p>
<div class="section" id="installation">
<h1><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;Installation</a></h1>
<p>Download the development version of <em>otrace</em> from
<a class="reference external" href="https://github.com/mitotic/otrace/downloads">Github</a>,
or the released archive from the
<a class="reference external" href="http://pypi.python.org/pypi/otrace">Python Package Index</a>
The unzipped archive should contain the following files (and some more):</p>
<blockquote>
<tt class="docutils literal">hello_trace.py ordereddict.py otrace.py README.rst setup.py ...</tt></blockquote>
<p>All the code for the <em>otrace</em> module is contained in a single file,
<tt class="docutils literal">otrace.py</tt>. (For python 2.6 or earlier, you will also need
<tt class="docutils literal">ordereddict.py</tt>.)  To use <em>otrace</em> without installing it, just
ensure that these files are  present in the module load path.
If you wish to install <em>otrace</em>, use:</p>
<blockquote>
<tt class="docutils literal">python setup.py install</tt></blockquote>
</div>
<div class="section" id="demo-program">
<h1><a class="toc-backref" href="#id2">2&nbsp;&nbsp;&nbsp;Demo program</a></h1>
<p><tt class="docutils literal">hello_trace.py</tt> is a simple multi-threaded web server using the
<tt class="docutils literal">BaseHTTPServer</tt> module. It listens on port 8888 and displays a simple
form where the user inputs a number and the server displays the
reciprocal of the number. Inputting a zero value will raise an exception,
which will be used to illustrate the capabilities of <em>otrace</em>.</p>
<p>All the <em>oshell</em> commands used below are available in the script
<tt class="docutils literal">demo/hello_test.osh</tt>. Once you are comfortable with the steps in
this tutorial, you can re-run the entire tutorial using the following
command (in the <em>otrace</em> console):</p>
<pre class="literal-block">
source ~~w/demo/hello_test.osh
</pre>
</div>
<div class="section" id="help-cd-ls-and-view-commands">
<h1><a class="toc-backref" href="#id3">3&nbsp;&nbsp;&nbsp;help, cd, ls, and view commands</a></h1>
<p>Run <tt class="docutils literal">hello_trace.py</tt> from the command line (user input appears after
the prompt &quot;&gt;&quot;). The <tt class="docutils literal">help</tt> command displays all the available <em>oshell</em> commands:</p>
<pre class="literal-block">
otrace$ ./hello_trace.py
Listening on port 8888
  ***otrace object shell (v0.30.0+)*** (type 'help' for info)
&gt; help
Commands:
alias    cd       cdls     del      dn       edit     exec     help
lock     ls       popd     pr       pushd    pwd      quit     repeat
resume   rm       run      save     set      source   swapd    tag
trace    unpatch  unpickle untag    untrace  up       view

If you omit the command, &quot;pr&quot; is assumed.
Use TAB key for command completion.
Type &quot;help &lt;command&gt;&quot; or &quot;help *&quot; for more info

See http://info.mindmeldr.com/code/otrace for documentation
globals&gt; help pwd
pwd [-a]                  # Print current working &quot;directory&quot;

-a Print all paths in stack; top first
</pre>
<p>The <tt class="docutils literal">pwd</tt> command displays the current working directory.
The <tt class="docutils literal">ls</tt> command displays directory names and content. The special directory name <strong>~~</strong>
refers to the most recent <em>trace context</em>, and is initially
<tt class="docutils literal">/osh/globals</tt>.  There are also other special directory names of the
form ~~&lt;letter&gt;:</p>
<pre class="literal-block">
&gt; pwd
/osh/globals
&gt; ls ~~
/osh/globals
&gt; ls ~~g
/osh/globals
&gt; ls ~~w
/Users/rsarava/app4/repo/meldr-hg/otrace
</pre>
<p>The <tt class="docutils literal">ls</tt> options <em>-c</em>, <em>-f</em>, <em>-m</em>, <em>-v</em> can be used to selectively display
only the <em>classes</em>, <em>functions/methods</em>, <em>modules</em>, and <em>variables</em> in
a directory. Initially we examine the <tt class="docutils literal">globals</tt> directory, which
contains three classes, <tt class="docutils literal">GetHandler, MultiThreadedServer, and OShell</tt>:</p>
<pre class="literal-block">
&gt; ls
BaseHTTPServer      GetHandler          MultiThreadedServer OShell
Page_template       Receive             Request_stats       SocketServer
http_addr           http_port           http_server         logging
send                sleep               sys                 test_fun
trace_shell         traceassert         urlparse
&gt; ls -c
GetHandler          MultiThreadedServer OShell              Receive
</pre>
<p>The <tt class="docutils literal">cd</tt> command is used to change directories. Switching to the
directory of class <tt class="docutils literal">GetHandler</tt>, we note that it supports several methods, many of which
are inherited:</p>
<pre class="literal-block">
&gt; cd GetHandler
osh..GetHandler&gt; ls -f
address_string       date_time_string     do_GET               end_headers
finish               handle               handle_one_request   log_date_time_string
log_error            log_message          log_request          parse_request
send_error           send_header          send_response        setup
version_string
</pre>
<p>The <tt class="docutils literal">ls</tt> options <em>-..</em> can be used to exclude inherited attributes
of a class, and we note that <tt class="docutils literal">GetHandler</tt> has just one method of its own:</p>
<pre class="literal-block">
osh..GetHandler&gt; ls -f -..
do_GET
</pre>
<p>We can examine the source code for the <tt class="docutils literal">Receive.respond</tt> method using the
<tt class="docutils literal">view</tt> command with the <em>-i</em> (inline-display) option:</p>
<pre class="literal-block">
osh..GetHandler&gt; cd ..
globals&gt; cd Receive
osh..Receive&gt; ls
respond
osh..Receive&gt; view -i respond
def respond(self, request):
    # Respond to request by computing reciprocal and returning response string

    # Diagnostic print (initially commented out)
    ##if self.value &lt;= 0.001:
    ##    print &quot;Client address&quot;, request.client_address

    # Trace assertion (initially commented out)
    ##otrace.traceassert(self.value &gt; 0.001, label=&quot;num_check&quot;)

    # Compute reciprocal of number
    response = &quot;The reciprocal of %s is %s&quot; % (self.value, 1.0/self.value)
    return response
</pre>
</div>
<div class="section" id="pr-and-exec-commands">
<h1><a class="toc-backref" href="#id4">4&nbsp;&nbsp;&nbsp;pr and exec commands</a></h1>
<p>The <tt class="docutils literal">pr</tt> command prints out the value of a python expression. It is
the default command, and is assumed if no command is recognized. So
python expressions can usually be evaluated directly:</p>
<pre class="literal-block">
&gt; pwd
/osh/globals
&gt; pr Request_stats
{'count': 0, 'path': ''}
&gt; Request_stats[&quot;count&quot;]
0
&gt; set safe_mode False
safe_mode = False
&gt; abs(Request_stats[&quot;count&quot;] - 1)
1
</pre>
<p>To prevent inadvertent modification of a running program through
function calls, parentheses are not allowed in <tt class="docutils literal">pr</tt> expressions by default.
Setting the <tt class="docutils literal">safe_mode</tt> parameter to <tt class="docutils literal">False</tt> allows their use.</p>
<p>The <tt class="docutils literal">exec</tt> command executes a python statement,
like <em>assignment</em> or <em>import</em>. The prefix <em>!</em> may be used instead
of <tt class="docutils literal">exec</tt>. <tt class="docutils literal">safe_mode</tt> must be <tt class="docutils literal">False</tt> to use <tt class="docutils literal">exec</tt>:</p>
<pre class="literal-block">
&gt; !Request_stats[&quot;count&quot;] = 2
</pre>
</div>
<div class="section" id="trace-command">
<h1><a class="toc-backref" href="#id5">5&nbsp;&nbsp;&nbsp;trace command</a></h1>
<p>The <tt class="docutils literal">trace</tt> command is used to trace functions and methods. Without
any options, it simply traces exceptions.  The <tt class="docutils literal"><span class="pre">-c</span> &lt;condition&gt;</tt>
option, where <tt class="docutils literal">&lt;condition&gt;</tt> may be
<tt class="docutils literal">call</tt>, <tt class="docutils literal">return</tt>, or <tt class="docutils literal">all</tt>, may be used to trace function/method
calls, returns, or both. <tt class="docutils literal">&lt;condition&gt;</tt>  may also be
<tt class="docutils literal"><span class="pre">argname1.comp1==value1,argname2!=value2,...</span></tt> to trace on argument
value matching (values with commas/spaces must be quoted; the special
argument name <tt class="docutils literal">return</tt> may also be used).
Without any arguments, the <tt class="docutils literal">trace</tt> command displays currently traced names.
Next, we initiate tracing on the <tt class="docutils literal">respond</tt> method  using the
<tt class="docutils literal">trace</tt> command:</p>
<pre class="literal-block">
globals&gt; cd ~~g
globals&gt; cd Receive
osh..Receive&gt; trace respond
Tracing Receive.respond
osh..Receive&gt; trace
Receive.respond
</pre>
<p>Now we are ready to load the URL <em>http://localhost:8888</em> in the
browser,  and enter numbers. Instead of using the browser, in
this demo we will use the function <tt class="docutils literal">submit</tt> that simulates browser
input from the user. The command &quot;submit(22)&quot; would be equivalent
to the user entering 22. A log message is generated for each value, and the
zero input value triggers a <tt class="docutils literal">ZeroDivisionError</tt> exception in the
<tt class="docutils literal">respond</tt> method. In the exception backtrace shown below, note
the additional methods <tt class="docutils literal">otrace_wrapped</tt> and
<tt class="docutils literal">otrace_function_call</tt> between <tt class="docutils literal">do_GET</tt> and <tt class="docutils literal">respond</tt>.
These are inserted by <tt class="docutils literal">otrace</tt> for tracing:</p>
<pre class="literal-block">
osh..Receive&gt; submit(3)
rootW path=/?number=3
  &lt;span&gt;The reciprocal of 3.0 is 0.333333333333&lt;/span&gt;
osh..Receive&gt; submit(0)
rootW path=/?number=0
Receive.respond:ex-ZeroDivisionError:05-08-45
rootE ERROR: float division by zero
Server error:
Traceback (most recent call last):
  File &quot;./hello_trace.py&quot;, line 76, in do_GET
    resp = Page_template % recv.respond(self)
  File &quot;/Users/rsarava/app4/repo/mitotic/otrace/otrace.py&quot;, line 4601, in otrace_wrapped
    return cls.otrace_function_call(func_info, *args, **kwargs)
  File &quot;/Users/rsarava/app4/repo/mitotic/otrace/otrace.py&quot;, line 4373, in otrace_function_call
    return_value = info.fn(*args, **kwargs)
  File &quot;./hello_trace.py&quot;, line 104, in respond
    response = &quot;The reciprocal of %s is %s&quot; % (self.value, 1.0/self.value)
ZeroDivisionError: float division by zero
</pre>
<p>When a trace condition occurs, like an exception in a traced function or method, a trace id
<tt class="docutils literal"><span class="pre">GetHandler.respond:ex-ZeroDivisionError:05-08-45</span></tt> is generated and displayed,
as shown above. Also, the default action of the <tt class="docutils literal">trace</tt> command is
to create a new virtual directory
<tt class="docutils literal"><span class="pre">/osh/recent/exceptions/GetHandler.respond/ex-ZeroDivisionError/05-08-45</span></tt>
to hold the <em>trace context</em> for the event. The shorthand notation
<strong>~~</strong> can be used  to display the most recent <em>trace context</em>:</p>
<pre class="literal-block">
osh..Receive&gt; ls ~~
/osh/recent/exceptions/Receive.respond/ex-ZeroDivisionError/05-08-45
osh..Receive&gt; cd ~~
</pre>
<p>The trace context contains information about the function like
argument values and the call stack.:</p>
<pre class="literal-block">
Receive..08-45&gt; ls
__trc   __up    request self
Receive..08-45&gt; ls -l
__trc   = {exc_context, thread, framestack, frame, related, funcname, context, exc_stack, where, id, argvalues}
__up   = {path_comps, __trc, __up, __down, number, self, recv, query_args}
request = &lt;__main__.GetHandler instance at 0x106760fc8&gt;
self    = &lt;__main__.Receive object at 0x1068cb090&gt;
Receive..08-45&gt; cd __trc
osh..__trc&gt; ls
argvalues   context     exc_context exc_stack   frame       framestack  funcname
id          related     thread      where
osh..__trc&gt; ls -l where
where =
'__bootstrap--&gt;__bootstrap_inner--&gt;run--&gt;process_request_thread--&gt;finish_request--&gt;__init__--&gt;handle--&gt;handle_one_request--&gt;do_GET--&gt;respond'
</pre>
</div>
<div class="section" id="edit-and-traceassert">
<h1><a class="toc-backref" href="#id6">6&nbsp;&nbsp;&nbsp;edit and traceassert</a></h1>
<p>The <tt class="docutils literal">edit</tt> command is perhaps the most useful command in <em>otrace</em>. It
allows you to modify (<a class="reference external" href="http://en.wikipedia.org/wiki/Monkey_patch">monkey patch</a>) any function or method in the
running program. In particular, it makes it easy to use the &quot;oldest&quot;
debugging technique, viz., inserting <tt class="docutils literal">print</tt> statements in the code,
without having to modify the actual source code files.</p>
<p>Now that we know the there is an exception occurring in the method
<tt class="docutils literal">respond</tt>, we pretend that we don't know the exact cause, and will
use the <tt class="docutils literal">traceassert</tt> function to determine the cause. The <tt class="docutils literal">traceassert</tt>
functions has the signature <tt class="docutils literal">traceassert(condition, <span class="pre">label=&quot;&quot;,</span> <span class="pre">action=&quot;&quot;)</span></tt>.
As long as <tt class="docutils literal">condition</tt> is true, <tt class="docutils literal">traceassert</tt> simply returns. If
<tt class="docutils literal">condition</tt> is false, the call is logged and a <em>trace context</em>
virtual directory is created.</p>
<p>We suspect that the exception is caused because the user entered a
number that was too small. First, we switch off <em>safe mode</em>, which
disallows code editing. We then use the <tt class="docutils literal">edit</tt> command to modify
the <tt class="docutils literal">respond</tt> method in the running program to insert a
call to <tt class="docutils literal">traceassert</tt>. (Actually <tt class="docutils literal">hello_trace.py</tt> already has a
<tt class="docutils literal">traceassert</tt> call that is commented out. We simply uncomment it,
as well as the diagnostic <tt class="docutils literal">print</tt> statement, via the <tt class="docutils literal">edit</tt> command.):</p>
<pre class="literal-block">
osh..__trc&gt; cd ~~g
globals&gt; set safe_mode False
safe_mode = False
globals&gt; set trace_active True
trace_active = True
globals&gt; edit Receive.respond
Patched Receive.respond:
</pre>
<p>Note that we need to activate tracing explicitly by setting parameter
<tt class="docutils literal">trace_active</tt> to True to trace <tt class="docutils literal">traceassert</tt> calls. (This step
not needed when the <tt class="docutils literal">trace</tt> command is used, because tracing is
automatically activated.)
After the edit, the statement <tt class="docutils literal">otrace.traceassert(number &gt; 0.001, <span class="pre">label=&quot;num_check&quot;)</span></tt>
has been inserted into <tt class="docutils literal">Receive.respond</tt>. In the browser, enter the number
2 and then the number 0.0005. The latter value triggers a false
condition on the <tt class="docutils literal">traceassert</tt>. We switch to the assert trace
context directory <tt class="docutils literal"><span class="pre">/osh/recent/asserts/Receive.respond/as-num_check/04-57-54</span></tt>,
which allows us to examine the local variables when the assertion failed:</p>
<pre class="literal-block">
globals&gt; submit(2)
rootW path=/?number=2
  &lt;span&gt;The reciprocal of 2.0 is 0.5&lt;/span&gt;
globals&gt; submit(0.0005)
rootW path=/?number=0.0005
Client address ('127.0.0.1', 62008)
Receive.respond:as-num_check:05-08-51
  &lt;span&gt;The reciprocal of 0.0005 is 2000.0&lt;/span&gt;
globals&gt; ls ~~
/osh/recent/asserts/Receive.respond/as-num_check/05-08-51
globals&gt; cd ~~
Receive..08-51&gt; ls
__up  __trc   request self
Receive..08-51&gt; self.value
0.0005
Receive..08-51&gt; request.headers
Accept-Encoding: identity
Host: 127.0.0.1:8888
Connection: close
User-Agent: Python-urllib/2.7
</pre>
<p>The default action when the traceassert condition is false is to
create the trace context directory. The <tt class="docutils literal">action</tt> argument to
<tt class="docutils literal">traceassert</tt> can be used set a breakpoint when the assertion fails.
For efficiency, the trace context for <tt class="docutils literal">traceassert</tt> does not save the
backtrace stack local variables or source code information by default.
To enable backtracing of stack and source code, <tt class="docutils literal">set assert_context</tt>
to a non-zero value.</p>
</div>
<div class="section" id="unpatch-and-untrace">
<h1><a class="toc-backref" href="#id7">7&nbsp;&nbsp;&nbsp;unpatch and untrace</a></h1>
<p>After debugging is complete, the <tt class="docutils literal">unpatch</tt> command can be used to
restore  the original code for <tt class="docutils literal">Receive.respond</tt>.
The <tt class="docutils literal">untrace</tt> command can be used to switch off tracing:</p>
<pre class="literal-block">
globals&gt; cd /osh/patches
patches&gt; ls
Receive.respond
patches&gt; unpatch Receive.respond
Unpatching Receive.respond
patches&gt; cd ~~g
patches&gt; trace
Receive.respond
globals&gt; untrace Receive.respond
untraced Receive.respond
globals&gt;
</pre>
</div>
<div class="section" id="object-tag-tracing">
<h1><a class="toc-backref" href="#id8">8&nbsp;&nbsp;&nbsp;Object tag tracing</a></h1>
<p>One of the allowed actions in the <tt class="docutils literal">trace <span class="pre">-a</span> &lt;action&gt; <span class="pre">-c</span> &lt;condition&gt; ...</tt>
command is <tt class="docutils literal">tag</tt>. The tag action adds a special attribute to the
<tt class="docutils literal">self</tt> object if the trace condition is met at the time a function
returns. The tag attribute is just a string, usually the object's
<tt class="docutils literal">id</tt>, but can also be the current time or some other string.
The presence of tagged arguments can be specified as a trace condition
for subsequent tracing of a function, using the <tt class="docutils literal"><span class="pre">-c</span> <span class="pre">tagged[&lt;argname&gt;]</span></tt>
option. The commands <tt class="docutils literal">tag</tt> and <tt class="docutils literal">untag</tt> can be used to directly
add/remove the tag attribute.</p>
<p>In the example below, the method <tt class="docutils literal">Receive.__init__</tt> will tag the
<tt class="docutils literal">self</tt> object if <tt class="docutils literal">self.value</tt> equals 1 when the method returns.
Then, we trace <tt class="docutils literal">Receive.respond</tt> if its argument named <tt class="docutils literal">self</tt>
is tagged. First, we submit the value 2, which does not trigger
tagging. Next, we submit the value 1, which causes the <tt class="docutils literal">self</tt>
object to be tagged when <tt class="docutils literal">Receive.__init__</tt> returns, and
then triggers a trace context for <tt class="docutils literal">Receive.respond</tt> because
one of its arguments is tagged:</p>
<pre class="literal-block">
globals&gt; cd ~~g
globals&gt; trace -a tag -c self.value==1 Receive.__init__
Tracing -a tag -c {'self.value==': 1L} Receive.__init__
globals&gt; trace -c taggedself Receive.respond
Tracing -c taggedself Receive.respond
globals&gt; submit(2)
rootW path=/?number=2
  &lt;span&gt;The reciprocal of 2.0 is 0.5&lt;/span&gt;
globals&gt; submit(1)
rootW path=/?number=1
Receive:tg-self.value==1;0x103231090:17-04-42
Receive.respond:tr-taggedself;tg-self.value==1;0x103231090:17-04-42.0 self=&lt;__main__.Receive object at 0x103231090&gt;, request=&lt;__main__.GetHandler instance at 0x10322f950&gt;
  &lt;span&gt;The reciprocal of 1.0 is 1.0&lt;/span&gt;
globals&gt; cd ~~
Receive..04-42.0&gt; pwd
/osh/recent/traces/Receive.respond/tr-taggedself;tg-self.value==1;0x103231090/17-04-42.0
Receive..04-42.0&gt; ls
__trc   request self
</pre>
</div>
<div class="section" id="preserving-trace-contexts">
<h1><a class="toc-backref" href="#id9">9&nbsp;&nbsp;&nbsp;Preserving trace contexts</a></h1>
<p>Only a limited number of trace contexts (controlled by <tt class="docutils literal">set max_recent</tt>)
are retained in memory. If there are too many contexts, the oldest
contexts are deleted. The  <tt class="docutils literal">save</tt> command can be used to preserve
trace contexts in memory. The <tt class="docutils literal">set pickle_file</tt> command can be used
to specify a <em>pickle</em> database file in which to save all trace
contexts. This pickle database file can be opened at a later time
using the <tt class="docutils literal">unpickle</tt> command to read trace contexts into the
<tt class="docutils literal">/osh/pickled</tt> directory:</p>
<pre class="literal-block">
Receive..04-42.0&gt; cd ~~g
globals&gt; set pickle_file trace_test.db
pickle_file = trace_test.db
globals&gt; trace Receive.respond
Tracing Receive.respond
globals&gt; submit(0)
...
globals&gt; unpickle trace_test.db
globals&gt; cd /osh/pickled
pickled&gt; ls
exceptions
pickled&gt; cd
exceptions/Receive.respond/ex-ZeroDivisionError/17-06-22.0/:
osh..:&gt; ls
__trc   __up    request self
osh..:&gt;
</pre>
<p>The special directory <tt class="docutils literal">:</tt> is used to denote the content of the trace
context.</p>
</div>
<div class="section" id="monitoring-using-the-repeat-command">
<h1><a class="toc-backref" href="#id10">10&nbsp;&nbsp;&nbsp;Monitoring using the repeat command</a></h1>
<p>The <tt class="docutils literal">repeat</tt> command indefinitely repeats whatever command that
follows it, erasing the screen each time before displaying the
output. The default repeat interval is 0.2 seconds, and that
can be changed via the <tt class="docutils literal">set repeat_interval</tt> command.
Any user input, or a trace event will end the repeat cycle.
Here's an example of using <tt class="docutils literal">repeat</tt> to monitor the requests
processed by the demo the web server:</p>
<pre class="literal-block">
&gt; repeat ls -l Request_stats/*
</pre>
</div>
<div class="section" id="breakpoints">
<h1><a class="toc-backref" href="#id11">11&nbsp;&nbsp;&nbsp;Breakpoints</a></h1>
<p>Breakpoints can be set using the <tt class="docutils literal"><span class="pre">-a</span> break</tt> option for the <tt class="docutils literal">trace</tt>
command, or the <tt class="docutils literal"><span class="pre">action=&quot;break&quot;</span></tt> argument to <tt class="docutils literal">traceassert</tt>.
The <tt class="docutils literal">resume</tt> command is used to resume execution from a breakpoint.
Other possible actions for <tt class="docutils literal">trace</tt> and <tt class="docutils literal">traceassert</tt> include
<tt class="docutils literal">pdb</tt> or <tt class="docutils literal">ipdb</tt>, which launch the respective debuggers at the
breakpoint. The <tt class="docutils literal">continue</tt> command of the debuggers should be used
to return control to <em>otrace</em>.</p>
<p><em>Last modified:</em> 2012-08-24</p>
</div>
</div>
</body>
</html>
