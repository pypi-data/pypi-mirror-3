

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Calculated Fields &mdash; Camelot  documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Camelot  documentation" href="../index.html" />
    <link rel="up" title="Creating models" href="models.html" />
    <link rel="next" title="Views" href="views.html" />
    <link rel="prev" title="Fields" href="fields.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2652891-3']);
  _gaq.push(['_trackPageview']);
</script>

  </head>
  <body>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="views.html" title="Views"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="fields.html" title="Fields"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Camelot  documentation</a> &raquo;</li>
          <li><a href="../contents.html" >Camelot Documentation contents</a> &raquo;</li>
          <li><a href="index.html" >Camelot Documentation</a> &raquo;</li>
          <li><a href="models.html" accesskey="U">Creating models</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="calculated-fields">
<span id="id1"></span><h1>Calculated Fields<a class="headerlink" href="#calculated-fields" title="Permalink to this headline">¶</a></h1>
<p>To display fields in forms that are not stored into the database but, are
calculated at run time, two main options exist.  Either those fields are
calculated within python or they are calculated by Python.  Normal Python
properties can be used to do the calculation in Python, whereas ColumnProperties
can be used to do the logic in the database.</p>
<div class="section" id="python-properties-as-fields">
<h2>Python properties as fields<a class="headerlink" href="#python-properties-as-fields" title="Permalink to this headline">¶</a></h2>
<p>Normal python properties can be used as fields on forms as well.  In that case, there
will be no introspection to find out how to display the property.  Therefore the delegate
(<a class="reference internal" href="delegates.html#specifying-delegates"><em>Specifying delegates</em></a>) attribute should be specified explicitly.</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">camelot.admin.object_admin</span> <span class="kn">import</span> <span class="n">ObjectAdmin</span>
<span class="kn">from</span> <span class="nn">camelot.view.controls</span> <span class="kn">import</span> <span class="n">delegates</span>

<span class="k">class</span> <span class="nc">Coordinate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
    
  <span class="k">class</span> <span class="nc">Admin</span><span class="p">(</span><span class="n">ObjectAdmin</span><span class="p">):</span>
    <span class="n">form_display</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="s">&#39;y&#39;</span><span class="p">]</span>
    <span class="n">field_attributes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">delegate</span><span class="o">=</span><span class="n">delegates</span><span class="o">.</span><span class="n">FloatDelegate</span><span class="p">),</span>
                            <span class="n">y</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">delegate</span><span class="o">=</span><span class="n">delegates</span><span class="o">.</span><span class="n">FloatDelegate</span><span class="p">),)</span>
</pre></div>
</div>
</div></blockquote>
<p>By default, python properties are read-only.  They have to be set to editable through
the field attributes to make them writeable by the user.</p>
</div>
<div class="section" id="attach-actions-to-field-changes">
<h2>Attach actions to field changes<a class="headerlink" href="#attach-actions-to-field-changes" title="Permalink to this headline">¶</a></h2>
<p>Whenever the value of a field is changed, an action on the model can be triggered by
using properties to manipulate the field instead of manipulating it directly.  The
example below demonstrates how the value of y should be chopped when x is changed.</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">camelot.admin.object_admin</span> <span class="kn">import</span> <span class="n">ObjectAdmin</span>
<span class="kn">from</span> <span class="nn">camelot.view.controls</span> <span class="kn">import</span> <span class="n">delegates</span>

<span class="k">class</span> <span class="nc">Coordinate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
    
  <span class="k">def</span> <span class="nf">_get_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
  
  <span class="k">def</span> <span class="nf">_set_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    
  <span class="n">_x</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_x</span><span class="p">,</span> <span class="n">_set_x</span><span class="p">)</span>
      
  <span class="k">class</span> <span class="nc">Admin</span><span class="p">(</span><span class="n">ObjectAdmin</span><span class="p">):</span>
    <span class="n">form_display</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_x&#39;</span><span class="p">,</span> <span class="s">&#39;y&#39;</span><span class="p">,]</span>
    <span class="n">field_attributes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_x</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">delegate</span><span class="o">=</span><span class="n">delegates</span><span class="o">.</span><span class="n">FloatDelegate</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="p">),</span>
                            <span class="n">y</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">delegate</span><span class="o">=</span><span class="n">delegates</span><span class="o">.</span><span class="n">FloatDelegate</span><span class="p">),)</span>
    <span class="n">form_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/fields_with_actions.png" src="../_images/fields_with_actions.png" />
</div></blockquote>
</div>
<div class="section" id="fields-calculated-by-the-database">
<h2>Fields calculated by the database<a class="headerlink" href="#fields-calculated-by-the-database" title="Permalink to this headline">¶</a></h2>
<p>Having certain summary fields of your models filled by the database has the advantage
that the heavy processing is moved from the client to the server.  Moreover if the
summary builds on information in related records, having the database build the summary
reduces the need to transfer additional data from the database to the server.</p>
<p>To display fields in the table and the form view that are the result of a calculation
done by the database, a ColumnProperty needs to be defined in the Elixir model.  In this
ColumnProperty, the sql query can be defined using SQLAlchemy statements.  Then use the
field attributes mechanism to specify which delegate needs to be used to render the field.</p>
<img alt="../_images/budget.png" src="../_images/budget.png" />
<p>As an example we will create a budget with multiple budget lines, where the total budget
is calculated by the database:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">elixir.properties</span> <span class="kn">import</span> <span class="n">ColumnProperty</span>
<span class="kn">from</span> <span class="nn">camelot.view.controls</span> <span class="kn">import</span> <span class="n">delegates</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">sql</span><span class="p">,</span> <span class="n">and_</span>

<span class="k">class</span> <span class="nc">Budget</span><span class="p">(</span><span class="n">Entity</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">OneToMany</span><span class="p">(</span><span class="s">&#39;BudgetLine&#39;</span><span class="p">)</span>

    <span class="nd">@ColumnProperty</span>
    <span class="k">def</span> <span class="nf">total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">sql</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">BudgetLine</span><span class="o">.</span><span class="n">amount</span><span class="p">)],</span>
                          <span class="n">and_</span><span class="p">(</span><span class="n">BudgetLine</span><span class="o">.</span><span class="n">budget_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="k">class</span> <span class="nc">Admin</span><span class="p">(</span><span class="n">EntityAdmin</span><span class="p">):</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s">&#39;Budgets&#39;</span>
        <span class="n">list_display</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;total&#39;</span><span class="p">,</span> <span class="s">&#39;lines&#39;</span><span class="p">]</span>
        <span class="n">field_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;total&#39;</span><span class="p">:{</span><span class="s">&#39;delegate&#39;</span><span class="p">:</span><span class="n">delegates</span><span class="o">.</span><span class="n">FloatDelegate</span><span class="p">}}</span>

<span class="k">class</span> <span class="nc">BudgetLine</span><span class="p">(</span><span class="n">Entity</span><span class="p">):</span>
     <span class="n">budget</span> <span class="o">=</span> <span class="n">ManyToOne</span><span class="p">(</span><span class="s">&#39;Budget&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s">&#39;cascade&#39;</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="s">&#39;cascade&#39;</span><span class="p">)</span>
     <span class="n">amount</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">Float</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

     <span class="k">class</span> <span class="nc">Admin</span><span class="p">(</span><span class="n">EntityAdmin</span><span class="p">):</span>
         <span class="n">verbose_name</span> <span class="o">=</span> <span class="s">&#39;Budget lines&#39;</span>
         <span class="n">list_display</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;amount&#39;</span><span class="p">,]</span>
</pre></div>
</div>
<p>When the user presses F9, all data in the application is refreshed from the database, and thus
all fields are recalculated.</p>
<p>An explanation of the lambda function inside the ColumnProperty can be found in the <a class="reference external" href="http://elixir.ematia.de/apidocs/elixir.properties.ColumnProperty.html">ElixirColumnProperty</a> and
the <a class="reference external" href="http://www.sqlalchemy.org/docs/04/mappers.html#advdatamapping_mapper_expressions">SqlalchemyMappers</a> documentation.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Calculated Fields</a><ul>
<li><a class="reference internal" href="#python-properties-as-fields">Python properties as fields</a></li>
<li><a class="reference internal" href="#attach-actions-to-field-changes">Attach actions to field changes</a></li>
<li><a class="reference internal" href="#fields-calculated-by-the-database">Fields calculated by the database</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="fields.html"
                        title="previous chapter">Fields</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="views.html"
                        title="next chapter">Views</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/doc/calculated_fields.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="views.html" title="Views"
             >next</a> |</li>
        <li class="right" >
          <a href="fields.html" title="Fields"
             >previous</a> |</li>
        <li><a href="../index.html">Camelot  documentation</a> &raquo;</li>
          <li><a href="../contents.html" >Camelot Documentation contents</a> &raquo;</li>
          <li><a href="index.html" >Camelot Documentation</a> &raquo;</li>
          <li><a href="models.html" >Creating models</a> &raquo;</li> 
      </ul>
    </div>

<br/>
<a href="http://example.com/my_article.html#disqus_thread">Comments</a>
<br/>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /**
    * var disqus_identifier; [Optional but recommended: Define a unique identifier (e.g. post id or slug) for this thread] 
    */

  /** var disqus_developer = 1 **/

  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'http://camelot.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=camelot">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2009 - 2011, Conceptive Engineering.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.
    </div>
<div class="footer">
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

<script type="text/javascript">
var disqus_shortname = 'camelot';
(function () {
  var s = document.createElement('script'); s.async = true;
  s.src = 'http://disqus.com/forums/camelot/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



  </body>
</html>