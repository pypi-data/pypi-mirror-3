<h1 tal:replace="structure context/manage_page_header">HEADER</h1>
<h1 tal:replace="structure context/manage_tabs">TABS</h1>

<script type="text/javascript">
function changed_tal(cond, id) {
    if(cond)
        document.getElementById(id).style.visibility="visible";
    else
        document.getElementById(id).style.visibility="hidden";

}
</script>
<h3>Configure <code>External Authentication</code> Plugin </h3>

<p class="form-help">
    This page will help you to configure external authentication plugin.
    The plugin doesn't manage users and groups by itself, but rely on any
    existing user or group manager. It is recommended to use a separate manager
    than the one used for other sources, but it is not mandatory.<br/>
    The plugin is simply extracting informations from tales expressions,
    in most cases using HTTP headers, and create and authenticate the visitor
    for those users. It is capable of extracting groups and group membership,
    as user properties the same way.<br/>
</p>

<tal:def define="commited python: request.get('posted', False);
                 _ python: commited and here.manage_update_ea(**request.form);
                 prop python: here.getProperty;
                 user_container python: prop('user_container');
                 group_container python: prop('group_container');
                 login_script_name python: prop('login_script_name');
                 login_header python: not login_script_name
                                      and prop('login_header') or '';
                 uid_script_name python: prop('uid_script_name');
                 uid_header python: not uid_script_name
                                    and prop('uid_header') or '';
                 groups_script_name python: prop('groups_script_name');
                 groups_header python: not groups_script_name 
                                       and prop('groups_header') or '';
                 up_script_name python: prop('up_script_name');
                 use_in_session_cache python: prop('use_in_session_cache');
                 log_error_message python: prop('log_error_message');
                 redirect_to_external_auth python:
                                              prop('redirect_to_external_auth');
                 redirect_logout python: prop('redirect_logout');
                 external_login_url python: prop('external_login_url');
                 external_logout_url python: prop('external_logout_url');
                 proxy_url python: prop('proxy_url');
                 use_proxy python: proxy_url and bool(proxy_url.strip());
                 proxy_login python: prop('proxy_login');
                 proxy_password python: prop('proxy_password');
                 ">
<form action="" method="post"
      tal:attributes="action string:${here/absolute_url}/manage_configure;"
>

<fieldset><legend>Global</legend>
<input type="hidden" name="posted" value="1" />
<table cellspacing="0" cellpadding="2" border="0" width="100%">
  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          Use built-in session caching</a>
        <i>(If it is used, computation of groups belonging and update of
            properties will be done only once per session.)</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <input type="checkbox" name="use_in_session_cache" value="1"
               tal:attributes="checked python:use_in_session_cache"/><br/><p/>
    </td>
  </tr>
    
  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          Log Error messages</a>
        <i>(For debugging users tales expressions, it is important to disable
            this in production as it could be *very* verbose.)</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <input type="checkbox" name="log_error_message" value="1"
               tal:attributes="checked python:log_error_message"/><br/><p/>
    </td>
  </tr>
    
  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          Redirect to external auth</a>
        <i>(when non authenticated user accesses a protected resource.)</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <input type="checkbox" name="redirect_to_external_auth" value="1"
               tal:attributes="checked python:redirect_to_external_auth"
        /><br/><p/>
    </td>
  </tr>

  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          External login authentication URL.</a>
        <i>(tales expression like
            "string: https://host/Shibboleth.sso/Login?target=${came_from}"
            where $came_from will be replace by a relevant site url)
        </i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <input type="text" name="external_login_url" size="40"
                           tal:attributes="value external_login_url" />
    </td>
  </tr>

  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          Redirect to logout URL.</a>
        <i>(when not checked and logout url is given, the url is called by Zope
            server, you may have to configure a proxy for this to work.)</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <input type="checkbox" name="redirect_logout" value="True"
               tal:attributes="checked python:redirect_logout"
        /><br/><p/>
    </td>
  </tr>
  <!--
  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          HTML link to use to in forms for login.</a>
        <i>(html structure like 
            &lt;span&gt;UNIGE ISIs (Switch AAI)&lt;/span&gt; &lt;img src="switch-aai-logo.gif"&gt;
            )
        </i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <input type="text" name="html_link" size="40"
                           tal:attributes="value html_link" />
    </td>
  </tr>
  -->

  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          External logout URL.</a>
        <i>(tales expression like
            "string: https://host/Shibboleth.sso/Logout?return=${came_from}"
            where $came_from will be replace by a relevant site url)
        </i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <input type="text" name="external_logout_url" size="40"
                           tal:attributes="value external_logout_url" />
        <p>use a proxy to logout:
        <input type="checkbox" name="use_proxy" value="1"
               tal:attributes="onchange string:changed_tal(this.checked,
                                                           'id_proxy_form');
                               checked python: use_proxy"/></p>
  </tr>
  <tr id="id_proxy_form"
      tal:attributes="style python: use_proxy
                                and 'visibility: visible;;'
                                 or 'visibility: hidden;;'">
    <td align="left" valign="top" class="form-label">
        <a>
          Proxy configuration parameters for external logout</a>
        <i>(if no proxy configuration is given proxy information is taken from
            normal environment variables ie. "http_proxy", see standard module 
            urllib2 documentation)</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <p>Proxy url:
        <input type="text" name="proxy_url" size="20"
                           tal:attributes="value proxy_url" /></p>
        <p>login
        <input id="proxy_login_form" type="text" name="proxy_login" size="10"
                           tal:attributes="value proxy_login" /></p>
        <p>password
        <input type="password" name="proxy_password" size="10"
               tal:attributes="value python: proxy_password and '     '" /></p>
    </td>
  </tr>

</table>
</fieldset>

<br/><p/>

<fieldset><legend>User definition</legend>
<table cellspacing="0" cellpadding="2" border="0" width="100%">
  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          User container</a>
        <i>(The user container to use, computed users will be added into it.
            Cannot work without this defined.)</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <select name="user_container">
            <option></option>
         <tal:r repeat="container here/user_containers">
            <option tal:content="container"
               tal:attributes="selected python: container == user_container"/>
         </tal:r>
        </select><br/><p/>
    </td>
  </tr>
  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          Login definition script</a>
        <i>(you can either use a script or a tales expression to compute user
            ID. If you want to use a script go to contents tab and your scripts
            here. Scripts must have default keyword argument but you can
            explicitly give those you will use, for example
            "HTTP_REFERER, **k". Argument passed to scripts are
            the same as the ones defined in tales context)</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <select name="login_script_name" onchange="changed_tal(this.value=='',
                                                               'tr_login')">
            <option value="">Use tales expression</option>
         <tal:r repeat="script here/objectIds">
            <option tal:content="script"
               tal:attributes="selected python: script == login_script_name"/>
         </tal:r>
        </select>
    </td>
  </tr>
  <tr id="tr_login"
      tal:attributes="style python: login_script_name == ''
                                and 'visibility: visible;;'
                                 or 'visibility: hidden;;'">
    <td align="left" valign="top" class="form-label">
        <a>
          expression</a>
        <i>(Tales expression use for login extraction. TALES expression with
            extra context defining all headers as local variables as well as
            additional variables "here", "modules" and "re". Also when they
            are already defined "login", "user_id", and "groups.")</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <input type="text" name="login_header" size="40"
                           tal:attributes="value login_header" />
    </td>
  </tr>
  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          User ID definition script</a>
        <i>(If blank, login and ID will be the same.)</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <select name="uid_script_name" onchange="changed_tal(this.value=='',
                                                                     'tr_uid')">
            <option value="">Use tales expression</option>
         <tal:r repeat="script here/objectIds">
            <option tal:content="script"
               tal:attributes="selected python: script == uid_script_name"/>
         </tal:r>
        </select>
    </td>
  </tr>
  <tr id="tr_uid"
      tal:attributes="style python: uid_script_name == ''
                                and 'visibility: visible;;'
                                 or 'visibility: hidden;;'">
    <td align="right" valign="top" class="form-label">
        <a>
          expression</a>
        <i>(see login tales expression help)</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <input type="text" name="uid_header" size="40"
                           tal:attributes="value uid_header" />
    </td>
  </tr>
</table>
</fieldset>

<br/><p/>

<fieldset><legend>Groups definition</legend>
<table cellspacing="0" cellpadding="2" border="0" width="100%">
  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          Group Container</a>
        <i>(if it is null, groups management will be disabled)</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <select name="group_container">
            <option></option>
         <tal:r repeat="container here/group_containers">
            <option tal:content="container"
               tal:attributes="selected python: container == group_container"/>
         </tal:r>
        </select><br/><p/>
    </td>
  </tr>
  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          Group definition script</a>
        <i>(Must return a iterable of strings. Groups belonging for this users
            will be strictly the one given by this expression, so if you want
            to allow webmaster to give users local groups permissions, you
            should use recursive groups and add an extra group computed from
            login and unique to the each user and add this group to local ones
            ie. "python: computed_group_list + [ 'g' + login ]")</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <select name="groups_script_name" onchange="changed_tal(this.value=='',
                                                                 'tr_groups')">
            <option value="">Use tales expression</option>
         <tal:r repeat="script here/objectIds">
            <option tal:content="script"
               tal:attributes="selected python: script == groups_script_name"/>
         </tal:r>
        </select>
    </td>
  </tr>
  <tr id="tr_groups"
      tal:attributes="style python: groups_script_name == ''
                                and 'visibility: visible;;'
                                 or 'visibility: hidden;;'">
    <td align="right" valign="top" class="form-label">
        <a>
          expression</a>
        <i>(see login tales expression help)</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <input type="text" name="groups_header" size="40"
                           tal:attributes="value groups_header" />
    </td>
  </tr>
</table>
</fieldset>

<br/><p/>

<fieldset><legend>User informations</legend>
<table cellspacing="0" cellpadding="2" border="0" width="100%">
  <tr>
    <td align="left" valign="top" class="form-label">
        <a>
          Default property script</a>
        <i>(called for each property if no expression is given to compute
            properties value, we additionaly have in paramaters or context:
            "property" whith the property name, and "current" whith the actual
            value of the property. If you want to allow users to change their
            properties use an expression like "python: current or some_expr")
        </i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <select name="up_script_name">
            <option></option>
         <tal:r repeat="script here/objectIds">
            <option tal:content="script"
               tal:attributes="selected python: script == up_script_name"/>
         </tal:r>
        </select><br/><p/>
    </td>
  </tr>
  <tr tal:repeat="prop here/get_managed_user_properties">
    <td align="right" valign="top" class="form-label">
        <a tal:content="prop/name">
          property name</a>
        <i></i>
    </td>
    <td align="right" width="300" valign="top" class="form-label"
        tal:define="overriden python: not prop['use_default']">
        delete
        <input type="checkbox" name="delete_script" value="1"
               tal:attributes="name string:delete_${prop/id}"/><br/>
        use default script
        <input type="checkbox" name="use_default_script" value="1"
               tal:attributes="name string:use_default_${prop/id};
                               onchange string:changed_tal(!this.checked,
                                                               'id_${prop/id}');
                               checked not:overriden"/>
        <input id="id_script" type="text" name="tal_script" size="40" value=""
               tal:attributes="name string:tal_${prop/id};
                               id string:id_${prop/id};
                               style python: overriden
                                         and 'visibility: visible;;'
                                          or 'visibility: hidden;;';
                               value python: prop['tal']"/>
    </td>
  </tr>
  <tr>
    <td align="right" valign="top" class="form-label">
        <br/><p/><a>
          Add managed property </a>
        <i>(enter the name of the new property)</i>
    </td>
    <td align="right" width="300" valign="top" class="form-label">
        <br/><p/><input type="text" name="add_prop" size="40" value=""/>
    </td>
  </tr>
</table>
</fieldset>

<div style="float: right; padding: 1em  0.75em 1em 0; margin-right: 6px;"
     class="form-element">
    <input class="form-element" type="submit" name="submit" value=" Update " /> 
</div>


</form>

</tal:def>

<h1 tal:replace="structure context/manage_page_footer">FOOTER</h1>
