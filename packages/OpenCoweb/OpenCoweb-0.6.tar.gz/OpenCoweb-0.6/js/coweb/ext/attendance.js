define(["coweb/main","coweb/util/Promise"],function(a,b){var c={users:{},count:0,_subs:{},_subId:0,_subscribe:function(a,b){b===undefined&&(b=a,a=this);if(typeof b!=="function"){b=a[b];if(typeof b!=="function")throw new Error("callback must be a function")}var c=this._subId;this._subs[c]={context:a,callback:b},this._subId++;return c},_notify:function(a,b,c){var d=this._subs;for(var e in d)if(d.hasOwnProperty(e)){var f=d[e],g={type:a,users:b,count:c};try{f.callback.call(f.context,g)}catch(h){console.error(h)}}},subscribeChange:function(a,c){var d=this._subscribe(a,c),e=new b;e._cowebToken=d,e.resolve();return e},unsubscribe:function(a){var b=a._cowebToken;b&&delete this._subs[b]},unsubscribeAll:function(){for(var a in this._subs)this._subs.hasOwnProperty(a)&&delete this._subs[a]},_onLocalJoin:function(a){var b=[];for(var c in a.roster)if(a.roster.hasOwnProperty(c)){var d=a.roster[c];b.push(this._addUser(c,d,!1))}this._notify("join",b,this.count);var e=this._addUser(a.site,a.username,!0);e&&this._notify("join",[e],this.count)},_onRemoteJoin:function(a){var b=this._addUser(a.site,a.username,!1);b&&this._notify("join",[b],this.count)},_onRemoteLeave:function(a){var b=this._removeUser(a.site);b&&this._notify("leave",[b],this.count)},_addUser:function(a,b,c){var d=this.users[a];if(!d){++this.count,d={site:Number(a),username:b,local:c},this.users[a]=d;return d}},_removeUser:function(a){var b=this.users[a];b&&--this.count,delete this.users[a];return b}},d=a.initCollab({id:"coweb-ext-attendance"});d.subscribeReady(c,"_onLocalJoin"),d.subscribeSiteJoin(c,"_onRemoteJoin"),d.subscribeSiteLeave(c,"_onRemoteLeave");return c})