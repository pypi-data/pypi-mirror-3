<%!
  from itertools import izip_longest
%>


<%def name="renderControl(id_name, value, props)" >
  %if props.html_type == "select":
    <select class="${getattr(props, 'classes', 'span3')} ${'focused' if i==0 else ""}" \
          id="${id_name}" name="${id_name}">
      %for key, value in props.getItems(request):
        <option name="${key}">${value}</option>
      %endfor
    </select>
  %elif props.html_type == "checkbox":
    <label class="checkbox">
      ${props.html_extra_label}
      <input class="${getattr(props, 'classes', 'span3')} ${'focused' if i==0 else ""}" \
        type="checkbox" \
        id="${id_name}" \
        name="${id_name}" \
        value="${props.html_default_value}" \
        ${"required" if props.required else ""}>
    </label>
  %else:
      <input class="${getattr(props, 'classes', 'span3')} ${'focused' if i==0 else ""}" \
        id="${id_name}" \
        name="${id_name}" \
        type="${props.html_type}" \
        value="${value}" \
        ${"required" if props.required else ""} \
        ${'minlength={}'.format(props.min) if getattr(props, 'min', False) else ""}>
        %if getattr(props, 'html_help', False):
          <p class="help-block">${props.html_help}</p>
        %endif
  %endif
</%def>

<%def name="renderFormLine(field_id_name, field, props, values, errors)">
  <div class="control-group${" error" if field in errors else ""}">
    <label class="control-label" for="${field_id_name}">${props.html_label}</label>
    <div class="controls">
      ${self.renderControl(id_name = field_id_name, value=values.get(field, ""), props = props)}
      %if field in errors:
        <span class="help-inline">${errors[field]}</span>
      %endif
    </div>
  </div>
</%def>

<%def name="buildListSubform(key, position, schema, values, errors)">
  <${schema.html_tag} class="form-embedded ${schema.html_classes}" ${'id="template-{}"'.format(key.replace(".","-")) if position == 0 else ""|n}>
  <span class="control-number">${position+1}</span>
  %for i, field in enumerate(schema.form_order):
    <% 
      props = schema.fields[field]
      field_id_name = "{}-{}.{}".format(key, position, field) 
    %>
    ${self.renderFormLine(field_id_name, field, props, values, getattr(errors, "error_dict", {}))}
  %endfor
  </${schema.html_tag}>
</%def>

<%def name="buildSubform(key, schema, values, errors)">
  <${schema.html_tag} class="${schema.html_classes}">
  %for i, field in enumerate(schema.form_order):
    <% 
      props = schema.fields[field]
      field_id_name = "{}.{}".format(key, field) 
    %>
    ${self.renderFormLine(field_id_name, field, props, values, getattr(errors, "error_dict", {}))}
  %endfor
  </${schema.html_tag}>
</%def>



<%def name="buildform(schema, values, errors)">
<%
  values = values[schema.form_id]
  errors = errors[schema.form_id]
%>
   <form method="post" class="form-horizontal form-validated" id="${schema.form_id}">
      <input type="hidden" name="type" value="${schema.form_id}"/>
      <input type="hidden" name="furl" value="${schema.getFURL(request)}"/>
      <input type="hidden" name="token" value="${request.session.get_csrf_token()}"/>
      <fieldset>
        <legend>${caller.header()}</legend>
        %if hasattr(caller, 'headparagraph'):
          <div class="sublegend">${caller.headparagraph()}</div>
        %endif
        %for i, field in enumerate(schema.form_order):
          <% 
            props = schema.fields[field]
            field_id_name = "{}.{}".format(schema.form_id, field)
          %>
          
          %if props.repeating == True and isinstance(props, formencode.ForEach):
            <div class="form-embedded-wrapper">
            %for j, (values_, errors_) in enumerate(izip_longest(values.get(field, [{}]), getattr(errors.get(field), "error_list", []), fillvalue = {})):
              %for subschema in props.validators:
                ${self.buildListSubform(field_id_name, j, subschema, values_, errors_)}
              %endfor
            %endfor
            <div class="add-more"><a class="link add-more-listitem" _field_position="${j}" _field_key="${field_id_name.replace(".","-")}" _template="template-${field_id_name}">add one more</a></div>
            </div>
          %elif props.repeating == False and isinstance(props, formencode.Schema):
            ${self.buildSubform(field_id_name, props, values.get(field, {}), errors.get(field, {}))}
          %else:
            ${self.renderFormLine(field_id_name, field, props, values, errors)}
          %endif
        %endfor
        <div class="form-actions">
          ${caller.footer()}
        </div>
      </fieldset>
    </form>
</%def>



<%def name="buildValidators(root)">
  %if request._LOCALE_ == 'de':
    $.validator.methods.range = function (value, element, param) {
      var globalizedValue = value.replace(",", ".");
      return this.optional(element) || (globalizedValue >= param[0] && globalizedValue <= param[1]);
    }
    $.validator.methods.number = function (value, element) {
      return this.optional(element) || /^-?(?:\d+|\d{1,3}(?:[\s\.,]\d{3})+)(?:[\.,]\d+)?$/.test(value);
    }
  %endif
  
  ${root}.find("form.form-validated").each(function(index, form){
    $(form).validate({
      errorClass: "help-inline"
      ,errorElement: "span"
      ,highlight: function (element, errorClass, validClass) {
        $(element).closest(".control-group").addClass("error");
      }
      , unhighlight: function (element, errorClass, validClass) {
        $(element).closest(".control-group").removeClass("error");
      }
    });
  });
  ${root}.on({click:function(e){
      var $target = $(e.target)
        , $embeddedForm = $target.closest(".form-embedded")
        , refLink = $target.closest(".form-embedded-wrapper").find(".add-more-listitem")
        , delLink = $target.remove();
        refLink.attr("_field_position", parseInt(refLink.attr("_field_position"), 10) - 1);
        if($embeddedForm.prevAll(".form-embedded").length>1){
          $embeddedForm.prev().prepend(delLink);
        }
        $embeddedForm.remove();
      }
    }, ".add-more-delete-link");
  ${root}.on({
    click : function(e){
      var $target = $(e.target)
        , $form = $target.closest("form")
        , templ = $("#template-"+$target.attr("_field_key"))
        , new_node = templ.clone().removeAttr("id")
        , new_position = parseInt($target.attr("_field_position"), 10) + 1
        , inc = function(elem, attr){
          elem.attr(attr, elem.attr(attr).replace(/-[0-9]+\./g, "-"+new_position+"."))
       };
      new_node.find("label").each(function(index, elem){
        elem = $(elem); inc(elem, "for");
      });
      new_node.find("input,select,textarea").each(function(index, elem){
        elem = $(elem); 
        inc(elem, "id"); 
        inc(elem, "name");
        elem.val("");
      });    
      new_node.find(".control-number").html(new_position+1);
      $target.attr("_field_position", new_position);
      $target.closest(".add-more").before(new_node);
      var delete_link = $form.find(".add-more-delete-link").remove();
      if(delete_link.length === 0){
        delete_link = $('<a class="add-more-delete-link close">×</a>')
      }
      new_node.prepend(delete_link);
    }
  }, ".add-more-listitem");
</%def>