define(["jquery","underscore","cilantro/define/viewelement","order!vendor/jquery.ui"],function(a,b,c){var d,e,f,g,h,i,j,k;return f='<% for (var b, i = 0; i < breadcrumbs.length; i++) { %>\n    <% b = breadcrumbs[i]; %>\n    <% if (i === (breadcrumbs.length-1)) {%>\n        <span title="<%= b.name %>"><%= b.name %></span>\n    <% } else { %>\n        <a href="<%= b.uri %>" title="<%= b.name %>"><%= b.name %></a> <span class="breadcrumb-arrow">&rarr;</span>\n    <% } %>\n<% } %>',g='<li data-id="<%= id %>" data-uri="<%= uri %>" <% if (!terminal) { %>class="folder"<% } %>>\n    <button class="button-add">+</button>\n    <span class="name"><%= name %>\n        <% if (attrs) { %>\n            <br><small class="info"><% for (var k in attrs) { %>\n                <%= k %>: <%= attrs[k] %>\n            <% } %></small>\n        <% } %>\n    </span>\n</li>',i='<li data-id="<%= id %>" <% if (!terminal) { %>class="folder"<% } %>>\n    <button class="button-add">+</button>\n    <span>\n        <% if (search_only) { %>\n            <span><%= name %></span>\n        <% } else { %>\n            <a href="<%= parent.uri %>"><%= name %></a>\n        <% } %>\n        <% if (attrs) { %>\n            <br><small class="info"><% for (var k in attrs) { %>\n                <%= k %>: <%= attrs[k] %>\n            <% } %></small>\n        <% } %>\n    </span>\n</li>',j='<li data-id="<%= id %>" <% if (!terminal) { %>class="folder"<% } %>>\n    <button class=button-remove>-</button>\n    <% if (search_only) { %>\n        <span class=text><%= name %></span>\n    <% } else { %>\n        <a class=text href="<%= parent.uri %>"><%= name %></a>\n    <% } %>\n</li>',k='<div id="vocab-browser-<%= pk %>" class="vocab-browser">\n    <% if (!search_only) { %>\n        <div class="vocab-tabs tabs">\n            <a class="tab" href="#browse-tab-<%= pk %>">Browse <%= title %></a>\n            <a class="tab" href="#search-tab-<%= pk %>">Search <%= title %></a>\n        </div>\n    <% } %>\n    <div>\n        <% if (!search_only) { %>\n            <div id="browse-tab-<%= pk %>">\n                <div class=vocab-breadcrumbs></div>\n                <ul class="vocab-browse-results list"></ul>\n            </div>\n        <% } %>\n\n        <div id="search-tab-<%= pk %>">\n            <form method="get" action="<%= directory %>">\n                <input type="text" class="vocab-search" name="q" placeholder="Search...">\n                <em>Note: only the first 100 results are displayed</em>\n            </form>\n            <div>\n                <ul class="vocab-search-results list">\n                    <li class="start">Enter search terms above. Results can be clicked to go to their location in the Browse tab.</li>\n                </ul>\n            </div>\n        </div>\n\n        <h2>Selected <%= title %></h2>\n\n        <div style=text-align:center><em>Drag and drop between buckets to customize your query.</em></div>\n\n        <div class=vocab-staging>\n            <h3>At Least One</h3>\n            <ul id=vocab-optional class=placeholder></ul>\n\n            <h3>Require All</h3>\n            <ul id=vocab-require class=placeholder></ul>\n\n            <div id=vocab-exclude-operator>\n                <h3>Exclude Any Of These</h3>\n                <select>\n                    <option value="-in">Exclude Any Of These</option>\n                    <option value="-all">Exclude All Of These</option>\n                </select>\n            </div>\n            <ul id=vocab-exclude class=placeholder></ul>\n        </div>\n\n    </div>\n</div>',d="in",e="-in",h=function(a){var b;for(b in a)return!1;return!0},c.extend({constructor:function(a,b){return this.base(a,b),this.datasource={}},_showItemBrowser:function(b){var c,d,e;return c=this.browseResults,d=a(b),e=d.parents("li"),this.tabs.tabs("toggle",0),this.loadBrowseList(d.attr("href"),function(){return b=c.find("[data-id="+e.data("id")+"]"),c.scrollTo(b,500,{offset:-150,onAfter:function(){return b.effect("highlight",null,2e3)}})}),!1},_renderBrowse:function(b){var c,d,e=this;return c=this.browseResults=a(".vocab-browse-results",b),c.on("click","button",function(b){var c;return c=a(b.currentTarget).parent(),e.stageItem(c.data()),!1}),c.on("click",".folder",function(b){return e.loadBrowseList(a(b.currentTarget).data("uri")),!1}),this.tabs=d=a(".vocab-tabs",b),d.tabs(!1,function(c,e){var f;return f=d.find(".tab"),f.each(function(c,d){return a(d.hash,b).hide()}),a(e.prop("hash"),b).show()}),this.browseBreadcrumbs=a(".vocab-breadcrumbs",b).on("click","a",function(a){return e.loadBrowseList(a.target.href),!1})},_renderSearch:function(b){var c,d,e=this;return d=a(".vocab-search",b),c=this.searchResults=a(".vocab-search-results",b),c.on("click","button",function(b){var c;return c=a(b.currentTarget).parent(),e.stageItem(c.data()),!1}),c.on("click","a",function(a){return e._showItemBrowser(a.currentTarget),!1}),d.autocomplete2({start:function(){return c.block()},success:function(b,d){c.empty();if(!d.length){c.html('<li class="empty">No results found.</li>');return}return a.each(d,function(a,b){var d;return d=e.renderListElement(b,i),c.append(d)}),e.refreshResultState(),c.unblock()}})},_renderStaging:function(b){var c,d,e,f,g,h,i,j,k=this;return j=a(".vocab-staging",b),h=this,i={placeholder:"placeholder",forcePlaceholderSize:!0,forceHelperSize:!0,containment:this.dom,opacity:.5,cursor:"move",connectWith:".vocab-staging > ul",receive:function(b,c){var d,e,f;return f=a(this),f.children().length===1&&f.removeClass("placeholder"),c.sender.children().length===0&&c.sender.addClass("placeholder"),d=c.item.data("id"),h.datasource[d].push(f.data("operator")),e=h.datasource[d].indexOf(c.sender.data("operator")),h.datasource[d].splice(e,1)}},f=a("#vocab-optional",b).sortable(i),f.data("operator","in"),e=a("#vocab-exclude-operator h3",b),this.excludeSelect=c=a("#vocab-exclude-operator select",b).on("change",function(){return e.text(c.find(":selected").text())}),d=a("#vocab-exclude",b).sortable(i),d.data("operator","-x"),g=a("#vocab-require",b).sortable(i),g.data("operator","all"),this.targets={"in":f,all:g,"-x":d},j.on("click","li button",function(b){var c;return c=a(b.target).parent(),k.unstageItem(c.data("id"),c.parent().data("operator")),c.siblings().length===0&&c.parent().addClass("placeholder"),c.remove(),k.refreshResultState()}),j.on("click","a",function(a){return k._showItemBrowser(a.currentTarget),!1})},render:function(){var c;this.dom=c=a(b.template(k,this.viewset)),this._renderSearch(c),this._renderStaging(c);if(!this.viewset.search_only)return this._renderBrowse(c),this.loadBrowseList()},stageItem:function(a,b){var c,e,f;b==null&&(b=d);if(b==="-all"||b==="-in")b="-x";return typeof a===Number?c=a:(c=a.id,this.datasource[c]||(this.datasource[c]=[]),e=this.renderListElement(a,j,!0),f=this.targets[b],f.removeClass("placeholder"),f.append(e)),this.datasource[c].push(b),this.refreshResultState()},unstageItem:function(a,b){var c;c=this.datasource[a].indexOf(b);if(c>-1)return this.datasource[a].splice(c,1),this.datasource[a].length||delete this.datasource[a],this.refreshResultState()},constructQuery:function(){var c,d,e,f,g,i,j,k,l,m,n,o;j={"-x":[],all:[],"in":[]},d={concept_id:this.concept_pk,custom:!0};if(h(this.datasource)){e=a.Event("InvalidInputEvent"),e.ephemeral=!0,e.message="No value has been specified.",this.dom.trigger(e);return}o=this.datasource;for(f in o){k=o[f];for(m=0,n=k.length;m<n;m++)i=k[m],j[i].push(f)}b.each(j,function(a,b){if(!a.length)return delete j[b]}),j["-x"]&&(j[this.excludeSelect.val()]=j["-x"],delete j["-x"]);if((g=b.keys(j)).length===1)d.id=this.viewset.pk,d.value=j[g[0]],d.operator=g[0];else{c=[];for(f in j)l=j[f],c.push({id:this.viewset.pk,value:l,operator:f,concept_id:this.concept_pk});d.type="and",d.children=c}return this.dom.trigger("ConstructQueryEvent",[d])},updateDS:function(a,b){var c,d,e,f,g,i;d=this,this.refreshResultState();if(!h(b)){if(b.children){g=b.children,i=[];for(e=0,f=g.length;e<f;e++)c=g[e],i.push(d._updateDS(c.value,c.operator));return i}return d._updateDS(b.value,b.operator)}},_updateDS:function(b,c){var d;if(c==="-in"||c==="-all")this.excludeSelect.val(c),this.excludeSelect.siblings().text(this.excludeSelect.find(":selected").text());return d=this,a.each(b,function(b,e){return a.ajax({url:d.viewset.directory+e+"/",success:function(a){return d.stageItem(a,c)}})})},updateElement:function(a,b){},elementChanged:function(a,b){},loadBrowseList:function(c,d){var e,h=this;return this.browseResults.block(),c=c||this.viewset.directory,e=[{name:"All",uri:this.viewset.directory}],a.getJSON(c,function(a){var c,i,j,k,l,m;h.browseResults.empty(),h.browseBreadcrumbs.empty(),b.isArray(a)?j=a:(j=a.children,e=e.concat(a.ancestors.length?a.ancestors:[]),e.push({name:a.name}));for(l=0,m=j.length;l<m;l++)i=j[l],c=h.renderListElement(i,g),h.browseResults.append(c);return k=b.template(f,{breadcrumbs:e}),h.browseBreadcrumbs.html(k),h.refreshResultState(),typeof d=="function"&&d(),h.browseResults.unblock()})},renderListElement:function(c,d){return c.parent||(!c.ancestors||c.ancestors.length===0?c.parent={uri:this.viewset.directory}:c.parent={uri:c.ancestors[0].uri}),c.search_only=this.viewset.search_only,a(b.template(d,c)).data(c)},refreshResultState:function(){var b,c;this.viewset.search_only||(a("li",this.browseResults).removeClass("added"),a("button",this.browseResults).attr("disabled",!1)),a("li",this.searchResults).removeClass("added"),a("button",this.searchResults).attr("disabled",!1),c=[];for(b in this.datasource)this.viewset.search_only||this.browseResults.find("li[data-id="+b+"]").addClass("added").find("button").attr("disabled",!0),c.push(this.searchResults.find("li[data-id="+b+"]").addClass("added").find("button").attr("disabled",!0));return c}})})