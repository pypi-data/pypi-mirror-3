<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    lang="en"
    metal:use-macro="context/prefs_main_template/macros/master"
    i18n:domain="plone">

<head>
<metal:block fill-slot="top_slot" tal:define="resourceDirectory nocall:view/resourceDirectory">

<tal:defines define="dummy python:request.set('disable_border',1);
                     disable_column_one python:request.set('disable_plone.leftcolumn',1);
                     disable_column_two python:request.set('disable_plone.rightcolumn',1);" />

<link rel="stylesheet" type="text/css"
  tal:attributes="href string:${view/portalUrl}/++resource++plone.app.theming/mapper.css"
  />

<metal:block use-macro="resourceDirectory/@@plone.resourceeditor.filemanager/macros/resources" />
<script type="text/javascript" tal:content="view/jsVariables"></script>
<script type="text/javascript">
jQuery(function($) {

  $().ready(function() {

    function normalizePath(path) {
      if(path[0] == '/') {
          path = path.slice(1, path.length);
        }
        return path;
    }

    function isPreviewable(path) {
      return path.match(/.+\.html?$/i);
    }

    function reloadFrame() {
      $("#editor-preview-frame").attr('src', $("#editor-preview-frame").attr('src'));
    }

    $("#filemanager").bind('resourceeditor.selected', function(event, path) {
      if(isPreviewable(path)) {
        path = normalizePath(path);
        var fetch = THEME_BASE_URL + "/@@theming-controlpanel-mapper-getframe?path=" + path + "&amp;theme=off";
        $("#editor-preview-frame").attr('src', fetch);
        $("#editor-preview-frame").data('current', path);
        $("#theme-preview-filename").text(path);

        if(!$("#theme-preview").is(":visible")) {
          $("#theme-preview").show();
        }
      }
    });

    $("#filemanager").bind('resourceeditor.closed', function(event, path) {
      path = normalizePath(path);
      if($("#editor-preview-frame").data('current') == path) {
        $("#theme-preview").hide();
      }
    });

    $("#filemanager").bind('resourceeditor.saved', function(event, path) {
      reloadFrame();
    });

  });

});
</script>

</metal:block>
</head>

<body>
<div metal:fill-slot="prefs_configlet_content" class="documentEditable" tal:define="resourceDirectory nocall:view/resourceDirectory">

    <!-- simulating views on the groups/user pages until we have real objects. -->
    <div id="edit-bar">
        <ul class="contentViews" id="content-views">
          <li class="selected">
            <a tal:attributes="href string:${view/portalUrl}/++theme++${view/name}/@@theming-controlpanel-filemanager"
               i18n:translate="label_tab_file_manager">
               Manage theme files
            </a>
          </li>
          <li>
            <a tal:attributes="href string:${view/portalUrl}/++theme++${view/name}/@@theming-controlpanel-mapper"
               i18n:translate="label_tab_theming_mapper">
               Preview and map rules
            </a>
          </li>
        </ul>

        <div class="contentActions">&nbsp;</div>
    </div>

    <div metal:use-macro="context/global_statusmessage/macros/portal_message">
      Portal status message
    </div>

    <dl class="portalMessage warning" tal:condition="view/active">
        <dt i18n:translate="">Warning</dt>
        <dd i18n:translate="theming_mapper_warning_live">
            This theme is currently active. Any changes made will be immediately
            reflected on the live site.
        </dd>
    </dl>

    <div id="content">

      <h1 class="documentFirstHeading"
          i18n:translate="heading_edit_theme">Manage files for
          <span i18n:name="name" tal:content="view/title">name</span></h1>

      <a href=""
          class="link-parent"
          tal:attributes="href string:${portal_url}/@@theming-controlpanel"
          i18n:translate="label_up_to_theming_controlpanel">
              Back to the control panel
      </a>

      <p class="discreet" i18n:translate="help_theme_filemanager">
          You can edit files in the theme by opening them from the file
          tree. Use the buttons on the toolbar to create new folders and
          files. You can right-click on items in the file tree to download,
          delete or rename them.
      </p>

      <metal:block use-macro="resourceDirectory/@@plone.resourceeditor.filemanager/macros/filemanager" />

      <div id="theme-preview">
        <h2 i18n:translate="label_theme_preview">Preview of
          <span i18n:name="filename" id="theme-preview-filename"></span>
        </h2>
        <iframe id="editor-preview-frame" src=""></iframe>
    </div>



  </div>

</div>
</body>
</html>
