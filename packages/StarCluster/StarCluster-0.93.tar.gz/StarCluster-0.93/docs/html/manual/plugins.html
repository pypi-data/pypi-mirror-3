
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>StarCluster Plugin System &mdash; StarCluster v0.93 documentation</title>
    <link rel="stylesheet" href="../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.93',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="StarCluster v0.93 documentation" href="../index.html" />
    <link rel="up" title="StarCluster User Manual" href="index.html" />
    <link rel="next" title="Adding and Removing Nodes from StarCluster" href="addremovenode.html" />
    <link rel="prev" title="Listing All Public StarCluster AMIs" href="list_public_amis.html" />
<link rel="stylesheet" href="../_static/nobile.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="../_static/neuton.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../_static/starcluster.ico"/>

  </head>
  <body>
<div class="header-small">
	
	<div class="logo-small">
		<a href="../index.html">
      		<img class="logo" src="../_static/logo-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="addremovenode.html" title="Adding and Removing Nodes from StarCluster"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="list_public_amis.html" title="Listing All Public StarCluster AMIs"
             accesskey="P">previous</a> |</li>
    	<li><a href="../index.html">Home</a> &raquo;</li>
          <li><a href="../contents.html" >Master Table of Contents</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">StarCluster User Manual</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="starcluster-plugin-system">
<span id="plugin-system"></span><h1>StarCluster Plugin System<a class="headerlink" href="#starcluster-plugin-system" title="Permalink to this headline">¶</a></h1>
<p>StarCluster has support for user contributed plugins. Plugins allow developers
to further configure the cluster in addition to the default cluster
configuration provided by StarCluster. Plugins are used to provide custom
cluster configurations for a variety of computing needs.</p>
<div class="section" id="creating-a-new-plugin">
<h2>Creating a New Plugin<a class="headerlink" href="#creating-a-new-plugin" title="Permalink to this headline">¶</a></h2>
<p>A StarCluster plugin is simply a Python class that extends
<strong>starcluster.clustersetup.ClusterSetup</strong> and implements a <em>run</em> method.  This
class must live in a module that is on the PYTHONPATH. By default, StarCluster
will add the ~/.starcluster/plugins directory to the PYTHONPATH automatically.
The ~/.starcluster/plugins directory is not created automatically so you will
need to create it if it does not exist.</p>
<p>Below is a very simple example of a StarCluster plugin that installs a package
on each node using apt-get after the cluster has been configured:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">starcluster.clustersetup</span> <span class="kn">import</span> <span class="n">ClusterSetup</span>

<span class="k">class</span> <span class="nc">PackageInstaller</span><span class="p">(</span><span class="n">ClusterSetup</span><span class="p">):</span>
     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_to_install</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">pkg_to_install</span> <span class="o">=</span> <span class="n">pkg_to_install</span>
     <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">user_shell</span><span class="p">,</span> <span class="n">volumes</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
               <span class="n">node</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;apt-get -y install </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_to_install</span><span class="p">)</span>
</pre></div>
</div>
<p>For this example we assume that this class lives in a module file called
<strong>ubuntu.py</strong> and that this file lives in the ~/.starcluster/plugins directory.</p>
<p>This is a very simple example that simply demonstrates how to execute a command
on each node in the cluster. For a more sophisticated example, have a look at
StarCluster&#8217;s default setup class
<strong>starcluster.clustersetup.DefaultClusterSetup</strong>. This is the class used to
perform StarCluster&#8217;s default setup routines. The DefaultClusterSetup class
should provide you with a more complete example of the plugin API and the types
of things you can do with the arguments passed to a plugin&#8217;s <em>run</em> method.</p>
</div>
<div class="section" id="using-the-logging-system">
<h2>Using the Logging System<a class="headerlink" href="#using-the-logging-system" title="Permalink to this headline">¶</a></h2>
<p>When writing plugins it&#8217;s better to use StarCluster&#8217;s logging system rather
than print statements in your code. This is because the logging system handles
formatting messages and writing them to the StarCluster debug file. Here&#8217;s a
modified version of the <em>PackageInstaller</em> plugin above that uses the logging
system:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">starcluster.clustersetup</span> <span class="kn">import</span> <span class="n">ClusterSetup</span>
<span class="kn">from</span> <span class="nn">starcluster.logger</span> <span class="kn">import</span> <span class="n">log</span>

<span class="k">class</span> <span class="nc">PackageInstaller</span><span class="p">(</span><span class="n">ClusterSetup</span><span class="p">):</span>
     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_to_install</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">pkg_to_install</span> <span class="o">=</span> <span class="n">pkg_to_install</span>
          <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;pkg_to_install = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pkg_to_install</span><span class="p">)</span>
     <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">user_shell</span><span class="p">,</span> <span class="n">volumes</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
               <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Installing </span><span class="si">%s</span><span class="s"> on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_to_install</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>
               <span class="n">node</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;apt-get -y install </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_to_install</span><span class="p">)</span>
</pre></div>
</div>
<p>The first thing you&#8217;ll notice is that we&#8217;ve added an additional import
statement to the code. This line imports the log object that you&#8217;ll use to log
messages. In the plugin&#8217;s constructor we&#8217;ve added a log.debug() call that shows
the current value of the pkg_to_install variable.  All messages logged with the
log.debug() method will always be printed to the debug file, however, these
messages will only be printed to the screen if the user passes the &#8211;debug flag
to the starcluster command.</p>
<p>In the plugin&#8217;s <em>run</em> method, we&#8217;ve added a log.info() call to notify the user
that the package they specified in the config is being installed on a
particular node. All messages logged with the log.info() method will always be
printed to the screen and also go into the debug file. In addition to
log.info() and log.debug() there are also log.warn(), log.critical(),
log.fatal(), and log.error() methods for logging messages of varying severity.</p>
</div>
<div class="section" id="adding-your-plugin-to-the-config">
<h2>Adding Your Plugin to the Config<a class="headerlink" href="#adding-your-plugin-to-the-config" title="Permalink to this headline">¶</a></h2>
<p>To use a plugin we must first add it to the config and then add the plugin&#8217;s
config to a <em>cluster template</em>. Below is an example config for the example
plugin above:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[plugin pkginstaller]</span>
<span class="na">setup_class</span> <span class="o">=</span> <span class="s">ubuntu.PackageInstaller</span>
<span class="na">pkg_to_install</span> <span class="o">=</span> <span class="s">htop</span>
</pre></div>
</div>
<p>In this example, pkg_to_install is an argument to the plugin&#8217;s constructor (ie
__init__). A plugin can, of course, define multiple construtor arguments and
you can configure these arguments in the config similar to <em>pkg_to_install</em> in
the above example.</p>
<p>After you&#8217;ve defined a <strong>[plugin]</strong> section, you can now use this plugin in a
<em>cluster template</em> by configuring its <strong>plugins</strong> setting:</p>
<div class="highlight-ini"><pre>[cluster smallcluster]
....
plugins = pkginstaller</pre>
</div>
<p>This setting instructs StarCluster to run the <em>pkginstaller</em> plugin after
StarCluster&#8217;s default setup routines. If you want to use more than one plugin
in a template you can do so by providing a list of plugins:</p>
<div class="highlight-ini"><pre>[cluster smallcluster]
....
plugins = pkginstaller, myplugin</pre>
</div>
<p>In the example above, starcluster would first run the <em>pkginstaller</em> plugin and
then the <em>myplugin</em> plugin afterwards. In short, order matters when defining
plugins to use in a <em>cluster template</em>.</p>
</div>
<div class="section" id="using-the-development-shell">
<h2>Using the Development Shell<a class="headerlink" href="#using-the-development-shell" title="Permalink to this headline">¶</a></h2>
<p>To launch StarCluster&#8217;s development shell, use the <em>shell</em> command:</p>
<div class="highlight-python"><pre>$ starcluster shell
StarCluster - (http://web.mit.edu/starcluster) (v. 0.9999)
Software Tools for Academics and Researchers (STAR)
Please submit bug reports to starcluster@mit.edu

&gt;&gt;&gt; Importing module config
&gt;&gt;&gt; Importing module plugins
&gt;&gt;&gt; Importing module cli
&gt;&gt;&gt; Importing module awsutils
&gt;&gt;&gt; Importing module ssh
&gt;&gt;&gt; Importing module utils
&gt;&gt;&gt; Importing module static
&gt;&gt;&gt; Importing module exception
&gt;&gt;&gt; Importing module cluster
&gt;&gt;&gt; Importing module node
&gt;&gt;&gt; Importing module clustersetup
&gt;&gt;&gt; Importing module image
&gt;&gt;&gt; Importing module volume
&gt;&gt;&gt; Importing module tests
&gt;&gt;&gt; Importing module templates
&gt;&gt;&gt; Importing module optcomplete
&gt;&gt;&gt; Importing module boto
&gt;&gt;&gt; Importing module paramiko

[~]|1&gt;</pre>
</div>
<p>This launches you into an <a class="reference external" href="http://ipython.scipy.org">IPython</a> shell with all of the StarCluster modules
automatically loaded. You&#8217;ll also notice that you have the following variables
available to you automagically:</p>
<ol class="arabic simple">
<li><strong>cm</strong> - manager object for clusters (<tt class="docutils literal"><span class="pre">starcluster.cluster.ClusterManager</span></tt>)</li>
<li><strong>cfg</strong> - object for retrieving values from the config file
(<tt class="docutils literal"><span class="pre">starcluster.config.StarClusterConfig</span></tt>)</li>
<li><strong>ec2</strong> - object for interacting with EC2 (<tt class="docutils literal"><span class="pre">starcluster.awsutils.EasyEC2</span></tt>)</li>
<li><strong>s3</strong> - object for interacting with S3 (<tt class="docutils literal"><span class="pre">starcluster.awsutils.EasyS3</span></tt>)</li>
</ol>
</div>
<div class="section" id="plugin-development-workflow">
<h2>Plugin Development Workflow<a class="headerlink" href="#plugin-development-workflow" title="Permalink to this headline">¶</a></h2>
<p>The process of developing and testing a plugin generally goes something like
this:</p>
<ol class="arabic">
<li><p class="first">Start a small test cluster (2-3 nodes):</p>
<div class="highlight-python"><pre>$ starcluster start testcluster -s 2</pre>
</div>
</li>
<li><p class="first">Install and configure the additional software/settings by hand and note the
steps involved:</p>
<div class="highlight-python"><pre>$ starcluster sshmaster testcluster
root@master $ apt-get install myapp
...</pre>
</div>
</li>
<li><p class="first">Write a first draft of your plugin that attempts to do these steps
programmatically</p>
</li>
<li><p class="first">Add your plugin to the StarCluster configuration file</p>
</li>
<li><p class="first">Test your plugin on your small test cluster using the <strong>runplugin</strong> command:</p>
<div class="highlight-python"><pre>$ starcluster runplugin myplugin testcluster</pre>
</div>
<p>Alternatively, you can also run your plugin using the development shell
(requires <a class="reference external" href="http://ipython.scipy.org">IPython</a>):</p>
<div class="highlight-python"><pre>$ starcluster shell
[~]&gt; cm.run_plugin('myplugin', 'testcluster')</pre>
</div>
</li>
<li><p class="first">Fix any coding errors in order to get the plugin to run from start to finish
using the <strong>runplugin</strong> command.</p>
</li>
<li><p class="first">Login to the master node and verify that the plugin was successful:</p>
<div class="highlight-python"><pre>$ starcluster sshmaster testcluster</pre>
</div>
</li>
</ol>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">StarCluster Plugin System</a><ul>
<li><a class="reference internal" href="#creating-a-new-plugin">Creating a New Plugin</a></li>
<li><a class="reference internal" href="#using-the-logging-system">Using the Logging System</a></li>
<li><a class="reference internal" href="#adding-your-plugin-to-the-config">Adding Your Plugin to the Config</a></li>
<li><a class="reference internal" href="#using-the-development-shell">Using the Development Shell</a></li>
<li><a class="reference internal" href="#plugin-development-workflow">Plugin Development Workflow</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="list_public_amis.html"
                        title="previous chapter">Listing All Public StarCluster AMIs</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="addremovenode.html"
                        title="next chapter">Adding and Removing Nodes from StarCluster</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="addremovenode.html" title="Adding and Removing Nodes from StarCluster"
             >next</a> |</li>
        <li class="right" >
          <a href="list_public_amis.html" title="Listing All Public StarCluster AMIs"
             >previous</a> |</li>
    	<li><a href="../index.html">Home</a> &raquo;</li>
          <li><a href="../contents.html" >Master Table of Contents</a> &raquo;</li>
          <li><a href="index.html" >StarCluster User Manual</a> &raquo;</li> 
      </ul>
    </div>


    <div class="footer">
        &copy; Copyright 2011, Software Tools for Academics and Researchers.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>


<script type="text/javascript">
//<![CDATA[
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    //]]>
    </script><script type="text/javascript">
//<![CDATA[
    try{
        var pageTracker = _gat._getTracker("UA-1048253-12");
        pageTracker._trackPageview();
    } catch(err) {}
    //]]>
    </script>

  </body>
</html>