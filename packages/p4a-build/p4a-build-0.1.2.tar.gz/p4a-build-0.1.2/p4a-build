#!/usr/bin/env python

host = 'http://txzone.net:5000/'
url_form = host
url_submit = host + 'submit'

import json
import os
import re
import requests
import tempfile
import zipfile

def zipper(d, zip_file):
    zfd = zipfile.ZipFile(zip_file, 'w', compression=zipfile.ZIP_DEFLATED)
    root_len = len(os.path.abspath(d))
    for root, dirs, files in os.walk(d):
        archive_root = os.path.abspath(root)[root_len:]
        for f in files:
            fullpath = os.path.join(root, f)
            archive_name = os.path.join(archive_root, f)
            zfd.write(fullpath, archive_name, zipfile.ZIP_DEFLATED)
    zfd.close()
    return zip_file


def submit_package(args):
    s = requests.session()

    # first time, just get the csrf token
    r = s.get(url_form)
    csrf = re.search(u'name="csrf" type="hidden" value="(.*)"',
            r.content).groups()[0]

    # create a zip of the whole directory
    zfd, zfn = tempfile.mkstemp(suffix='.zip')
    zipper(args.dir, zfn)

    # build the data and push it
    payload = {
        'package_name': args.package,
        'package_version': args.version,
        'package_title': args.name,
        'modules': args.modules,
        'csrf': csrf,
        'batch': '1'}
    with open(zfn, 'rb') as fd:
        files = {'directory': (zfn, fd)}
        r = s.post(url_submit, data=payload, files=files)
    r.raise_for_status()

    data = json.loads(r.text)
    print
    print 'Package submitted to P4A Cloud.'
    print 'Get the build progress at:', data['url']
    print

if __name__ == '__main__':
    import argparse

    ap = argparse.ArgumentParser(description='''\
P4A Build tool using P4A Cloud.
''')

    ap.add_argument('--package', dest='package', required=True,
        help='The name of the java package the project will be packaged under.')
    ap.add_argument('--name', dest='name', required=True,
        help='The human-readable name of the project.')
    ap.add_argument('--version', dest='version', required=True,
        help=('The version number of the project.'
        'This should consist of numbers and dots, and should have the same '
        'number of groups of numbers as previous versions.'))
    ap.add_argument('--dir', dest='dir', required=True,
        help='The directory containing files for the project.')
    ap.add_argument('--modules', dest='modules', required=True,
        help='Modules to compile with the program')

    args = ap.parse_args()

    submit_package(args)
