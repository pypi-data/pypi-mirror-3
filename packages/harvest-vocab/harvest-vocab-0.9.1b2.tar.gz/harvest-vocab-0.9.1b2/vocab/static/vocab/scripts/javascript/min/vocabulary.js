define(["jquery","underscore","cilantro/define/viewelement"],function(a,b,c){var d,e,f,g,h,i,j;return e='<% for (var b, i = 0; i < breadcrumbs.length; i++) { %>\n    <% b = breadcrumbs[i]; %>\n    <% if (i === (breadcrumbs.length-1)) {%>\n        <span title="<%= b.name %>"><%= b.name %></span>\n    <% } else { %>\n        <a href="<%= b.uri %>" title="<%= b.name %>"><%= b.name %></a> <span class="breadcrumb-arrow">&rarr;</span>\n    <% } %>\n<% } %>',f='<li data-id="<%= id %>" data-uri="<%= uri %>" <% if (!terminal) { %>class="folder"<% } %>>\n    <button class="button-add">+</button>\n    <span class="name"><%= name %>\n        <% if (attrs) { %>\n            <br><small class="info"><% for (var k in attrs) { %>\n                <%= k %>: <%= attrs[k] %>\n            <% } %></small>\n        <% } %>\n    </span>\n</li>',h='<li data-id="<%= id %>" <% if (!terminal) { %>class="folder"<% } %>>\n    <button class="button-add">+</button>\n    <span>\n        <% if (search_only) { %>\n            <span><%= name %></span>\n        <% } else { %>\n            <a href="<%= parent.uri %>"><%= name %></a>\n        <% } %>\n        <% if (attrs) { %>\n            <br><small class="info"><% for (var k in attrs) { %>\n                <%= k %>: <%= attrs[k] %>\n            <% } %></small>\n        <% } %>\n    </span>\n</li>',i='<li data-id="<%= id %>" <% if (!terminal) { %>class="folder"<% } %>>\n    <span class="icon">optional</span>\n    <% if (search_only) { %>\n        <span class=text><%= name %></span>\n    <% } else { %>\n        <a class=text href="<%= parent.uri %>"><%= name %></a>\n    <% } %>\n    <span class="clear">X</span>',j='<div id="vocab-browser-<%= pk %>" class="vocab-browser">\n    <% if (!search_only) { %>\n        <div class="vocab-tabs tabs">\n            <a class="tab" href="#browse-tab-<%= pk %>">Browse <%= title %></a>\n            <a class="tab" href="#search-tab-<%= pk %>">Search <%= title %></a>\n        </div>\n    <% } %>\n    <div>\n        <% if (!search_only) { %>\n            <div id="browse-tab-<%= pk %>">\n                <div class=vocab-breadcrumbs></div>\n                <ul class="vocab-browse-results list"></ul>\n            </div>\n        <% } %>\n\n        <div id="search-tab-<%= pk %>">\n            <form method="get" action="<%= directory %>">\n                <input type="text" class="vocab-search" name="q" placeholder="Search...">\n                <em>Note: only the first 100 results are displayed</em>\n            </form>\n            <div>\n                <ul class="vocab-search-results list">\n                    <li class="start">Enter search terms above. Results can be clicked to go to their location in the Browse tab.</li>\n                </ul>\n            </div>\n        </div>\n\n        <h2>Selected <%= title %></h2>\n\n        <ul class=vocab-staging-operations>\n            <li class="optional">optional</li>\n            <li class="require">require</li>\n            <li class="exclude">exclude</li>\n        </ul>\n\n        <ul class=vocab-staging></ul>\n\n    </div>\n</div>',d={require:"all",exclude:"-all",optional:"in",all:"require","-all":"exclude","in":"optional"},g=function(a){var b;for(b in a)return!1;return!0},c.extend({constructor:function(a,b){return this.base(a,b),this.datasource={}},_showItemBrowser:function(b){var c,d,e;return c=this.browseResults,d=a(b),e=d.parents("li"),this.tabs.tabs("toggle",0),this.loadBrowseList(d.attr("href"),function(){return b=c.find("[data-id="+e.data("id")+"]"),c.scrollTo(b,500,{offset:-150,onAfter:function(){return b.effect("highlight",null,2e3)}})}),!1},_renderBrowse:function(b){var c,d,e=this;return c=this.browseResults=a(".vocab-browse-results",b),c.on("click","button",function(b){var c;return c=a(b.currentTarget).parent(),e.stageItem(c.data()),!1}),c.on("click",".folder",function(b){return e.loadBrowseList(a(b.currentTarget).data("uri")),!1}),this.tabs=d=a(".vocab-tabs",b),d.tabs(!1,function(c,e){var f;return f=d.find(".tab"),f.each(function(c,d){return a(d.hash,b).hide()}),a(e.prop("hash"),b).show()}),this.browseBreadcrumbs=a(".vocab-breadcrumbs",b).on("click","a",function(a){return e.loadBrowseList(a.target.href),!1})},_renderSearch:function(b){var c,d,e=this;return d=a(".vocab-search",b),c=a(".vocab-search-results",b),c.on("click","button",function(b){var c;return c=a(b.currentTarget).parent(),e.stageItem(c.data()),!1}),c.on("click","a",function(a){return e._showItemBrowser(a.currentTarget),!1}),d.autocomplete2({start:function(){return c.block()},success:function(b,d){c.empty();if(!d.length){c.html('<li class="empty">No results found.</li>');return}return a.each(d,function(a,b){var d;return d=e.renderListElement(b,h),c.append(d)}),e.refreshResultState(),c.unblock()}})},_renderStaging:function(b){var c,e,f,g=this;return f=a(".vocab-staging-operations",b),this.stagedItems=e=a(".vocab-staging",b),c=this,e.on("click","li .icon",function(b){var e,g,h;return f.off(),e=a(this),g=e.parent(),f.on("click","li",function(b){var h;return h=a(this),e.text(h.text()),g.removeClass("optional require exclude"),g.addClass(h.prop("className")),c.datasource[g.data("id")]=d[h.prop("className")],f.hide()}),h=g.position(),f.css({top:h.top-g.height()+1,left:h.left+1}).show()}),e.on("click","li .clear",function(b){var c;return c=a(b.target).parent(),c.hide(),g.unstageItem(c.data("id")),g.refreshResultState()}),e.on("click","a",function(a){return g._showItemBrowser(a.currentTarget),!1})},render:function(){var c;this.dom=c=a(b.template(j,this.viewset)),this._renderSearch(c),this._renderStaging(c);if(!this.viewset.search_only)return this._renderBrowse(c),this.loadBrowseList()},stageItem:function(a,b){var c;return b==null&&(b=d.optional),this.datasource[a.id]||(c=this.renderListElement(a,i,b),this.stagedItems.append(c)),this.datasource[a.id]=b,this.refreshResultState()},unstageItem:function(a){return delete this.datasource[a],this.refreshResultState()},constructQuery:function(){var a,c,d,e,f,g,h;f={},c={concept_id:this.concept_pk,custom:!0},h=this.datasource;for(d in h)g=h[d],f[g]||(f[g]=[]),f[g].push(d);if((e=b.keys(f).length)===0)c.value=void 0;else if(e===1)c.id=this.viewset.pk,c.value=f[g],c.operator=g;else{a=[];for(d in f)g=f[d],a.push({id:this.viewset.pk,value:g,operator:d,concept_id:this.concept_pk});c.type="and",c.children=a}return this.dom.trigger("ConstructQueryEvent",[c])},updateDS:function(a,b){var c,d,e,f,h,i;d=this,this.refreshResultState();if(!g(b)){if(b.children){h=b.children,i=[];for(e=0,f=h.length;e<f;e++)c=h[e],i.push(d._updateDS(c.value,c.operator));return i}return d._updateDS(b.value,b.operator)}},_updateDS:function(b,c){var d;return d=this,a.each(b,function(b,e){return a.ajax({url:d.viewset.directory+e+"/",success:function(a){return d.stageItem(a,c)}})})},updateElement:function(a,b){},elementChanged:function(a,b){},loadBrowseList:function(c,d){var g,h=this;return this.browseResults.block(),c=c||this.viewset.directory,g=[{name:"All",uri:this.viewset.directory}],a.getJSON(c,function(a){var c,i,j,k,l,m;h.browseResults.empty(),h.browseBreadcrumbs.empty(),b.isArray(a)?j=a:(j=a.children,g=g.concat(a.ancestors.length?a.ancestors:[]),g.push({name:a.name}));for(l=0,m=j.length;l<m;l++)i=j[l],c=h.renderListElement(i,f),h.browseResults.append(c);return k=b.template(e,{breadcrumbs:g}),h.browseBreadcrumbs.html(k),h.refreshResultState(),typeof d=="function"&&d(),h.browseResults.unblock()})},renderListElement:function(c,e,f){var g,h;return f==null&&(f=d.optional),c.parent||(!c.ancestors||c.ancestors.length===0?c.parent={uri:this.viewset.directory}:c.parent={uri:c.ancestors[0].uri}),c.search_only=this.viewset.search_only,g=a(b.template(e,c)),h=d[f],g.addClass(h).find(".icon").text(h),g.data(c),g},refreshResultState:function(){var b,c;a("li",this.browseResults).removeClass("added"),a("button",this.browseResults).attr("disabled",!1),a("li",this.searchResults).removeClass("added"),a("button",this.searchResults).attr("disabled",!1),c=[];for(b in this.datasource)a("li[data-id="+b+"]",this.browseResults).addClass("added").find("button").attr("disabled",!0),c.push(a("li[data-id="+b+"]",this.searchResults).addClass("added").find("button").attr("disabled",!0));return c}})})