<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>How to implement new commands &mdash; PowerConsole v0.7 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.7',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="PowerConsole v0.7 documentation" href="index.html" />
    <link rel="next" title="PowerConsole Core modules and classes" href="pwc.html" />
    <link rel="prev" title="Standard Commands" href="stdcmd.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="modindex.html" title="Global Module Index"
             accesskey="M">modules</a> |</li>
        <li class="right" >
          <a href="pwc.html" title="PowerConsole Core modules and classes"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="stdcmd.html" title="Standard Commands"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">PowerConsole v0.7 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="how-to-implement-new-commands">
<h1>How to implement new commands<a class="headerlink" href="#how-to-implement-new-commands" title="Permalink to this headline">¶</a></h1>
<p>Writting new commands is quite simple and straightforward process. The only one harder or trickier part
is grammar definition for the command, which requires careful design and thinking.</p>
<p>Because PowerConsole uses <a class="reference external" href="http://pyparsing.wikispaces.com/">PyParsing</a> to process commands to Python function calls, you should start by
familiarize yourself with it. PyParsing provides a library of classes that you can use to construct
the grammar directly in Python code. The grammar representation is quite readable, owing to
the self-explanatory class names, and the use of &#8216;+&#8217;, &#8216;|&#8217; and &#8216;^&#8217; operator definitions.</p>
<p>The PyParsing website and especially the distribution package itself contains documentation and quite
a lot of examples.</p>
<p>You will need <tt class="xref docutils literal"><span class="pre">setuptools</span></tt> installed. if you don&#8217;t have setuptools yet, you can install it by
downloading and running <a class="reference external" href="http://peak.telecommunity.com/dist/ez_setup.py">ez_setup.py</a>.</p>
<div class="section" id="process-overview">
<h2>Process Overview<a class="headerlink" href="#process-overview" title="Permalink to this headline">¶</a></h2>
<p>To create a new command you need to do next steps:</p>
<ol class="arabic">
<li><p class="first">Create a new project (directory) for your command package.</p>
</li>
<li><p class="first">Define a <cite>namespace</cite> package &#8216;pwc&#8217; in it. Simply create a subdirectory named <tt class="docutils literal"><span class="pre">pwc</span></tt> and place the file
<tt class="docutils literal"><span class="pre">__init__.py</span></tt> with next content to it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">__import__</span><span class="p">(</span><span class="s">&#39;pkg_resources&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">declare_namespace</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</pre></div>
</div>
<p>Actually, this step is not really necessary, but it&#8217;s advised practice to use the namespace module instead
creating new modules.</p>
</li>
<li><p class="first">Create a new module in package &#8216;pwc&#8217; for your commands. The module name needs a little bit of thinking
to avoid name collisions with command modules created by other developers.</p>
</li>
<li><p class="first">Create <tt class="docutils literal"><span class="pre">setup.py</span></tt> for you package.</p>
</li>
<li><p class="first">Create a class inherited from <a title="pwc.base.Command" class="reference external" href="pwc.html#pwc.base.Command"><tt class="xref docutils literal"><span class="pre">pwc.base.Command</span></tt></a> in your command module. Implement <em>four</em> methods.</p>
</li>
<li><p class="first">Define the <em>full</em> and <em>check</em> grammars for your command.</p>
</li>
<li><p class="first">Implement the command behavior.</p>
</li>
<li><p class="first">Install your command package.</p>
</li>
<li><p class="first">Profit.</p>
</li>
</ol>
</div>
<div class="section" id="grammar-definition">
<h2>Grammar definition<a class="headerlink" href="#grammar-definition" title="Permalink to this headline">¶</a></h2>
<p>Grammar is defined in <a title="(in Python v2.6)" class="reference external" href="http://docs.python.org/reference/datamodel.html#object.__init__"><tt class="xref docutils literal"><span class="pre">__init__()</span></tt></a> method of your command class using <a class="reference external" href="http://pyparsing.wikispaces.com/">PyParsing</a> building blocks. These
blocks compose a parsing tree, where some nodes may play a special role. You can define your grammar as you see
fit for your purpose, but to define a grammar that could be sucessfuly used by PowerConsole, you have to
follow few rules.</p>
<ol class="arabic simple">
<li>One grammar node must be defined as <em>name</em> node for the command. It&#8217;s typically a node that defines the
command&#8217;s keyword, but it could be also an empty node. To define node as <em>name</em> node, call the inherited
method <a title="pwc.base.Command._makeNameNode" class="reference external" href="pwc.html#pwc.base.Command._makeNameNode"><tt class="xref docutils literal"><span class="pre">_makeNameNode()</span></tt></a> and pass the node as parameter.</li>
<li>You have to wrap the complete grammar into single node and set its parsing action to inherited method
<a title="pwc.base.Command._compile" class="reference external" href="pwc.html#pwc.base.Command._compile"><tt class="xref docutils literal"><span class="pre">_compile()</span></tt></a>. This node must be returned by method <a title="pwc.base.Command._getGrammar" class="reference external" href="pwc.html#pwc.base.Command._getGrammar"><tt class="xref docutils literal"><span class="pre">_getGrammar()</span></tt></a>.</li>
<li>You have to define initial fixed part of your grammar as separate node that defines the &#8216;check&#8217; grammar.
This node must be returned by method <a title="pwc.base.Command._getCmdKeyword" class="reference external" href="pwc.html#pwc.base.Command._getCmdKeyword"><tt class="xref docutils literal"><span class="pre">_getCmdKeyword()</span></tt></a>.</li>
<li>The method <a title="pwc.base.Command.execute" class="reference external" href="pwc.html#pwc.base.Command.execute"><tt class="xref docutils literal"><span class="pre">execute()</span></tt></a> that implements the command actions can have named parameters. Grammar
nodes that define values for these parameters must have set the <cite>results name</cite> that&#8217;s the same as parameter
name.</li>
</ol>
<p>One example is better than thousand words, so here are some example grammars:</p>
<div class="section" id="simple-command-with-parameters">
<h3>Simple command with parameters<a class="headerlink" href="#simple-command-with-parameters" title="Permalink to this headline">¶</a></h3>
<p>This example shows the definition of built-in command LIST.</p>
<p>Grammar:</p>
<div class="highlight-python"><pre>LIST [&lt;attribute&gt;[,&lt;attribute&gt;] IN] &lt;expression&gt;</pre>
</div>
<p>Definition:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">controller</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="c"># Grammar</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keyList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeNameNode</span><span class="p">(</span><span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;list&#39;</span><span class="p">))</span>
    <span class="n">keyAttr</span> <span class="o">=</span> <span class="n">delimitedList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IDENT</span><span class="p">,</span><span class="n">combine</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;attr&#39;</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;in&#39;</span><span class="p">)</span>
    <span class="c"># LIST [&lt;attribute&gt;,&lt;attribute&gt; IN] &lt;expression&gt;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cmdList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyList</span> <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">keyAttr</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPR</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;expr&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cmdList</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_getGrammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdList</span>
<span class="k">def</span> <span class="nf">_getCmdKeyword</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyList</span>

<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">expr</span><span class="p">,</span><span class="n">attr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The <em>check grammar</em> node is caseless keyword &#8216;list&#8217;. It&#8217;s also defined as <em>name node</em>. Because the expression
is last element of the grammar and could potentially span over multiple lines, we can use inherited definition
EXPR that&#8217;s  defined in <a title="pwc.base.Command" class="reference external" href="pwc.html#pwc.base.Command"><tt class="xref docutils literal"><span class="pre">pwc.base.Command</span></tt></a> for your convenience as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">CHUNK</span>        <span class="o">=</span> <span class="n">CharsNotIn</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">EXPR</span>         <span class="o">=</span> <span class="n">White</span><span class="p">()</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s">&#39;&lt;expr&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">suppress</span><span class="p">()</span> <span class="o">+</span> <span class="n">OneOrMore</span><span class="p">(</span><span class="n">CHUNK</span> <span class="o">+</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">Optional</span><span class="p">(</span><span class="n">lineEnd</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">replaceWith</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)))</span> <span class="o">+</span>
                <span class="n">FollowedBy</span><span class="p">(</span><span class="n">CHUNK</span><span class="p">))</span> <span class="o">^</span>
                <span class="n">Optional</span><span class="p">(</span><span class="n">lineEnd</span><span class="o">.</span><span class="n">suppress</span><span class="p">())</span>
                <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s">&#39;expr&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We assigned the results name &#8216;expr&#8217; to it, because our execute method expects one parameter with this name.
Note that line end is replaced with space, so the expression is compiled as it would be on single line.
The <em>full grammar</em> is cmdList and has assigned parse action <a title="pwc.base.Command._compile" class="reference external" href="pwc.html#pwc.base.Command._compile"><tt class="xref docutils literal"><span class="pre">pwc.base.Command._compile()</span></tt></a>.</p>
</div>
<div class="section" id="simple-command-with-many-parameters">
<h3>Simple command with many parameters<a class="headerlink" href="#simple-command-with-many-parameters" title="Permalink to this headline">¶</a></h3>
<p>Here is an example of simple command with many parameters, some of them optional.</p>
<p>Grammar:</p>
<div class="highlight-python"><pre>CONNECT 'dsn or db' [HOST host][USER 'user'][PASSWORD 'password'] [CACHE int ][ROLE 'role'][AS var]</pre>
</div>
<p>Definition:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keyConnect</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeNameNode</span><span class="p">(</span><span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;connect&#39;</span><span class="p">))</span>
    <span class="c"># we don&#39;t need to keep next tokens as instance attributes</span>
    <span class="n">keyUser</span>     <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">)</span>
    <span class="n">keyPassword</span> <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;password&#39;</span><span class="p">)</span>
    <span class="n">keyCache</span>    <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;cache&#39;</span><span class="p">)</span>
    <span class="n">keyRole</span>     <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;role&#39;</span><span class="p">)</span>
    <span class="n">keyAs</span>       <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;as&#39;</span><span class="p">)</span>
    <span class="n">keyHost</span>     <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;host&#39;</span><span class="p">)</span>
    <span class="n">optUser</span>     <span class="o">=</span> <span class="n">keyUser</span> <span class="o">+</span> <span class="n">QuotedString</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFailAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">)</span>
    <span class="n">optPassword</span> <span class="o">=</span> <span class="n">keyPassword</span> <span class="o">+</span> <span class="n">QuotedString</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;password&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFailAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">)</span>
    <span class="n">optCache</span>    <span class="o">=</span> <span class="n">keyCache</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">INTEGER</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;cache&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFailAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">)</span>
    <span class="n">optRole</span>     <span class="o">=</span> <span class="n">keyRole</span> <span class="o">+</span> <span class="n">QuotedString</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;role&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFailAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">)</span>
    <span class="n">optAs</span>       <span class="o">=</span> <span class="n">keyAs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">IDENT</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;intoVar&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFailAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">)</span>
    <span class="n">optHost</span>     <span class="o">=</span> <span class="n">keyHost</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">IDENT</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;host&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFailAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">)</span>

    <span class="c"># CONNECT &#39;dsn&#39; [USER &#39;user&#39;][PASSWORD &#39;password&#39;]</span>
    <span class="c">#  [CACHE int ][ROLE &#39;role&#39;][AS var]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cmdConnect</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyConnect</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILENAME</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;db&#39;</span><span class="p">)</span> \
        <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">optHost</span><span class="p">)</span> <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">optUser</span><span class="p">)</span> <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">optPassword</span><span class="p">)</span> \
        <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">optCache</span><span class="p">)</span> <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">optRole</span><span class="p">)</span> <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">optAs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cmdConnect</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_getGrammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdConnect</span>
<span class="k">def</span> <span class="nf">_getCmdKeyword</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyConnect</span>
<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">db</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The <em>check grammar</em> node is caseless keyword &#8216;connect&#8217;. It&#8217;s also defined as <em>name node</em>. <em>optXXX</em> are nodes
for command options. The value part has assigned fail action to inherited <a title="pwc.base.Command._fail" class="reference external" href="pwc.html#pwc.base.Command._fail"><tt class="xref docutils literal"><span class="pre">_fail()</span></tt></a> to
get nice error reporting if value is not entered. We also must assign a ResultsName for each value to name that
our execute methoud would recognize. For file name we could utilize the inherited FILENAME node that&#8217;s defined
as follow:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">FILENAME</span>     <span class="o">=</span> <span class="p">(</span><span class="n">Word</span><span class="p">(</span><span class="n">alphas</span> <span class="o">+</span>
                <span class="n">alphas8bit</span> <span class="o">+</span> <span class="n">nums</span> <span class="o">+</span> <span class="s">&#39;_/\-:.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s">&#39;filename&#39;</span><span class="p">)</span> <span class="o">|</span>
                <span class="n">QuotedString</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s">&#39;filename&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <em>full grammar</em> is cmdConnect and has assigned parse action <a title="pwc.base.Command._compile" class="reference external" href="pwc.html#pwc.base.Command._compile"><tt class="xref docutils literal"><span class="pre">pwc.base.Command._compile()</span></tt></a>.</p>
</div>
<div class="section" id="handling-multiple-commands-by-single-one">
<h3>Handling multiple commands by single one<a class="headerlink" href="#handling-multiple-commands-by-single-one" title="Permalink to this headline">¶</a></h3>
<p>Sometimes, you want to handle several commands by single execute method (i.e. command class). For example
it&#8217;s pointless to implement each SQL command as separate command class. In case of SQL, we don&#8217;t even need to
define the <em>full grammar</em>, because SQL commands are terminated, we just need to define the <em>check grammar</em>.</p>
<p>Grammar:</p>
<div class="highlight-python"><pre>Selected SQL commands</pre>
</div>
<p>Definition:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">usesTerminator</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">controller</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="c"># Grammar</span>
    <span class="c"># SQL commands</span>
    <span class="n">keyCommit</span>   <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;commit&#39;</span><span class="p">)</span>
    <span class="n">keyRollback</span> <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;rollback&#39;</span><span class="p">)</span>
    <span class="n">keyAlter</span>    <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;alter&#39;</span><span class="p">)</span>
    <span class="n">keyCreate</span>   <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;create&#39;</span><span class="p">)</span>
    <span class="n">keyDelete</span>   <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;delete&#39;</span><span class="p">)</span>
    <span class="n">keyDrop</span>     <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;drop&#39;</span><span class="p">)</span>
    <span class="n">keyExecute</span>  <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;execute&#39;</span><span class="p">)</span>
    <span class="n">keyGrant</span>    <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;grant&#39;</span><span class="p">)</span>
    <span class="n">keyInsert</span>   <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;insert&#39;</span><span class="p">)</span>
    <span class="n">keyRecreate</span> <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;recreate&#39;</span><span class="p">)</span>
    <span class="n">keyRevoke</span>   <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;revoke&#39;</span><span class="p">)</span>
    <span class="n">keySavepoint</span><span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;savepoint&#39;</span><span class="p">)</span>
    <span class="n">keySelect</span>   <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;select&#39;</span><span class="p">)</span>
    <span class="n">keyUpdate</span>   <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;update&#39;</span><span class="p">)</span>
    <span class="n">keySet</span>      <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;set&#39;</span><span class="p">)</span>

    <span class="c"># Second level keywords</span>
    <span class="n">keyGenerator</span>   <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;generator&#39;</span><span class="p">)</span>
    <span class="n">keyStatistics</span>  <span class="o">=</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;statistics&#39;</span><span class="p">)</span>

    <span class="c"># Composite SQL commands</span>
    <span class="n">cmdSetGen</span>      <span class="o">=</span> <span class="p">(</span><span class="n">keySet</span> <span class="o">+</span> <span class="n">keyGenerator</span><span class="p">)</span>
    <span class="n">cmdSetStat</span>     <span class="o">=</span> <span class="p">(</span><span class="n">keySet</span> <span class="o">+</span> <span class="n">keyStatistics</span><span class="p">)</span>

    <span class="c"># Grammar trick to sink all SQL commands into this class</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keySQL</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeNameNode</span><span class="p">(</span><span class="n">Empty</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">cmdAll</span>  <span class="o">=</span> <span class="p">(</span><span class="n">keySelect</span> <span class="o">^</span> <span class="n">keyCommit</span> <span class="o">^</span> <span class="n">keyRollback</span> <span class="o">^</span> <span class="n">keyAlter</span> <span class="o">^</span> <span class="n">keyCreate</span> <span class="o">^</span>
                    <span class="n">keyDelete</span> <span class="o">^</span> <span class="n">keyDrop</span> <span class="o">^</span> <span class="n">keyExecute</span> <span class="o">^</span> <span class="n">keyGrant</span> <span class="o">^</span> <span class="n">keyInsert</span> <span class="o">^</span>
                    <span class="n">keyRecreate</span> <span class="o">^</span> <span class="n">keyRevoke</span> <span class="o">^</span> <span class="n">keySavepoint</span> <span class="o">^</span> <span class="n">keyUpdate</span> <span class="o">^</span>
                    <span class="n">cmdSetGen</span> <span class="o">^</span> <span class="n">cmdSetStat</span>
        <span class="p">)</span>

    <span class="c"># Multiline SQL command</span>
    <span class="n">SQL</span> <span class="o">=</span> <span class="n">OneOrMore</span><span class="p">(</span><span class="n">CHUNK</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">Optional</span><span class="p">(</span><span class="n">lineEnd</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">replaceWith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">n&#39;</span><span class="p">)))</span> <span class="o">+</span>
                    <span class="n">FollowedBy</span><span class="p">(</span><span class="n">CHUNK</span><span class="p">))</span> <span class="o">^</span>
                    <span class="n">Optional</span><span class="p">(</span><span class="n">lineEnd</span><span class="o">.</span><span class="n">suppress</span><span class="p">())</span>
                    <span class="p">)</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">cmdSQL</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keySQL</span> <span class="o">+</span> \
        <span class="n">Combine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmdAll</span> <span class="o">+</span> <span class="n">SQL</span><span class="p">)</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;sql&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cmdSQL</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_getGrammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdSQL</span>
<span class="k">def</span> <span class="nf">_getCmdKeyword</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keySQL</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdAll</span>

<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sql</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>First, we need to set the class attribute <em>usesTerminator</em> to True, because SQL commands use command terminator.
Next we define the <em>check grammar</em> cmdAll that would recognize all SQL commands we want to handle. The <em>full
grammar</em> would be empty node so the whole command would be passed as &#8216;sql&#8217; parameter to our execute method.
The SQL command would consist from our SQL keywords + rest of the command that may span multiple lines (up to
the terminator sequence) combined into one text node with results name &#8216;sql&#8217;. Note that line ends are preserved
in multiline command. That&#8217;s ok, because the whole command would be quoted as string parameter, and we want to
preserve the line ends in SQL command (for example when we&#8217;ll define stored procedure, it does matter a lot).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We&#8217;re using empty <cite>name node</cite> keySQL in both grammars, because bot must contain the name node.</p>
</div>
</div>
<div class="section" id="complex-commands">
<h3>Complex commands<a class="headerlink" href="#complex-commands" title="Permalink to this headline">¶</a></h3>
<p>Sometimes you want to define command with keyword(s) that may very likely collide with other commands created
by other command developers. In that case, you need to make it unique by introducing <em>domain</em> keyword(s). For
example Firebird QA command pack contains command RUN, that will collide with standard command RUN. So all QA
commands use keyword QA followed by command keyword.</p>
<p>Grammar:</p>
<div class="highlight-python"><pre>QA RUN [FORMAT {FULL | BRIEF | BATCH | STATS | NONE}] [ARCHIVE | test-name]</pre>
</div>
<p>Definition:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">controller</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="c"># Grammar</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keyCmdName</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeNameNode</span><span class="p">(</span><span class="n">Empty</span><span class="p">())</span>
    <span class="n">testName</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span><span class="n">alphanums</span><span class="o">+</span><span class="s">&#39;_-.&#39;</span><span class="p">)</span>
    <span class="c"># QA RUN [FORMAT {FULL | BRIEF | BATCH | STATS | NONE}] [ARCHIVE | test-name]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keyQARun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeNameNode</span><span class="p">(</span><span class="n">Combine</span><span class="p">(</span>
        <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;QA&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">White</span><span class="p">()</span> <span class="o">+</span>
        <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;RUN&#39;</span><span class="p">)))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cmdQARun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyCmdName</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">keyQARun</span> <span class="o">+</span> \
        <span class="n">Optional</span><span class="p">(</span><span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;FORMAT&#39;</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">oneOf</span><span class="p">(</span><span class="s">&#39;FULL BRIEF BATCH STATS NONE&#39;</span><span class="p">,</span><span class="n">caseless</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;format&#39;</span><span class="p">))</span> <span class="o">+</span> \
        <span class="n">Optional</span><span class="p">(</span><span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;ARCHIVE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;archive&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">testName</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">))</span> <span class="o">+</span> \
        <span class="n">Optional</span><span class="p">(</span><span class="n">lineEnd</span><span class="o">.</span><span class="n">suppress</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cmdQARun</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_getGrammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdQARun</span>
<span class="k">def</span> <span class="nf">_getCmdKeyword</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyQARun</span>

<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;brief&#39;</span><span class="p">,</span><span class="n">archive</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">test</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>In this case you&#8217;ll have to work around the &#8220;limitation&#8221; of PyParsing and how translation of command to python
call works. The _compile method requires that there is a token &#8216;cmd&#8217; that contains command name so it could
construct the correct <cite>_XXX_execute</cite> call. This node is also used by execution engine to identify the command
and look it up in command table. Hover, if your grammar node that defines the name is &#8220;structural&#8221; node like
Combine, it doesn&#8217;t show up in parameters list and the routine fails. To work around that, you need to define
two <em>name nodes</em>. The obvious one for your keywords in <em>check grammar</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">keyQARun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeNameNode</span><span class="p">(</span><span class="n">Combine</span><span class="p">(</span><span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;QA&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">White</span><span class="p">()</span> <span class="o">+</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;RUN&#39;</span><span class="p">)))</span>
</pre></div>
</div>
<p>and dummy one that will appear in full grammar:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">keyCmdName</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeNameNode</span><span class="p">(</span><span class="n">Empty</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdQARun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyCmdName</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">keyQARun</span> <span class="o">+</span> \
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="debugging-your-grammar">
<h3>Debugging your Grammar<a class="headerlink" href="#debugging-your-grammar" title="Permalink to this headline">¶</a></h3>
<p>Grammar definition could be tricky and it may happen you would not get it right from the start, especially
when you would use any definition that can potentially match more than expected (some grammar nodes are
&#8220;greedy&#8221; by design, like EXPR or ARG). In that case you would need to debug your grammar. To do so, you&#8217;ll
need to use the <tt class="docutils literal"><span class="pre">ipwc.py</span></tt> CLI console distributed with PowerConsole. You <em>may</em> run it in your preferred
debugger, but it&#8217;s not necessary under normal circumstances.</p>
<p>First and foremost, you may set the debug flag on your grammar by calling <tt class="xref docutils literal"><span class="pre">setDebug()</span></tt> method on nodes
you want to analyze, so you&#8217;d get the debigging printout when these nodes are matched againt the command line.
Typically calling it on nodes returned by <a title="pwc.base.Command._getGrammar" class="reference external" href="pwc.html#pwc.base.Command._getGrammar"><tt class="xref docutils literal"><span class="pre">_getGrammar()</span></tt></a> and
<a title="pwc.base.Command._getCmdKeyword" class="reference external" href="pwc.html#pwc.base.Command._getCmdKeyword"><tt class="xref docutils literal"><span class="pre">_getCmdKeyword()</span></tt></a> is what you would want.</p>
<p>If you&#8217;re using parse actions, you may trace their invocation with <tt class="xref docutils literal"><span class="pre">traceParseAction()</span></tt> decorator function
from <tt class="xref docutils literal"><span class="pre">Pyparsing</span></tt> module.</p>
<p>When your grammar is basically right but you want to test how various alternatives are compiled into Python
function calls, you may run the <tt class="docutils literal"><span class="pre">ipwc.py</span></tt> with <em class="xref">-d</em> or <em class="xref">--debug</em> command line option that
will print out the preprocessed command line before it&#8217;s passed to the Python code compiler, so you could see
the whole function call definition (including actual parameters) before it&#8217;s executed.</p>
</div>
</div>
<div class="section" id="implementing-the-command">
<h2>Implementing the command<a class="headerlink" href="#implementing-the-command" title="Permalink to this headline">¶</a></h2>
<p>Command implementation itself happens in method <a title="pwc.base.Command.execute" class="reference external" href="pwc.html#pwc.base.Command.execute"><tt class="xref docutils literal"><span class="pre">execute()</span></tt></a> of your command class.
However, to simplify command development, PowerConsole uses some convetions that you <em>should</em> follow.
You can alway go your own route, but following these conventions would save you from typing and coding.
There are also some constraints and conditions that your commnd implementation must satisfy to work properly.</p>
<div class="section" id="command-class">
<h3>Command class<a class="headerlink" href="#command-class" title="Permalink to this headline">¶</a></h3>
<p>Your command class must inherit from <a title="pwc.base.Command" class="reference external" href="pwc.html#pwc.base.Command"><tt class="xref docutils literal"><span class="pre">pwc.base.Command</span></tt></a> and define (override) next methods:</p>
<ol class="arabic simple">
<li><a title="pwc.base.Command.__init__" class="reference external" href="pwc.html#pwc.base.Command.__init__"><tt class="xref docutils literal"><span class="pre">__init__()</span></tt></a>.
First and foremost, you must call the inherited one as first action and pass the <cite>controller</cite> to it.
You should define your grammar in this method.</li>
<li><a title="pwc.base.Command._getGrammar" class="reference external" href="pwc.html#pwc.base.Command._getGrammar"><tt class="xref docutils literal"><span class="pre">_getGrammar()</span></tt></a>.
This method must return full grammar definition for your command.</li>
<li><a title="pwc.base.Command._getCmdKeyword" class="reference external" href="pwc.html#pwc.base.Command._getCmdKeyword"><tt class="xref docutils literal"><span class="pre">_getCmdKeyword()</span></tt></a>.
This method must return a grammar that would uniquely identify your command on the command line.</li>
<li><a title="pwc.base.Command.execute" class="reference external" href="pwc.html#pwc.base.Command.execute"><tt class="xref docutils literal"><span class="pre">execute()</span></tt></a>.
This method is called to perform your command.</li>
</ol>
<p>The <a title="pwc.base.Command" class="reference external" href="pwc.html#pwc.base.Command"><tt class="xref docutils literal"><span class="pre">pwc.base.Command</span></tt></a> class defines some useful attributes and methods. Namely:</p>
<ol class="arabic simple">
<li>Commonly used grammar elements like IDENT, FILENAME, EXPR, ARG, INTEGER etc.</li>
<li>Required or commonly used parse actions.</li>
<li>Attributes to access the execution engine (controller) and various command parameters (name, terminator use)</li>
<li>Methods to get local and context namespaces and to write to controllers standard and error output.</li>
</ol>
<p>You may also implement the <tt class="xref docutils literal"><span class="pre">getHelp()</span></tt> method that must return the help text for the command shown by
builtin <a class="reference external" href="stdcmd.html#help"><em>Help</em></a> command.</p>
</div>
<div class="section" id="command-name">
<h3>Command name<a class="headerlink" href="#command-name" title="Permalink to this headline">¶</a></h3>
<p>All commands have a name that&#8217;s used internally to look up the command class in command dictionary.</p>
<ol class="arabic simple">
<li>This name must be unique. If you expect that your command name may collide with commands from other
developers, use domain or vendor-specific prefix in your command name.</li>
<li>The name must be built into your grammar. You can use any type of PyParsing node for it except those that
define parameter values for your command (i.e. any keyword, structural or even empty node). This node must
have name &#8216;cmd&#8217;, and the command name must be defined as results name and node value itself (you can do that
by using <tt class="xref docutils literal"><span class="pre">pyparsing.replaceWith()</span></tt> parse action). Command class has a method
<a title="pwc.base.Command._makeNameNode" class="reference external" href="pwc.html#pwc.base.Command._makeNameNode"><tt class="xref docutils literal"><span class="pre">_makeNameNode()</span></tt></a> to make any grammar node to <em>name</em> node.</li>
</ol>
<p>The command name is internally stored in <tt class="xref docutils literal"><span class="pre">_name</span></tt> attribute of your command class.
The inherited <a title="pwc.base.Command.__init__" class="reference external" href="pwc.html#pwc.base.Command.__init__"><tt class="xref docutils literal"><span class="pre">__init__()</span></tt></a> method initializes it to your class name (lowercased) with
&#8216;cmd&#8217; prefix (if any) removed. You can change it to other value in your <cite>__init__</cite> method after that.</p>
<p>The command name is also shown by builtin <a class="reference external" href="stdcmd.html#help"><em>Help</em></a> command in list of available commands (if your command
is documented directly by command class), so your command name should match the keyword(s) used to invoke it.</p>
</div>
<div class="section" id="accessing-user-objects">
<h3>Accessing user objects<a class="headerlink" href="#accessing-user-objects" title="Permalink to this headline">¶</a></h3>
<p>Your command is executed as normal Python function in PowerConsole&#8217;s sandbox. Your may need to access objects
defined in the sandbox namespace or execution context (for example when your command is executed from other
function defined by user). The Command class has two useful methods for this purpose:</p>
<blockquote>
<dl class="docutils">
<dt><a title="pwc.base.Command._getUserNamespace" class="reference external" href="pwc.html#pwc.base.Command._getUserNamespace"><tt class="xref docutils literal"><span class="pre">_getUserNamespace()</span></tt></a></dt>
<dd>Returns dictionary with user objects (sandbox globals).</dd>
<dt><a title="pwc.base.Command._getContextLocals" class="reference external" href="pwc.html#pwc.base.Command._getContextLocals"><tt class="xref docutils literal"><span class="pre">_getContextLocals()</span></tt></a></dt>
<dd>Returns dictionary with local objects in execution context of your command or from specified frame context.
To access caller&#8217;s locals (from user context) directly from your <a title="pwc.base.Command.execute" class="reference external" href="pwc.html#pwc.base.Command.execute"><tt class="xref docutils literal"><span class="pre">execute()</span></tt></a> method
just call this method without parameter. However, if you&#8217;ll call this function from inner calls (for
example from method called by your execute method), you have to specify the parameter value. The parameter
specifies the number of frames to skip (i.e. level of nesting from <cite>execute</cite> to this function call).</dd>
</dl>
</blockquote>
</div>
<div class="section" id="command-output">
<h3>Command output<a class="headerlink" href="#command-output" title="Permalink to this headline">¶</a></h3>
<p>For regular output, your command must use the <a class="reference external" href="concept.html#display-abstraction"><em>display abstraction</em></a>. For error and
system reporting you may use methods <a title="pwc.interpreter.Interpreter.write" class="reference external" href="pwc.html#pwc.interpreter.Interpreter.write"><tt class="xref docutils literal"><span class="pre">write()</span></tt></a> and
<a title="pwc.interpreter.Interpreter.writeErr" class="reference external" href="pwc.html#pwc.interpreter.Interpreter.writeErr"><tt class="xref docutils literal"><span class="pre">writeErr()</span></tt></a> inherited from Command class.</p>
<p>To obtain a display for your output, call the appropriate method on <tt class="xref docutils literal"><span class="pre">self.controler.ui_provider</span></tt>. It&#8217;s
also a good practice to define the <em>purpose</em> string for your output. You should also document the display
interfaces and purpose names your command(s) use, so tool developers could adapt their tools to allow
customizations or specific handling to your output for end users.</p>
</div>
<div class="section" id="documentation-for-your-command">
<h3>Documentation for your command<a class="headerlink" href="#documentation-for-your-command" title="Permalink to this headline">¶</a></h3>
<p>PowerConsole supports builtin <a class="reference external" href="stdcmd.html#help"><em>Help</em></a> system that uses docstrings and special <a title="pwc.base.HelpProvider" class="reference external" href="pwc.html#pwc.base.HelpProvider"><tt class="xref docutils literal"><span class="pre">HelpProvider</span></tt></a> objects
to print documentation for your commands and other topics you want to offer to users directly from the
PowerConsole. If you want to list your command directly in list of supported commands, you must either write
a docstring for <tt class="xref docutils literal"><span class="pre">execute()</span></tt> method implementing your command or define <tt class="xref docutils literal"><span class="pre">getHelp()</span></tt> method in your
command class. Otherwise your command will not be listed. So if you don&#8217;t want to list your command (for example
because you&#8217;ll document it via special topic handled by Help Provider), don&#8217;t create the docstring for
the execute method.</p>
</div>
<div class="section" id="installing-command-to-powerconsole">
<h3>Installing command to PowerConsole<a class="headerlink" href="#installing-command-to-powerconsole" title="Permalink to this headline">¶</a></h3>
<p>To install command to the PowerConsole you must define each class as <cite>powerconsole.commands</cite> entry point
in your <tt class="docutils literal"><span class="pre">setup.py</span></tt>:</p>
<div class="highlight-python"><pre>from setuptools import setup, find_packages

setup(
    ...
    entry_points = {
        'powerconsole.commands': [
            '&lt;cmd-name&gt; = pwc.&lt;your-module&gt;:&lt;cmd-class&gt;',
            ...
         ],
    }
    ...
)</pre>
</div>
</div>
</div>
<div class="section" id="help-providers">
<h2>Help Providers<a class="headerlink" href="#help-providers" title="Permalink to this headline">¶</a></h2>
<p><a title="pwc.base.HelpProvider" class="reference external" href="pwc.html#pwc.base.HelpProvider"><tt class="xref docutils literal"><span class="pre">HelpProvider</span></tt></a> is special object used by builtin <a class="reference external" href="stdcmd.html#help"><em>Help</em></a> command to display information for any topic
or command you want to present to the PowerConsole users.</p>
<p>The simples way to install topics to the help system via Help Provider is to define your own class inherited
from <a title="pwc.base.HelpProvider" class="reference external" href="pwc.html#pwc.base.HelpProvider"><tt class="xref docutils literal"><span class="pre">HelpProvider</span></tt></a> with string attributes or methods with names staring with <a title="pwc.base.HELP_PREFIX" class="reference external" href="pwc.html#pwc.base.HELP_PREFIX"><tt class="xref docutils literal"><span class="pre">HELP_PREFIX</span></tt></a> followed
by name of the topic. While string attributes contain directly the help text for the topic, methods may simply
return the help text or handle the help output by itself (for example Python Help Provider enters the Python
builtin help system).</p>
<p>Simple Help Povider example:</p>
<div class="highlight-python"><pre>class helpMyProvider(HelpProvider):
"""Help Provider for my PowerConsole commands and other topics"""

    help_mylicense = """License text...
    """
    help_sql = """Help for SQL support in my package.
    """

    def help_mycomands(self):
        ...
        return help_text

Installed topics: mylicense, sql, mycommands</pre>
</div>
<p>If you want to create HelpProvider object with special handling, you have to implement (override) methods
<a title="pwc.base.HelpProvider.canHandle" class="reference external" href="pwc.html#pwc.base.HelpProvider.canHandle"><tt class="xref docutils literal"><span class="pre">canHandle()</span></tt></a>, <a title="pwc.base.HelpProvider.getTopics" class="reference external" href="pwc.html#pwc.base.HelpProvider.getTopics"><tt class="xref docutils literal"><span class="pre">getTopics()</span></tt></a> and <a title="pwc.base.HelpProvider.getHelp" class="reference external" href="pwc.html#pwc.base.HelpProvider.getHelp"><tt class="xref docutils literal"><span class="pre">getHelp()</span></tt></a>.</p>
<p>Next Help Provider implements access to builtin Python help system:</p>
<div class="highlight-python"><pre>class helpPython(HelpProvider):
    """Help Provider that provides access to standard Python help system."""

    def canHandle(self,topic):
        """Return True if 'topic' starts with 'python'."""
        return topic.startswith('python')

    def getTopics(self):
        """Return list of topics handled by provider."""
       return ['python']

    def getHelp(self, topic):
       """Return python help for 'topic'."""

        topic = topic[6:].strip()
        if topic != '':
            self._help(topic)
        else:
            self._help()</pre>
</div>
<p>Like commands, Help Providers must be registered as entry points in your <tt class="docutils literal"><span class="pre">setup.py</span></tt>:</p>
<div class="highlight-python"><pre>from setuptools import setup, find_packages

setup(
    ...
    entry_points = {
        'powerconsole.help_providers': [
            '&lt;provider-name&gt; = pwc.&lt;your-module&gt;:&lt;provider-class&gt;',
            ...
         ],
    }
    ...
)</pre>
</div>
</div>
<div class="section" id="object-renderers">
<h2>Object Renderers<a class="headerlink" href="#object-renderers" title="Permalink to this headline">¶</a></h2>
<p>Some commands (yours or those created by other developers) may use <a class="reference external" href="concept.html#display-abstraction"><em>Object Display interface</em></a> to display objects to PowerConsole users. By default this interface displays string
representation of the object (via str(&lt;object&gt;)), but PowerConsole supports more rich object rendering through
user defined Object Renderers.</p>
<p>Object Renderer is an ordinary new-style class that can extend the <cite>Visitor Pattern</cite> used by PowerConsole or
know how to handle object(s) of certain type(s).</p>
<p>The renderer must have the <a title="(in Python v2.6)" class="reference external" href="http://docs.python.org/reference/datamodel.html#object.__init__"><tt class="xref docutils literal"><span class="pre">__init__()</span></tt></a> method that accepts at least one parameter: the display where
the output should be rendered.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Single renderer class can provide special printout for multiple object types.</p>
</div>
<div class="section" id="using-the-visitor-pattern">
<h3>Using the Visitor Pattern<a class="headerlink" href="#using-the-visitor-pattern" title="Permalink to this headline">¶</a></h3>
<p>If your command or other package implements objects that are accessible to console users, you may adopt the
visitor pattern for them. Using the pattern would allow your or other to handle your object in specific way
generally, not only special output, so it should be preferred over special visualisation by objct type.</p>
<p>To add Visitor pattern to your object, simply add next method to it:</p>
<div class="highlight-python"><pre>def acceptVisitor(self,visitor):
    visitor.visit&lt;class-name&gt;(self)</pre>
</div>
<p>The calling visitor must know how to handle your object, i.e. must have the corresponding
<tt class="xref docutils literal"><span class="pre">visit{class-name}()</span></tt> method or know how to handle it in generic way, but it shouldn&#8217;t be the concern
of your object. The Object Display used by PowerConsole will always know how to handle it. However, it doesn&#8217;t
know how to handle it in specific way (does not have the <tt class="xref docutils literal"><span class="pre">visit{class-name}()</span></tt> method), unless you or
someone else will not provide the renderer that implements it.</p>
<p>That&#8217;s it, your renderer class must implement the <tt class="xref docutils literal"><span class="pre">visit{class-name}()</span></tt> method on behalf of the display,
and use the display&#8217;s interface(s) to write it out.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Your renderer class should always check wheter particular interface is implemented by display before using it!</p>
</div>
</div>
<div class="section" id="handling-objects-by-type">
<h3>Handling objects by type<a class="headerlink" href="#handling-objects-by-type" title="Permalink to this headline">¶</a></h3>
<p>If you want to provide special printout of objects that doesn&#8217;t and can&#8217;t support the Visitor Pattern, you can
create a renderer that handle object by the type. To do so, simply add next method to it:</p>
<div class="highlight-python"><pre>def handle_&lt;type-name&gt;(self,obj):
    ...</pre>
</div>
<p>This method will be called by display for objects that are <strong>exactly</strong> of specified type (i.e. not for
descendants or type-like objects that conform to the interface of specified type).</p>
<p>Here is the example renderer for list and dictionary objects that prettyprints them:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>

<span class="k">class</span> <span class="nc">renderListDict</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">display</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="n">display</span>
    <span class="k">def</span> <span class="nf">handle_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">writeLine</span><span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">handle_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">writeLine</span><span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="registering-your-renderer">
<h3>Registering your renderer<a class="headerlink" href="#registering-your-renderer" title="Permalink to this headline">¶</a></h3>
<p>Like commands or help providers, your object renderer must be registered in your <tt class="docutils literal"><span class="pre">setup.py</span></tt> as
&#8216;powerconsole.text_renderers&#8217; entry point:</p>
<div class="highlight-python"><pre>from setuptools import setup, find_packages

setup(
    ...
    entry_points = {
        'powerconsole.text_renderers': [
            '&lt;renderer-name&gt; = pwc.&lt;your-module&gt;:&lt;renderer-class&gt;',
            ...
         ],
    }
    ...
)</pre>
</div>
</div>
</div>
<div class="section" id="controller-extenders">
<h2>Controller Extenders<a class="headerlink" href="#controller-extenders" title="Permalink to this headline">¶</a></h2>
<p>Controller extender is a convenient way how to perform any action during PowerConsole initialization. For example
when you want to add objects to user execution namespace, install attributes for shared use to the controller
itself (all commands have access to it, so you can use it as common storage for data shared among commands) etc.</p>
<p>Extender is an ordinary new-style class that has the <a title="(in Python v2.6)" class="reference external" href="http://docs.python.org/reference/datamodel.html#object.__init__"><tt class="xref docutils literal"><span class="pre">__init__()</span></tt></a> method or ordinary function that accepts
at least one parameter: the <a title="pwc.interpreter.Interpreter" class="reference external" href="pwc.html#pwc.interpreter.Interpreter"><tt class="xref docutils literal"><span class="pre">Interpreter</span></tt></a> instance.</p>
<p>Like commands or help providers, your controller extender must be registered in your <tt class="docutils literal"><span class="pre">setup.py</span></tt> as
&#8216;controller_extensions&#8217; entry point:</p>
<div class="highlight-python"><pre>from setuptools import setup, find_packages

setup(
    ...
    entry_points = {
        'controller_extensions': [
            '&lt;extender-name&gt; = pwc.&lt;your-module&gt;:&lt;extender-class-or-function&gt;',
            ...
         ],
    }
    ...
)</pre>
</div>
</div>
<div class="section" id="extending-the-show-command">
<h2>Extending the SHOW command<a class="headerlink" href="#extending-the-show-command" title="Permalink to this headline">¶</a></h2>
<p>PowerConsole comes with one extensible command: SHOW (which you can use as example how to implement your own
extensible commands). The purpose of this command is to provide a convenient way how to print out various
information. Core grammar definition supports only expressions that are evaluated and rendered on display
as lines of text (for strings) or objects. You can write your own classes that extend the grammar to display
any information you want. For example database package may define extension to support topics &#8216;database&#8217; and
&#8216;tables&#8217; to display information about connected database and available tables (via SHOW DATABASE and SHOW TABLES
commands).</p>
<p>Extenstions to SHOW command are created like normal commands, with few specifics:</p>
<ol class="arabic simple">
<li>Your class descends from <a title="pwc.stdcmd.ShowExtender" class="reference external" href="pwc.html#pwc.stdcmd.ShowExtender"><tt class="xref docutils literal"><span class="pre">pwc.stdcmd.ShowExtender</span></tt></a> class instead <a title="pwc.base.Command" class="reference external" href="pwc.html#pwc.base.Command"><tt class="xref docutils literal"><span class="pre">pwc.base.Command</span></tt></a>.</li>
<li>The <a title="pwc.base.Command.execute" class="reference external" href="pwc.html#pwc.base.Command.execute"><tt class="xref docutils literal"><span class="pre">execute()</span></tt></a> method may handle the output directly or simply can return
the string(s) or object(s) to be displayed.</li>
<li>It&#8217;s registered as &#8216;powerconsole.show_extensions&#8217; entry point instead &#8216;powerconsole.commands&#8217;.</li>
</ol>
<p>Here is the example extension that can show information about database procedures:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">showTest</span><span class="p">(</span><span class="n">ShowExtender</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">controller</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">showTest</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
        <span class="n">DBIDENT</span>      <span class="o">=</span> <span class="p">(</span><span class="n">Word</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span><span class="n">alphanums</span><span class="o">+</span><span class="s">&#39;_$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">upcaseTokens</span><span class="p">)</span> <span class="o">|</span>
                        <span class="n">QuotedString</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="n">escQuote</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="n">unquoteResults</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s">&#39;dbident&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyProcedure</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeNameNode</span><span class="p">(</span><span class="n">Empty</span><span class="p">())</span> <span class="o">+</span> \
            <span class="p">(</span><span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;procedure&#39;</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">CaselessKeyword</span><span class="p">(</span><span class="s">&#39;procedures&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">upcaseTokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmdShow</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyProcedure</span> <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">DBIDENT</span><span class="o">.</span><span class="n">setResultsName</span><span class="p">(</span><span class="s">&#39;objname&#39;</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_getGrammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdShow</span>
    <span class="k">def</span> <span class="nf">_getCmdKeyword</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyProcedure</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;PROCEDURES | PROCEDURE &lt;name&gt;</span>
<span class="sd">    Shows list of procedures or detail about procedure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;Text to show...&#39;</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="">How to implement new commands</a><ul>
<li><a class="reference external" href="#process-overview">Process Overview</a></li>
<li><a class="reference external" href="#grammar-definition">Grammar definition</a><ul>
<li><a class="reference external" href="#simple-command-with-parameters">Simple command with parameters</a></li>
<li><a class="reference external" href="#simple-command-with-many-parameters">Simple command with many parameters</a></li>
<li><a class="reference external" href="#handling-multiple-commands-by-single-one">Handling multiple commands by single one</a></li>
<li><a class="reference external" href="#complex-commands">Complex commands</a></li>
<li><a class="reference external" href="#debugging-your-grammar">Debugging your Grammar</a></li>
</ul>
</li>
<li><a class="reference external" href="#implementing-the-command">Implementing the command</a><ul>
<li><a class="reference external" href="#command-class">Command class</a></li>
<li><a class="reference external" href="#command-name">Command name</a></li>
<li><a class="reference external" href="#accessing-user-objects">Accessing user objects</a></li>
<li><a class="reference external" href="#command-output">Command output</a></li>
<li><a class="reference external" href="#documentation-for-your-command">Documentation for your command</a></li>
<li><a class="reference external" href="#installing-command-to-powerconsole">Installing command to PowerConsole</a></li>
</ul>
</li>
<li><a class="reference external" href="#help-providers">Help Providers</a></li>
<li><a class="reference external" href="#object-renderers">Object Renderers</a><ul>
<li><a class="reference external" href="#using-the-visitor-pattern">Using the Visitor Pattern</a></li>
<li><a class="reference external" href="#handling-objects-by-type">Handling objects by type</a></li>
<li><a class="reference external" href="#registering-your-renderer">Registering your renderer</a></li>
</ul>
</li>
<li><a class="reference external" href="#controller-extenders">Controller Extenders</a></li>
<li><a class="reference external" href="#extending-the-show-command">Extending the SHOW command</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="stdcmd.html"
                                  title="previous chapter">Standard Commands</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="pwc.html"
                                  title="next chapter">PowerConsole Core modules and classes</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/new-commands.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="modindex.html" title="Global Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="pwc.html" title="PowerConsole Core modules and classes"
             >next</a> |</li>
        <li class="right" >
          <a href="stdcmd.html" title="Standard Commands"
             >previous</a> |</li>
        <li><a href="index.html">PowerConsole v0.7 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, Pavel Cisar.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.1.
    </div>
  </body>
</html>